<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiring Coding Test - TESTIFY</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-darker.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .CodeMirror { height: 100%; border-radius: 0 0 0.5rem 0.5rem; font-size: 14px; }
        .CodeMirror-placeholder { color: #888 !important; }
        .palette-btn { transition: all 0.2s; }
        .palette-btn.active { background-color: #4F46E5; color: white; border-color: #4F46E5; }
        .palette-btn.solved { background-color: #10B981; color: white; border-color: #059669; }
        .palette-btn.attempted { border-color: #F59E0B; color: #F59E0B; }
        .modal-overlay { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .test-case-tab { transition: all 0.2s; }
        .test-case-tab.active { border-color: #4F46E5; color: #4F46E5; background-color: #EEF2FF; }
        .prose pre { white-space: pre-wrap; word-wrap: break-word; }
        #fullscreen-container:fullscreen { background-color: #f3f4f6; padding: 0; overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Main container -->
    <div id="main-container" class="min-h-screen flex items-center justify-center p-4">
        <div id="loader" class="text-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-xl font-semibold text-gray-700">Validating Test Link...</p>
        </div>
        <div id="error-message" class="hidden text-center bg-white p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold text-red-600">Access Denied</h2>
            <p class="text-gray-600 mt-2"></p>
        </div>
        <div id="details-form-container" class="hidden bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Candidate Verification</h2>
            <form id="candidate-details-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label for="student-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="roll-number" class="block text-sm font-medium text-gray-700">Roll Number</label>
                            <input type="text" id="roll-number" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="college-select" class="block text-sm font-medium text-gray-700">College Name</label>
                            <select id="college-select" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Loading colleges...</option>
                            </select>
                        </div>
                        <div>
                            <label for="department" class="block text-sm font-medium text-gray-700">Department</label>
                            <input type="text" id="department" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-gray-700">Live Photo Capture</label>
                        <div class="bg-gray-200 rounded-md overflow-hidden aspect-video relative">
                            <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline muted></video>
                            <img id="captured-photo" class="absolute top-0 left-0 w-full h-full object-cover hidden">
                        </div>
                        <canvas id="capture-canvas" class="hidden"></canvas>
                        <div id="capture-buttons" class="flex space-x-2">
                             <button type="button" id="capture-btn" class="w-full px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100">Capture Photo</button>
                             <button type="button" id="recapture-btn" class="hidden w-full px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100">Recapture</button>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button type="submit" id="start-test-btn" class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 disabled:bg-gray-400">
                        <span id="start-btn-text">Submit Details & Start Test</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Environment -->
    <div id="fullscreen-container">
        <div id="test-environment" class="hidden h-screen w-screen flex flex-col bg-gray-100">
            <header class="flex items-center justify-between h-16 bg-white border-b px-4 shadow-md flex-shrink-0 z-10">
                <h1 id="test-title" class="text-xl font-bold text-gray-800">Coding Test</h1>
                <div class="flex items-center space-x-4">
                    <div class="text-lg font-semibold text-red-600">Time Left: <span id="timer">00:00</span></div>
                    <button id="submit-test-btn" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Submit Test</button>
                </div>
            </header>
            <div class="flex flex-1 overflow-hidden p-4 gap-4">
                <aside class="w-1/3 bg-white p-4 overflow-y-auto border rounded-lg shadow-sm flex flex-col">
                    <div class="border-b pb-4 mb-4">
                         <h2 class="text-lg font-bold text-gray-800 mb-3">Problems</h2>
                         <div class="flex justify-between text-sm font-medium text-gray-600">
                            <span>Solved: <span id="solved-count" class="font-bold text-green-600">0</span></span>
                            <span>Attempted: <span id="attempted-count" class="font-bold text-yellow-600">0</span></span>
                            <span>Pending: <span id="pending-count" class="font-bold text-gray-800">0</span></span>
                         </div>
                    </div>
                    <div id="problem-palette" class="flex flex-wrap gap-2 mb-4"></div>
                    <div id="problem-details" class="prose max-w-none flex-grow"></div>
                </aside>
                <main class="w-2/3 flex flex-col gap-4">
                    <div class="flex-grow flex flex-col bg-gray-800 rounded-lg shadow-sm overflow-hidden">
                        <div class="p-2 bg-gray-700 border-b border-gray-600 flex justify-between items-center flex-shrink-0">
                            <select id="language-select" class="p-2 border border-gray-500 rounded-md bg-gray-800 text-white text-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                            <button id="run-code-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md text-sm hover:bg-green-700 disabled:bg-gray-500">
                                <span id="run-code-btn-text">Run & Evaluate</span>
                            </button>
                        </div>
                        <div class="flex-grow relative"><textarea id="code-editor"></textarea></div>
                    </div>
                    <div class="h-2/5 bg-gray-800 text-white p-2 flex flex-col rounded-lg shadow-sm">
                        <div id="results-view" class="flex-grow hidden flex-col">
                            <div id="test-case-tabs" class="flex border-b border-gray-600 mb-2 flex-shrink-0"></div>
                            <div id="test-case-details" class="flex-grow overflow-y-auto"></div>
                        </div>
                        <pre id="output-console" class="flex-grow overflow-y-auto text-sm font-mono p-2">
                             <div id="output-placeholder" class="flex items-center justify-center h-full text-gray-500">Output will appear here...</div>
                        </pre>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <p id="modal-message" class="text-lg font-semibold text-gray-700"></p>
            <div id="modal-buttons" class="mt-6 flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/placeholder/placeholder.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CHANGE: Define a base URL for all API calls ---
            // This makes the code work on both localhost and production without changes.
            const API_BASE_URL = `${window.location.protocol}//${window.location.host}`;

            const token = new URLSearchParams(window.location.search).get('token');
            const mainContainer = document.getElementById('main-container');
            const fullscreenContainer = document.getElementById('fullscreen-container');
            const testEnvironment = document.getElementById('test-environment');
            const loader = document.getElementById('loader');
            const errorMessageDiv = document.getElementById('error-message');
            const detailsFormContainer = document.getElementById('details-form-container');

            let currentTest = null;
            let currentProblemIndex = 0;
            let problemSubmissions = {};
            let problemStatuses = [];
            let timerInterval;
            let isSubmitting = false;
            let candidateDetails = {};
            let capturedImageData = null;
            let cameraStream = null;

            const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                lineNumbers: true, mode: 'text/x-csrc', theme: 'material-darker', placeholder: 'Type your code here...'
            });

            if (!token) {
                showError('No test token provided. This link is invalid.');
                return;
            }

            function showError(message) {
                loader.style.display = 'none';
                detailsFormContainer.style.display = 'none';
                errorMessageDiv.style.display = 'block';
                errorMessageDiv.querySelector('p').textContent = message;
            }

            async function fetchTestDetails() {
                try {
                    // --- CHANGE: Use absolute URL ---
                    const response = await fetch(`${API_BASE_URL}/api/public/test-details`, { headers: { 'x-auth-token': token } });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    currentTest = data;
                    problemStatuses = new Array(currentTest.problems.length).fill('pending');
                    loader.style.display = 'none';
                    detailsFormContainer.style.display = 'block';
                    initializeDetailsForm();
                } catch (error) {
                    showError(error.message);
                }
            }

            async function initializeDetailsForm() {
                const collegeSelect = document.getElementById('college-select');
                try {
                    // --- CHANGE: Use absolute URL ---
                    const response = await fetch(`${API_BASE_URL}/api/public/colleges/${currentTest.testId}`);
                    const colleges = await response.json();
                    collegeSelect.innerHTML = '<option value="">Select your college</option>';
                    colleges.forEach(college => {
                        const option = document.createElement('option');
                        option.value = college.collegeName;
                        option.textContent = college.collegeName;
                        collegeSelect.appendChild(option);
                    });
                } catch (e) {
                    collegeSelect.innerHTML = '<option value="">Could not load colleges</option>';
                }
                startCamera();
            }
            
            async function startCamera() {
                try {
                    if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    document.getElementById('camera-feed').srcObject = cameraStream;
                    document.getElementById('camera-feed').classList.remove('hidden');
                    document.getElementById('captured-photo').classList.add('hidden');
                } catch (e) {
                    alert('Camera access is required. Please allow camera access and refresh.');
                }
            }
            
            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
            }

            document.getElementById('capture-btn').addEventListener('click', () => {
                const video = document.getElementById('camera-feed');
                const canvas = document.getElementById('capture-canvas');
                const photo = document.getElementById('captured-photo');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                capturedImageData = canvas.toDataURL('image/jpeg');
                photo.src = capturedImageData;
                video.classList.add('hidden');
                photo.classList.remove('hidden');
                document.getElementById('capture-btn').classList.add('hidden');
                document.getElementById('recapture-btn').classList.remove('hidden');
                stopCamera();
            });

            document.getElementById('recapture-btn').addEventListener('click', () => {
                capturedImageData = null;
                startCamera();
                document.getElementById('capture-btn').classList.remove('hidden');
                document.getElementById('recapture-btn').classList.add('hidden');
            });

            document.getElementById('candidate-details-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!capturedImageData) return alert('Please capture your photo.');
                
                const startBtn = document.getElementById('start-test-btn');
                startBtn.disabled = true;
                startBtn.querySelector('span').textContent = 'Uploading Photo...';
                
                try {
                    // --- CHANGE: Use absolute URL ---
                    const uploadResponse = await fetch(`${API_BASE_URL}/api/public/upload-image`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ imageData: capturedImageData })
                    });
                    const uploadResult = await uploadResponse.json();
                    if (!uploadResponse.ok) throw new Error(uploadResult.message);

                    candidateDetails = {
                        fullName: document.getElementById('student-name').value,
                        rollNumber: document.getElementById('roll-number').value,
                        collegeName: document.getElementById('college-select').value,
                        department: document.getElementById('department').value,
                        profileImageUrl: uploadResult.imageUrl
                    };
                    
                    mainContainer.style.display = 'none';
                    testEnvironment.style.display = 'flex';
                    fullscreenContainer.requestFullscreen().catch(console.error);
                    startTest();

                } catch (error) {
                    alert(`Error: ${error.message}`);
                    startBtn.disabled = false;
                    startBtn.querySelector('span').textContent = 'Submit Details & Start Test';
                }
            });

            function startTest() {
                document.getElementById('test-title').textContent = currentTest.title;
                startTimer(currentTest.duration * 60);
                updatePalette();
                selectProblem(0);
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement && !isSubmitting) forceSubmitTest('Exited Full-Screen Mode');
                });
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitting) forceSubmitTest('Switched to another tab');
                });
            }
            
            function updatePalette() {
                const palette = document.getElementById('problem-palette');
                const solvedCount = problemStatuses.filter(s => s === 'solved').length;
                const attemptedCount = problemStatuses.filter(s => s === 'attempted').length;
                document.getElementById('solved-count').textContent = solvedCount;
                document.getElementById('attempted-count').textContent = attemptedCount;
                document.getElementById('pending-count').textContent = currentTest.problems.length - solvedCount - attemptedCount;

                palette.innerHTML = currentTest.problems.map((p, i) => {
                    let statusClass = '';
                    if (problemStatuses[i] === 'solved') statusClass = 'solved';
                    else if (problemStatuses[i] === 'attempted') statusClass = 'attempted';
                    return `<button class="palette-btn px-3 py-1 border-2 rounded-md ${statusClass}" data-index="${i}">Problem ${i + 1}</button>`;
                }).join('');

                palette.querySelectorAll('.palette-btn').forEach(btn => {
                    btn.addEventListener('click', () => selectProblem(parseInt(btn.dataset.index)));
                });
            }

            function selectProblem(index) {
                const previousProblem = currentTest.problems[currentProblemIndex];
                if (previousProblem) {
                    const code = editor.getValue();
                    problemSubmissions[previousProblem.id] = { code, language: document.getElementById('language-select').value };
                    if (code.trim() !== '' && problemStatuses[currentProblemIndex] === 'pending') {
                        problemStatuses[currentProblemIndex] = 'attempted';
                    }
                }

                currentProblemIndex = index;
                const problem = currentTest.problems[index];
                
                const consoleEl = document.getElementById('output-console');
                const placeholder = document.getElementById('output-placeholder');
                consoleEl.style.display = 'block';
                consoleEl.innerHTML = '';
                if(placeholder) {
                    placeholder.style.display = 'flex';
                    consoleEl.appendChild(placeholder);
                }
                document.getElementById('results-view').style.display = 'none';
                
                document.getElementById('problem-details').innerHTML = `
                    <h2 class="text-2xl font-bold mb-2">${problem.title}</h2>
                    <p class="text-sm font-semibold text-gray-500 mb-4">${problem.difficulty} - ${problem.score} points</p>
                    <h3>Description</h3><p>${problem.description.replace(/\n/g, '<br>')}</p>
                    <h3>Example</h3><pre class="bg-gray-100 p-2 rounded text-sm font-mono">${problem.example || 'No example.'}</pre>
                `;
                
                const savedSubmission = problemSubmissions[problem.id];
                editor.setValue(savedSubmission ? savedSubmission.code : '');
                if(savedSubmission) document.getElementById('language-select').value = savedSubmission.language;
                document.getElementById('language-select').dispatchEvent(new Event('change'));

                updatePalette();
                document.querySelector(`.palette-btn[data-index='${index}']`).classList.add('active');
                setTimeout(() => editor.refresh(), 1);
            }
            
            document.getElementById('language-select').innerHTML = `<option value="c">C</option><option value="cpp">C++</option><option value="java">Java</option><option value="python">Python</option>`;
            document.getElementById('language-select').addEventListener('change', (e) => {
                const modes = { 'python': 'python', 'java': 'text/x-java', 'c': 'text/x-csrc', 'cpp': 'text/x-c++src' };
                editor.setOption('mode', modes[e.target.value]);
            });

            document.getElementById('run-code-btn').addEventListener('click', async () => {
                const problem = currentTest.problems[currentProblemIndex];
                const runBtn = document.getElementById('run-code-btn');
                runBtn.disabled = true;
                runBtn.querySelector('span').textContent = 'Evaluating...';
                document.getElementById('output-console').style.display = 'none';
                document.getElementById('results-view').style.display = 'flex';

                const results = [];
                for (const tc of problem.testCases) {
                    try {
                        // --- CHANGE: Use absolute URL ---
                        const response = await fetch(`${API_BASE_URL}/api/compile`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                            body: JSON.stringify({ language: document.getElementById('language-select').value, code: editor.getValue(), input: tc.input })
                        });
                        const data = await response.json();
                        const actual = (data.output || '').trim().replace(/\s+/g, ' ');
                        const expected = (tc.expected || '').trim().replace(/\s+/g, ' ');
                        results.push({ actual, status: actual === expected ? 'Accepted' : 'Wrong Answer' });
                    } catch (e) {
                        results.push({ actual: 'Execution Error', status: 'Error' });
                        break; 
                    }
                }
                
                if (results.every(r => r.status === 'Accepted')) {
                    problemStatuses[currentProblemIndex] = 'solved';
                } else if(editor.getValue().trim() !== '') {
                    problemStatuses[currentProblemIndex] = 'attempted';
                }
                updatePalette();
                renderTestResults(results, problem.testCases);
                runBtn.disabled = false;
                runBtn.querySelector('span').textContent = 'Run & Evaluate';
            });
            
            function renderTestResults(results, testCases) {
                const tabsContainer = document.getElementById('test-case-tabs');
                tabsContainer.innerHTML = results.map((r, i) => {
                    const isAccepted = r.status === 'Accepted';
                    return `<button class="test-case-tab px-4 py-2 border-b-2 font-medium text-sm ${isAccepted ? 'text-green-400 border-transparent hover:border-green-400' : 'text-red-400 border-transparent hover:border-red-400'}" data-index="${i}">Case ${i + 1}</button>`;
                }).join('');

                tabsContainer.querySelectorAll('.test-case-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        tabsContainer.querySelectorAll('.test-case-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        renderTestCaseDetail(index, results[index], testCases);
                    });
                });
                
                if (results.length > 0) {
                    const firstFailedIndex = results.findIndex(r => r.status !== 'Accepted');
                    const activeIndex = firstFailedIndex !== -1 ? firstFailedIndex : 0;
                    if(tabsContainer.children[activeIndex]) tabsContainer.children[activeIndex].click();
                }
            }
            
            function renderTestCaseDetail(index, result, testCases) {
                const sanitize = (text) => text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
                document.getElementById('test-case-details').innerHTML = `
                    <div class="p-2 text-gray-300">
                        <div class="font-semibold text-lg mb-2 ${result.status === 'Accepted' ? 'text-green-400' : 'text-red-400'}">Case ${index + 1}: ${result.status}</div>
                        <div class="space-y-3 text-sm">
                            <div><strong>Input:</strong><pre class="bg-gray-700 p-2 rounded mt-1 font-mono">${sanitize(testCases[index].input)}</pre></div>
                            <div><strong>Your Output:</strong><pre class="bg-gray-700 p-2 rounded mt-1 font-mono">${sanitize(result.actual)}</pre></div>
                            <div><strong>Expected Output:</strong><pre class="bg-gray-700 p-2 rounded mt-1 font-mono">${sanitize(testCases[index].expected)}</pre></div>
                        </div>
                    </div>`;
            }

            async function forceSubmitTest(reason) {
                if(isSubmitting) return;
                isSubmitting = true;
                await showConfirmation(`Violation: ${reason}. Submitting test automatically.`, true);
                performSubmission();
            }

            async function performSubmission() {
                isSubmitting = true;
                clearInterval(timerInterval);
                selectProblem(currentProblemIndex);
                
                const submissions = currentTest.problems.map(p => ({
                    problemId: p.id,
                    code: problemSubmissions[p.id]?.code || '',
                    language: problemSubmissions[p.id]?.language || 'c'
                }));
                
                try {
                    // --- CHANGE: Use absolute URL ---
                    const response = await fetch(`${API_BASE_URL}/api/public/submit-coding-test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                        body: JSON.stringify({ testId: currentTest.testId, submissions, candidateDetails })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    showConfirmation(result.message, true);
                } catch (error) {
                    showConfirmation(`Submission Error: ${error.message}`, true);
                } finally {
                    setTimeout(() => {
                        if(document.fullscreenElement) document.exitFullscreen();
                        window.location.href = '/login.html';
                    }, 4000);
                }
            }

            document.getElementById('submit-test-btn').addEventListener('click', async () => {
                const confirmed = await showConfirmation("Are you sure you want to submit the test?");
                if(confirmed) performSubmission();
            });

            function showConfirmation(message, isFinal = false) {
                return new Promise(resolve => {
                    document.getElementById('modal-message').textContent = message;
                    const modal = document.getElementById('confirm-modal');
                    modal.classList.remove('hidden');
                    if (isFinal) {
                        document.getElementById('modal-buttons').style.display = 'none';
                        resolve(true);
                    } else {
                        document.getElementById('modal-buttons').style.display = 'flex';
                        document.getElementById('modal-confirm-btn').onclick = () => { modal.classList.add('hidden'); resolve(true); };
                        document.getElementById('modal-cancel-btn').onclick = () => { modal.classList.add('hidden'); resolve(false); };
                    }
                });
            }

            function startTimer(duration) {
                let timer = duration;
                timerInterval = setInterval(() => {
                    timer--;
                    let minutes = Math.floor(timer / 60);
                    let seconds = timer % 60;
                    document.getElementById('timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    if (timer <= 0) forceSubmitTest('Time is up!');
                }, 1000);
            }

            fetchTestDetails();
        });
    </script>
</body>
</html>
