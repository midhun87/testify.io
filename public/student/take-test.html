<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Test - TESTIFY</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- AI Proctoring Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-link:hover {
            background-color: #4338CA;
        }
        .sidebar-link.active {
            background-color: #4F46E5;
            font-weight: 600;
        }
        #test-environment.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            overflow-y: auto;
        }
        .palette-btn.active {
            background-color: #4F46E5;
            color: white;
            font-weight: bold;
        }
        .palette-btn.answered {
            background-color: #10B981;
            color: white;
        }
        #verification-status {
            min-height: 24px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png" alt="TESTIFY Logo">
                <span class="ml-3 text-2xl font-bold">TESTIFY</span>
            </div>
            <div class="flex flex-col flex-grow p-4">
                <a href="/student/dashboard.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="/student/take-test.html" class="sidebar-link active flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002 2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span class="ml-3">Take Test</span>
                </a>
                <a href="/student/test-history.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="ml-3">Test History</span>
                </a>
                <a href="/student/my-certificates.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="ml-3">My Certificates</span>
                </a>
                <a href="/student/my-courses.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="ml-3">My Courses</span>
                </a>
                <a href="/student/student-profile.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 7.5a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 20.25a8.25 8.25 0 1115 0v.75H4.5v-.75z"/></svg>
                <span class="ml-3">My Profile</span>
                </a>
                 <a href="compiler.html" class="sidebar-link  flex items-center py-2.5 px-4 rounded transition duration-200">
                      <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>
                      <span>Code Space</span>
                 </a>
                 <a href="sql-compiler.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200 mt-2">
                    <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9.75h7.5v7.5h-7.5v-7.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3.375 3.375h17.25v17.25h-17.25v-17.25z" /></svg>
                    <span>SQL CodeLab</span>
                </a>
            </div>
        </div>

        <!-- Main content -->
        <div id="main-content" class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-6">
                <h1 class="text-2xl font-bold text-gray-800">Available Tests</h1>
                 <div class="flex items-center">
                      <div class="relative">
                           <button id="user-menu-button" class="flex items-center space-x-2">
                                <span id="user-name" class="font-semibold text-gray-700">Student Name</span>
                                <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                           </button>
                           <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                           </div>
                      </div>
                </div>
            </div>

            <div class="p-6">
                <div id="test-list-container" class="bg-white p-6 rounded-xl shadow-md">
                    <div id="test-list" class="space-y-4">
                        <!-- Dynamically loaded tests will appear here -->
                    </div>
                </div>

                <!-- FAQ Toggle Button -->
                <div class="text-center mt-8">
                    <button id="faq-toggle" class="text-indigo-600 hover:text-indigo-800 font-semibold py-2 px-4 transition-colors duration-300">
                        Have questions? Read our FAQs
                    </button>
                </div>

                <!-- FAQ Section -->
                <div id="faq-section" class="hidden mt-6 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Frequently Asked Questions</h2>
                    <div class="space-y-4">
                        <!-- FAQ Item 1 -->
                        <div class="border-b pb-4">
                            <button class="faq-question w-full flex justify-between items-center text-left text-lg font-semibold text-gray-700">
                                <span>Why is my face verification failing?</span>
                                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="faq-answer hidden mt-3 text-gray-600 space-y-3">
                                <p>Face verification can fail due to poor lighting, your face being too far or too close to the camera, or something obstructing your face (like hair or glasses). Please ensure you are in a well-lit room and your entire face is clearly visible.</p>
                            </div>
                        </div>
                        <!-- FAQ Item 2 -->
                        <div class="border-b pb-4">
                            <button class="faq-question w-full flex justify-between items-center text-left text-lg font-semibold text-gray-700">
                                <span>What is considered a proctoring violation?</span>
                                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="faq-answer hidden mt-3 text-gray-600 space-y-3">
                                <p>Our AI proctoring system monitors for several potential violations to ensure a fair test environment. These include:</p>
                                <ul class="list-disc list-inside ml-4">
                                    <li>Someone else entering the camera view.</li>
                                    <li>You leaving the camera view for an extended period.</li>
                                    <li>Consistently looking away from the screen.</li>
                                    <li>Using a mobile phone or other unauthorized devices.</li>
                                    <li>Excessive noise or talking in the background.</li>
                                </ul>
                                <p>A detected violation will result in the automatic submission of your test.</p>
                            </div>
                        </div>
                        <!-- FAQ Item 3 -->
                        <div class="border-b pb-4">
                            <button class="faq-question w-full flex justify-between items-center text-left text-lg font-semibold text-gray-700">
                                <span>What happens if my internet disconnects?</span>
                                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="faq-answer hidden mt-3 text-gray-600 space-y-3">
                                <p>Your answers are saved periodically. If you get disconnected, simply log back in and resume the test. The timer will continue from where it left off. However, prolonged disconnection might be flagged for review. We recommend using a stable internet connection.</p>
                            </div>
                        </div>
                        <!-- FAQ Item 4 -->
                        <div class="border-b pb-4">
                            <button class="faq-question w-full flex justify-between items-center text-left text-lg font-semibold text-gray-700">
                                <span>Why did I get a "Permissions check failed" error?</span>
                                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="faq-answer hidden mt-3 text-gray-600 space-y-3">
                                <p>Refresh the page & start if not please follow below step</p>
                                <p>This error appears when the website is not granted permission to access your camera and microphone, which are required for AI proctoring. Please check your browser's settings to ensure that you have allowed camera and microphone access for this website, then refresh the page and try starting the test again.</p>
                                <img src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756622890/Screenshot_2025-08-31_115534_r8bbiy.png" alt="Browser permission settings" class="rounded-lg shadow-md mx-auto" style="max-width: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Face Verification Modal -->
        <div id="face-verification-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Face Verification</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">Please align your face with the camera to verify your identity.</p>
                        <div class="flex justify-around items-center mt-4">
                            <div>
                                <p class="font-semibold">Your Profile</p>
                                <img id="profile-image-verification" src="https://placehold.co/150x150/EFEFEF/AAAAAA&text=Profile" alt="Profile Image" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200">
                            </div>
                            <div>
                                <p class="font-semibold">Live Camera</p>
                                <video id="verification-webcam" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200" autoplay muted playsinline></video>
                            </div>
                        </div>
                         <div id="verification-status" class="mt-4 text-sm font-medium"></div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="verify-identity-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 disabled:bg-gray-400">
                            Verify My Identity
                        </button>
                         <button id="cancel-verification-btn" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Environment (Initially Hidden) -->
        <div id="test-environment" class="hidden bg-white">
            <!-- Test Header -->
            <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-6 fixed top-0 left-0 w-full z-10">
                <div class="flex items-center">
                    <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_3wfuty3wfuty3wfu_iqsg1x.png" alt="TESTIFY Lockdown Logo">
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-gray-800">Testify-Lockdown Portal</h1>
                        <p id="test-title" class="text-sm text-gray-600 font-medium"></p>
                    </div>
                </div>
                <button id="submit-test-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Submit Test</button>
            </div>

            <!-- Test Body -->
            <div class="pt-20 flex" style="height: 100vh;">
                <!-- Question Area -->
                <div class="flex-1 p-8 overflow-y-auto">
                    <div id="question-content"></div>
                    <div class="mt-8 flex justify-between">
                        <button id="prev-btn" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Previous</button>
                        <button id="next-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Next</button>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="w-72 bg-gray-100 border-l border-gray-200 p-4 flex flex-col space-y-4">
                    <!-- AI PROCTORING VIEW -->
                    <div id="proctor-container" class="hidden relative w-full h-48 bg-black rounded-lg shadow-lg border-2 border-gray-300">
                        <video id="webcam" class="w-full h-full rounded-lg object-cover" autoplay muted playsinline></video>
                        <div id="proctor-status" class="absolute bottom-0 left-0 w-full bg-black bg-opacity-60 text-white text-xs text-center py-1 font-semibold">
                            Initializing...
                        </div>
                    </div>
                    
                    <!-- Timer -->
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                         <h3 class="font-semibold text-gray-700">Time Left:</h3>
                         <div class="text-2xl font-bold text-red-600" id="timer">00:00</div>
                    </div>

                    <!-- Question Palette -->
                    <div class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-sm">
                         <h3 class="font-bold text-gray-800 mb-2 text-center">Question Palette</h3>
                         <div id="question-palette" class="grid grid-cols-5 gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Audio Warning Modal -->
    <div id="audio-warning-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-[10000]">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm mx-auto text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-volume-up text-4xl text-yellow-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Noise Detected</h3>
            <p class="text-gray-600 mt-2">Please maintain silence. Further noise will be flagged as a violation.</p>
            <p id="warning-count" class="text-lg font-bold text-yellow-600 mt-4"></p>
            <button id="close-warning-btn" class="mt-6 w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600">I Understand</button>
        </div>
    </div>

    <footer class="bg-white border-t border-gray-200 p-4 mt-auto">
    <div class="text-center text-sm text-gray-500">
        &copy; 2025 TESTIFY. All Rights Reserved.
    </div>
  </footer>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- AUTHENTICATION & USER INFO ---
            const user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('token');

            if (!token || !user || user.role !== 'Student') {
                window.location.href = '/login.html';
                return;
            }
            document.getElementById('user-name').textContent = user.fullName;
            
            // --- UI ELEMENT REFERENCES ---
            const mainContent = document.getElementById('main-content');
            const testEnvironment = document.getElementById('test-environment');
            const testListDiv = document.getElementById('test-list');
            const submitTestBtn = document.getElementById('submit-test-btn');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const logoutButton = document.getElementById('logout-button');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const faceVerificationModal = document.getElementById('face-verification-modal');
            const verifyIdentityBtn = document.getElementById('verify-identity-btn');
            const cancelVerificationBtn = document.getElementById('cancel-verification-btn');
            const verificationStatus = document.getElementById('verification-status');
            const audioWarningModal = document.getElementById('audio-warning-modal');
            const warningCountSpan = document.getElementById('warning-count');
            const closeWarningBtn = document.getElementById('close-warning-btn');
            const faqToggleBtn = document.getElementById('faq-toggle');
            const faqSection = document.getElementById('faq-section');
            
            // --- TEST STATE ---
            let testInProgress = false;
            let timerInterval;
            let timeTaken = 0;
            let currentTest = null;
            let currentQuestionIndex = 0;
            let studentAnswers = [];
            let availableTests = [];
            let profileImageUrl = null;
            let lastViolationReason = null;

            // --- AI PROCTORING STATE & CONSTANTS ---
            let proctoringEnabled = false;
            let verificationStream = null;
            let proctoringStream = null;
            let objectDetector = null;
            let faceDetector = null;
            let audioContext = null;
            let audioSource = null;
            let audioProcessor = null;
            let isWarningActive = false;
            
            // Violation counters
            let phoneDetectionCount = 0;
            let noFaceCounter = 0;
            let lookingAwayCounter = 0;
            let audioViolationCount = 0;

            // Proctoring thresholds
            const PHONE_SCORE_TRACE = 0.45;
            const PHONE_SCORE_CLEAR = 0.75;
            const PHONE_WARNING_THRESHOLD = 2;
            const NO_FACE_FRAME_LIMIT = 90;
            const LOOKING_AWAY_HORIZONTAL_THRESHOLD = 30;
            const LOOKING_AWAY_FRAME_LIMIT = 120;
            const AUDIO_VIOLATION_LIMIT = 5; 
            const AUDIO_LEVEL_THRESHOLD = 0.20; 

            // --- FETCH AND DISPLAY AVAILABLE TESTS ---
            async function fetchAndDisplayTests() {
                try {
                    const response = await fetch('/api/student/tests', {
                        headers: { 'x-auth-token': token }
                    });
                    if (!response.ok) throw new Error('Failed to fetch tests');
                    
                    availableTests = await response.json();

                    testListDiv.innerHTML = '';
                    if (availableTests.length === 0) {
                        testListDiv.innerHTML = '<p class="text-gray-500">No new tests assigned to you at the moment.</p><p>If you find any test missing please contact your administrator.</p>';
                        return;
                    }

                    availableTests.forEach(test => {
                        const testElement = document.createElement('div');
                        testElement.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200';
                        testElement.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${test.title}</p>
                                <p class="text-sm text-gray-600">Duration: ${test.duration} minutes | Questions: ${test.questions.length}</p>
                            </div>
                            <button class="start-test-btn px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-700" data-testid="${test.testId}">
                                Start Test
                            </button>
                        `;
                        testListDiv.appendChild(testElement);
                    });
                } catch (error) {
                    console.error('Error fetching tests:', error);
                    testListDiv.innerHTML = '<p class="text-red-500">Could not load available tests.</p>';
                }
            }

            // --- FETCH STUDENT PROFILE ---
            async function fetchProfile() {
                try {
                    const response = await fetch('/api/student/profile', {
                        headers: { 'x-auth-token': token }
                    });
                    const data = await response.json();
                    profileImageUrl = data.profileImageUrl;
                } catch (error) {
                    console.error('Error fetching profile:', error);
                }
            }
            
            // --- EVENT LISTENERS ---
            userMenuButton.addEventListener('click', () => userMenu.classList.toggle('hidden'));
            logoutButton.addEventListener('click', logout);
            submitTestBtn.addEventListener('click', () => submitTest('Are you sure you want to submit the test?'));
            
            testListDiv.addEventListener('click', async (e) => {
                if (e.target.classList.contains('start-test-btn')) {
                    const testId = e.target.dataset.testid;
                    currentTest = availableTests.find(t => t.testId === testId);
                    if (currentTest) {
                        openFaceVerification();
                    }
                }
            });

            verifyIdentityBtn.addEventListener('click', performFaceVerification);
            cancelVerificationBtn.addEventListener('click', closeFaceVerification);
            prevBtn.addEventListener('click', navigatePrev);
            nextBtn.addEventListener('click', navigateNext);
            closeWarningBtn.addEventListener('click', () => audioWarningModal.classList.add('hidden'));

            faqToggleBtn.addEventListener('click', () => {
                faqSection.classList.toggle('hidden');
            });

            faqSection.addEventListener('click', (e) => {
                const questionBtn = e.target.closest('.faq-question');
                if (questionBtn) {
                    const answer = questionBtn.nextElementSibling;
                    const icon = questionBtn.querySelector('svg');
                    if (answer.classList.contains('hidden')) {
                        answer.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                    } else {
                        answer.classList.add('hidden');
                        icon.classList.remove('rotate-180');
                    }
                }
            });


            document.addEventListener('contextmenu', event => {
                if (testInProgress) {
                    event.preventDefault();
                }
            });

            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }

            // --- FACE VERIFICATION ---
            async function openFaceVerification() {
                if (!profileImageUrl) {
                    alert('You must have a profile picture to take a proctored test. Please upload one on your profile page.');
                    return;
                }
                document.getElementById('profile-image-verification').src = profileImageUrl;
                faceVerificationModal.classList.remove('hidden');
                try {
                    verificationStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    document.getElementById('verification-webcam').srcObject = verificationStream;
                } catch (err) {
                    alert('Could not access webcam. Please allow camera access to continue.');
                    closeFaceVerification();
                }
            }

            function closeFaceVerification() {
                faceVerificationModal.classList.add('hidden');
                if (verificationStream) {
                    verificationStream.getTracks().forEach(track => track.stop());
                    verificationStream = null;
                }
                verificationStatus.textContent = '';
                verifyIdentityBtn.disabled = false;
                verifyIdentityBtn.textContent = 'Verify My Identity';
            }

            async function performFaceVerification() {
                const video = document.getElementById('verification-webcam');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const webcamImage = canvas.toDataURL('image/jpeg');

                verifyIdentityBtn.disabled = true;
                verifyIdentityBtn.textContent = 'Verifying...';
                verificationStatus.textContent = 'Please wait...';
                verificationStatus.className = 'mt-4 text-sm font-medium text-blue-600';

                try {
                    const response = await fetch('/api/student/face-verification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify({ profileImageUrl, webcamImage })
                    });
                    
                    const result = await response.json();

                    if (response.ok && result.success) {
                        verificationStatus.textContent = 'Verification successful! Starting test...';
                        verificationStatus.className = 'mt-4 text-sm font-medium text-green-600';
                        setTimeout(() => {
                            closeFaceVerification();
                            startTest(currentTest);
                        }, 1500);
                    } else {
                        throw new Error(result.message || 'Face verification failed.');
                    }
                } catch (error) {
                    verificationStatus.textContent = `Verification Failed: ${error.message}`;
                    verificationStatus.className = 'mt-4 text-sm font-medium text-red-600';
                    verifyIdentityBtn.disabled = false;
                    verifyIdentityBtn.textContent = 'Try Again';
                }
            }

            // --- TEST LOGIC ---
            async function startTest(testData) {
                const proctoringConsent = confirm(
                     'This test requires AI proctoring.\n\n' +
                     'Your webcam and microphone will be activated to monitor for violations. Any violation will result in automatic test submission.\n\n' +
                     'This test will also start in fullscreen mode. Exiting fullscreen will submit the test.\n\n' +
                     'By proceeding, you agree to the terms outlined in our T&C:\n' +
                     'https://testify-io-ai.onrender.com/T&C.html\n\n' +
                     'Are you ready to begin?'
                );
                
                if (!proctoringConsent) return;
                
                try {
                    await enterFullScreen(); 
                    
                    mainContent.classList.add('hidden');
                    testEnvironment.classList.remove('hidden');
                    testEnvironment.classList.add('fullscreen');
                    
                    await initializeProctoring();

                    studentAnswers = new Array(testData.questions.length).fill(null);
                    currentQuestionIndex = 0;
                    testInProgress = true;
                    lastViolationReason = null;
                    
                    document.getElementById('test-title').textContent = testData.title;
                    
                    startTimer(testData.duration * 60);
                    renderQuestion();
                    renderPalette();

                    document.addEventListener('fullscreenchange', handleFullScreenChange);
                    document.addEventListener('webkitfullscreenchange', handleFullScreenChange);
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                } catch (error) {
                    await exitFullScreen();
                    alert(`Failed to start the test.\nError: ${error.message}`);
                    mainContent.classList.remove('hidden');
                    testEnvironment.classList.add('hidden');
                }
            }

            async function submitTest(message) {
                if (window.isSubmitting) return;
                const shouldSubmit = confirm(message);
                if (shouldSubmit) {
                    window.isSubmitting = true;
                    await performSubmission();
                }
            }

            async function forceSubmitTest(message) {
                if (window.isSubmitting) return;
                window.isSubmitting = true;
                alert(message);
                await performSubmission();
            }

            async function performSubmission() {
                saveAnswer(); 
                testInProgress = false;
                clearInterval(timerInterval);
                
                stopProctoring(); 
                
                await exitFullScreen();
                document.removeEventListener('fullscreenchange', handleFullScreenChange);
                document.removeEventListener('webkitfullscreenchange', handleFullScreenChange);
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                
                const payload = {
                    testId: currentTest.testId,
                    answers: studentAnswers,
                    timeTaken: timeTaken,
                    violationReason: lastViolationReason 
                };

                try {
                    const response = await fetch('/api/student/submit-test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('Submission failed');
                    alert('Test submitted successfully!');
                    window.location.href = '/student/dashboard.html';
                } catch (error) {
                    alert('An error occurred during submission. Please contact your administrator.');
                    console.error('Submission Error:', error);
                }
            }

            function startTimer(duration) {
                let timer = duration;
                const timerDisplay = document.getElementById('timer');
                timerInterval = setInterval(() => {
                    timeTaken++;
                    let minutes = parseInt(timer / 60, 10);
                    let seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    timerDisplay.textContent = `${minutes}:${seconds}`;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        lastViolationReason = "Time Expired";
                        forceSubmitTest('Time is up! The test will now be submitted.');
                    }
                }, 1000);
            }

            function renderQuestion() {
                if (!currentTest) return;
                const question = currentTest.questions[currentQuestionIndex];
                const questionContent = document.getElementById('question-content');
                let optionsHtml = '';
                const savedAnswer = studentAnswers[currentQuestionIndex];

                if (question.type === 'mcq-single') {
                    optionsHtml = question.options.map((opt, i) => `
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="q${currentQuestionIndex}" value="${i}" class="h-4 w-4 text-indigo-600 border-gray-300" ${savedAnswer == i ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700">${opt}</span>
                        </label>
                    `).join('');
                } else if (question.type === 'mcq-multiple') {
                     optionsHtml = question.options.map((opt, i) => `
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="q${currentQuestionIndex}" value="${i}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" ${(savedAnswer && savedAnswer.includes(String(i))) ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700">${opt}</span>
                        </label>
                    `).join('');
                } else { // fill-blank
                    optionsHtml = `<input type="text" name="q${currentQuestionIndex}" class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg" value="${savedAnswer || ''}">`;
                }

                questionContent.innerHTML = `
                    <p class="text-lg font-semibold mb-4">Question ${currentQuestionIndex + 1}:</p>
                    <p class="text-gray-800 mb-6">${question.text}</p>
                    <div class="space-y-3">${optionsHtml}</div>
                `;
                updateNavButtons();
                updatePalette();
            }

            function renderPalette() {
                const questionPalette = document.getElementById('question-palette');
                questionPalette.innerHTML = '';
                currentTest.questions.forEach((_, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'palette-btn h-10 w-10 flex items-center justify-center bg-gray-200 rounded hover:bg-gray-300';
                    btn.textContent = i + 1;
                    btn.dataset.index = i;
                    btn.addEventListener('click', () => {
                        saveAnswer();
                        currentQuestionIndex = i;
                        renderQuestion();
                    });
                    questionPalette.appendChild(btn);
                });
            }

            function updateNavButtons() {
                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.disabled = currentQuestionIndex === currentTest.questions.length - 1;
                prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
            }
            
            function updatePalette() {
                document.querySelectorAll('.palette-btn').forEach((btn, i) => {
                    btn.classList.remove('active', 'answered');
                    if (studentAnswers[i] !== null && (!Array.isArray(studentAnswers[i]) || studentAnswers[i].length > 0)) {
                        btn.classList.add('answered');
                    }
                    if (i === currentQuestionIndex) {
                        btn.classList.add('active');
                    }
                });
            }

            function saveAnswer() {
                if (!currentTest) return;
                const question = currentTest.questions[currentQuestionIndex];
                const inputs = document.getElementsByName(`q${currentQuestionIndex}`);
                if (question.type === 'mcq-single') {
                    const checked = Array.from(inputs).find(i => i.checked);
                    studentAnswers[currentQuestionIndex] = checked ? checked.value : null;
                } else if (question.type === 'mcq-multiple') {
                    const checked = Array.from(inputs).filter(i => i.checked).map(i => i.value);
                    studentAnswers[currentQuestionIndex] = checked.length > 0 ? checked : null;
                } else { // fill-blank
                    studentAnswers[currentQuestionIndex] = inputs[0].value.trim() ? inputs[0].value.trim() : null;
                }
            }

            function navigateNext() {
                if (currentQuestionIndex < currentTest.questions.length - 1) {
                    saveAnswer();
                    currentQuestionIndex++;
                    renderQuestion();
                }
            }

            function navigatePrev() {
                if (currentQuestionIndex > 0) {
                    saveAnswer();
                    currentQuestionIndex--;
                    renderQuestion();
                }
            }

            // --- AI PROCTORING & SECURITY ---
            async function initializeProctoring() {
                const proctorContainer = document.getElementById('proctor-container');
                const proctorStatus = document.getElementById('proctor-status');
                const videoElement = document.getElementById('webcam');

                proctorStatus.textContent = 'Requesting camera & mic...';
                
                try {
                    proctoringStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    videoElement.srcObject = proctoringStream;
                    proctorContainer.classList.remove('hidden');
                    
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioSource = audioContext.createMediaStreamSource(proctoringStream);
                    audioProcessor = audioContext.createAnalyser();
                    audioProcessor.fftSize = 512;
                    audioSource.connect(audioProcessor);

                    proctorStatus.textContent = 'Connecting you to server....';
                    [objectDetector, faceDetector] = await Promise.all([
                        cocoSsd.load(),
                        blazeface.load()
                    ]);
                    
                    proctorStatus.innerHTML = '<span class="text-green-400">Proctoring Active</span>';
                    proctoringEnabled = true;
                    runProctoring();
                } catch (err) {
                    console.error("Proctoring Error:", err);
                    stopProctoring();
                    throw new Error("Webcam/Mic access denied or AI models failed to load.");
                }
            }

            async function runProctoring() {
                if (!proctoringEnabled) return;

                const videoElement = document.getElementById('webcam');
                const [objectPredictions, facePredictions] = await Promise.all([
                    objectDetector.detect(videoElement),
                    faceDetector.estimateFaces(videoElement, false)
                ]);

                const dataArray = new Uint8Array(audioProcessor.frequencyBinCount);
                audioProcessor.getByteFrequencyData(dataArray);
                let sum = 0;
                for (const amplitude of dataArray) {
                    sum += amplitude * amplitude;
                }
                const volume = Math.sqrt(sum / dataArray.length) / 100;

                if (volume > AUDIO_LEVEL_THRESHOLD) {
                    if (!audioWarningModal.classList.contains('hidden')) {
                          // If modal is already open, don't do anything until it's closed
                    } else {
                        audioViolationCount++;
                        if (audioViolationCount >= AUDIO_VIOLATION_LIMIT) {
                            return handleViolation('Excessive Noise Detected');
                        } else {
                            showAudioWarning();
                        }
                    }
                }

                if (facePredictions.length > 1) {
                    return handleViolation('Multiple People Detected');
                }
                
                if (facePredictions.length === 0) {
                    noFaceCounter++;
                    if (noFaceCounter > NO_FACE_FRAME_LIMIT) {
                        return handleViolation('User Not Present');
                    }
                } else {
                    noFaceCounter = 0;
                    if (isLookingAway(facePredictions[0])) {
                        lookingAwayCounter++;
                        if (lookingAwayCounter > LOOKING_AWAY_FRAME_LIMIT) {
                           return handleViolation('Looking Away From Screen');
                        }
                    } else {
                        lookingAwayCounter = 0;
                    }
                }

                const phone = objectPredictions.find(p => p.class === 'cell phone');
                if (phone) {
                    if (phone.score > PHONE_SCORE_CLEAR) {
                        return handleViolation('Phone Clearly Detected');
                    }
                    if (phone.score > PHONE_SCORE_TRACE) {
                        phoneDetectionCount++;
                        if (phoneDetectionCount > PHONE_WARNING_THRESHOLD) {
                            return handleViolation('Repeated Phone Detection');
                        } else {
                            showWarning(`Phone Detected (${phoneDetectionCount}/${PHONE_WARNING_THRESHOLD + 1})`);
                        }
                    }
                }

                requestAnimationFrame(runProctoring);
            }

            function isLookingAway(face) {
                const leftEye = face.landmarks[0];
                const rightEye = face.landmarks[1];
                const nose = face.landmarks[2];
                const eyeMidpointX = (leftEye[0] + rightEye[0]) / 2;
                const horizontalDistance = Math.abs(nose[0] - eyeMidpointX);
                return horizontalDistance > LOOKING_AWAY_HORIZONTAL_THRESHOLD;
            }
            
            function showAudioWarning() {
                warningCountSpan.textContent = `Warning ${audioViolationCount} of ${AUDIO_VIOLATION_LIMIT}`;
                audioWarningModal.classList.remove('hidden');
            }

            function showWarning(message) {
                if (isWarningActive) return;
                isWarningActive = true;
                const proctorStatus = document.getElementById('proctor-status');
                const originalStatus = proctorStatus.innerHTML;
                proctorStatus.innerHTML = `<span class="text-yellow-400 font-bold">WARNING: ${message}</span>`;
                
                setTimeout(() => {
                    proctorStatus.innerHTML = originalStatus;
                    isWarningActive = false;
                }, 3000);
            }

            function handleViolation(reason) {
                if (!proctoringEnabled) return; 
                
                proctoringEnabled = false;
                lastViolationReason = reason;
                const proctorStatus = document.getElementById('proctor-status');
                proctorStatus.innerHTML = `<span class="text-red-500 font-bold">VIOLATION: ${reason}</span>`;
                
                setTimeout(() => {
                    forceSubmitTest(`VIOLATION DETECTED: ${reason}. The test is being submitted automatically.`);
                }, 2000);
            }

            function stopProctoring() {
                proctoringEnabled = false;
                if (proctoringStream) {
                    proctoringStream.getTracks().forEach(track => track.stop());
                    proctoringStream = null;
                }
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                const proctorContainer = document.getElementById('proctor-container');
                if(proctorContainer) proctorContainer.classList.add('hidden');
            }

            function handleFullScreenChange() {
                const isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
                if (!isFullScreen && testInProgress) {
                    handleViolation('Exited Full-Screen Mode');
                }
            }

            function handleVisibilityChange() {
                if (document.hidden && testInProgress) {
                    handleViolation('Switched to Another Tab/Window');
                }
            }

            function enterFullScreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) return elem.requestFullscreen();
                if (elem.webkitRequestFullscreen) return elem.webkitRequestFullscreen();
                return Promise.resolve();
            }

            function exitFullScreen() {
                if (document.exitFullscreen && document.fullscreenElement) return document.exitFullscreen();
                if (document.webkitExitFullscreen && document.webkitFullscreenElement) return document.webkitExitFullscreen();
                return Promise.resolve();
            }
            
            await fetchAndDisplayTests();
            await fetchProfile();
        });
    </script>
</body>
</html>

