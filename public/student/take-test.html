<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Test - TESTIFY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-link:hover {
            background-color: #4338CA;
        }
        .sidebar-link.active {
            background-color: #4F46E5;
            font-weight: 600;
        }
        #test-environment.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            overflow-y: auto;
        }
        .palette-btn.active {
            background-color: #4F46E5;
            color: white;
            font-weight: bold;
        }
        .palette-btn.answered {
            background-color: #10B981;
            color: white;
        }
        /* -- MOBILE SIDEBAR STYLES (New) -- */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.hidden-mobile {
            transform: translateX(-100%);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <div id="sidebar" class="fixed md:relative flex flex-col w-64 bg-gray-800 text-white z-30 h-full hidden-mobile md:translate-x-0 md:flex">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png" alt="TESTIFY Logo">
                <span class="ml-3 text-2xl font-bold">TESTIFY</span>
            </div>
            <div class="flex flex-col flex-grow p-4">
                <a href="/student/dashboard.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="/student/take-test.html" class="sidebar-link active flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span class="ml-3">Take Test</span>
                </a>
                <a href="/student/test-history.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="ml-3">Test History</span>
                </a>
            </div>
        </div>

        <div id="main-content" class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-4 sm:px-6">
                 <button id="mobile-menu-btn" class="md:hidden text-gray-600 hover:text-gray-800">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>

                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Available Tests</h1>
                 <div class="flex items-center">
                      <div class="relative">
                           <button id="user-menu-button" class="flex items-center space-x-2">
                               <span id="user-name" class="font-semibold text-gray-700">Student Name</span>
                               <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                           </button>
                           <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                               <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                           </div>
                      </div>
                 </div>
            </div>

            <div class="p-4 sm:p-6">
                <div id="test-list-container" class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                    <div id="test-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </div>
        
        <div id="test-environment" class="hidden bg-white">
            <div class="flex items-center justify-between flex-wrap h-auto sm:h-20 bg-white border-b border-gray-200 px-4 py-2 sm:px-6 fixed top-0 left-0 w-full z-10">
                <div class="flex items-center">
                    <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_3wfuty3wfuty3wfu_iqsg1x.png" alt="TESTIFY Lockdown Logo">
                    <div class="ml-3 sm:ml-4">
                        <h1 class="text-lg sm:text-xl font-bold text-gray-800">Testify-Lockdown Portal</h1>
                        <p id="test-title" class="text-sm text-gray-600 font-medium"></p> </div>
                </div>
                <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                    <div class="text-lg font-bold text-red-600" id="timer">00:00</div>
                    <button id="submit-test-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Submit Test</button>
                </div>
            </div>

            <div class="pt-28 sm:pt-20 flex flex-col md:flex-row min-h-screen">
                <div class="flex-1 p-4 md:p-8">
                    <div id="question-content"></div>
                    <div class="mt-8 flex justify-between">
                        <button id="prev-btn" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Previous</button>
                        <button id="next-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Next</button>
                    </div>
                </div>

                <div class="w-full md:w-72 bg-gray-50 border-t md:border-t-0 md:border-l border-gray-200 p-4">
                    <h3 class="font-bold text-gray-800 mb-4">Question Palette</h3>
                    <div id="question-palette" class="grid grid-cols-8 sm:grid-cols-10 md:grid-cols-5 gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- AUTHENTICATION & USER INFO ---
            const user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('token');

            if (!token || !user || user.role !== 'Student') {
                window.location.href = '/login.html';
                return;
            }
            document.getElementById('user-name').textContent = user.fullName;
            
            // --- UI ELEMENT REFERENCES ---
            const mainContent = document.getElementById('main-content');
            const testEnvironment = document.getElementById('test-environment');
            const testListDiv = document.getElementById('test-list');
            const submitTestBtn = document.getElementById('submit-test-btn');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const logoutButton = document.getElementById('logout-button');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            // NEW: Mobile menu elements
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.getElementById('sidebar');

            // --- TEST STATE ---
            let testInProgress = false;
            let timerInterval;
            let timeTaken = 0;
            let currentTest = null;
            let currentQuestionIndex = 0;
            let studentAnswers = [];
            let availableTests = [];

            // --- FETCH AND DISPLAY AVAILABLE TESTS ---
            async function fetchAndDisplayTests() {
                try {
                    const response = await fetch('/api/student/tests', {
                        headers: { 'x-auth-token': token }
                    });
                    if (!response.ok) throw new Error('Failed to fetch tests');
                    
                    availableTests = await response.json();

                    testListDiv.innerHTML = '';
                    if (availableTests.length === 0) {
                        testListDiv.innerHTML = '<p class="text-gray-500">No new tests assigned to you at the moment.</p>';
                        return;
                    }

                    availableTests.forEach(test => {
                        const testElement = document.createElement('div');
                        // MODIFIED: Classes changed for responsive stacking
                        testElement.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200';
                        testElement.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${test.title}</p>
                                <p class="text-sm text-gray-600">Duration: ${test.duration} minutes | Questions: ${test.questions.length}</p>
                            </div>
                            <button class="start-test-btn mt-3 sm:mt-0 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-700" data-testid="${test.testId}">
                                Start Test
                            </button>
                        `;
                        testListDiv.appendChild(testElement);
                    });
                } catch (error) {
                    console.error('Error fetching tests:', error);
                    testListDiv.innerHTML = '<p class="text-red-500">Could not load available tests.</p>';
                }
            }
            await fetchAndDisplayTests();

            // --- EVENT LISTENERS ---
            userMenuButton.addEventListener('click', () => userMenu.classList.toggle('hidden'));
            logoutButton.addEventListener('click', logout);
            submitTestBtn.addEventListener('click', () => submitTest('Are you sure you want to submit the test?'));
            
            // NEW: Event listener for the hamburger menu
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden-mobile');
            });

            testListDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('start-test-btn')) {
                    const testId = e.target.dataset.testid;
                    const selectedTest = availableTests.find(t => t.testId === testId);
                    if (selectedTest) {
                        startTest(selectedTest);
                    } else {
                        alert('Error: Could not find the selected test.');
                    }
                }
            });

            prevBtn.addEventListener('click', navigatePrev);
            nextBtn.addEventListener('click', navigateNext);

            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }

            // --- TEST LOGIC (largely unchanged, as it's not layout-dependent) ---
            function startTest(testData) {
                if (!confirm('This test will start in fullscreen mode. You cannot exit fullscreen or switch tabs. Are you ready to begin?')) return;
                
                currentTest = testData;
                studentAnswers = new Array(currentTest.questions.length).fill(null);
                currentQuestionIndex = 0;
                testInProgress = true;

                mainContent.classList.add('hidden');
                sidebar.classList.add('md:hidden'); // Hide sidebar completely during test
                testEnvironment.classList.remove('hidden');
                testEnvironment.classList.add('fullscreen');
                
                document.getElementById('test-title').textContent = currentTest.title;
                
                enterFullScreen();
                startTimer(currentTest.duration * 60);
                renderQuestion();
                renderPalette();

                document.addEventListener('fullscreenchange', handleFullScreenChange);
                document.addEventListener('visibilitychange', handleVisibilityChange);
            }

            async function submitTest(message) {
                if (confirm(message)) {
                    saveAnswer(); // Save the final answer before submitting
                    testInProgress = false;
                    clearInterval(timerInterval);
                    exitFullScreen();
                    
                    document.removeEventListener('fullscreenchange', handleFullScreenChange);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    
                    const payload = {
                        testId: currentTest.testId,
                        answers: studentAnswers,
                        timeTaken: timeTaken
                    };

                    try {
                        const response = await fetch('/api/student/submit-test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-auth-token': token
                            },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error('Submission failed');
                        alert('Test submitted successfully!');
                        window.location.href = '/student/dashboard.html';
                    } catch (error) {
                        alert('An error occurred during submission. Please try again.');
                        console.error('Submission Error:', error);
                    }
                }
            }

            function startTimer(duration) {
                let timer = duration;
                const timerDisplay = document.getElementById('timer');
                timerInterval = setInterval(() => {
                    timeTaken++;
                    let minutes = parseInt(timer / 60, 10);
                    let seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    timerDisplay.textContent = `${minutes}:${seconds}`;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        submitTest('Time is up! The test will now be submitted.');
                    }
                }, 1000);
            }

            function renderQuestion() {
                if (!currentTest) return;
                const question = currentTest.questions[currentQuestionIndex];
                const questionContent = document.getElementById('question-content');
                let optionsHtml = '';
                const savedAnswer = studentAnswers[currentQuestionIndex];

                if (question.type === 'mcq-single') {
                    optionsHtml = question.options.map((opt, i) => `
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="q${currentQuestionIndex}" value="${i}" class="h-4 w-4 text-indigo-600 border-gray-300" ${savedAnswer == i ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700">${opt}</span>
                        </label>
                    `).join('');
                } else if (question.type === 'mcq-multiple') {
                     optionsHtml = question.options.map((opt, i) => `
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" name="q${currentQuestionIndex}" value="${i}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" ${(savedAnswer && savedAnswer.includes(String(i))) ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700">${opt}</span>
                        </label>
                    `).join('');
                } else { // fill-blank
                    optionsHtml = `<input type="text" name="q${currentQuestionIndex}" class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg" value="${savedAnswer || ''}">`;
                }

                questionContent.innerHTML = `
                    <p class="text-lg font-semibold mb-4">Question ${currentQuestionIndex + 1}:</p>
                    <p class="text-gray-800 mb-6">${question.text}</p>
                    <div class="space-y-3">${optionsHtml}</div>
                `;
                updateNavButtons();
                updatePalette();
            }

            function renderPalette() {
                const questionPalette = document.getElementById('question-palette');
                questionPalette.innerHTML = '';
                currentTest.questions.forEach((_, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'palette-btn h-10 w-10 flex items-center justify-center bg-gray-200 rounded hover:bg-gray-300';
                    btn.textContent = i + 1;
                    btn.dataset.index = i;
                    btn.addEventListener('click', () => {
                        saveAnswer();
                        currentQuestionIndex = i;
                        renderQuestion();
                    });
                    questionPalette.appendChild(btn);
                });
            }

            function updateNavButtons() {
                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.disabled = currentQuestionIndex === currentTest.questions.length - 1;
                prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
            }
            
            function updatePalette() {
                document.querySelectorAll('.palette-btn').forEach((btn, i) => {
                    btn.classList.remove('active', 'answered');
                    if (studentAnswers[i] !== null && studentAnswers[i] !== '' && (!Array.isArray(studentAnswers[i]) || studentAnswers[i].length > 0)) {
                        btn.classList.add('answered');
                    }
                    if (i === currentQuestionIndex) {
                        btn.classList.add('active');
                    }
                });
            }

            function saveAnswer() {
                if(!currentTest) return;
                const question = currentTest.questions[currentQuestionIndex];
                const inputs = document.getElementsByName(`q${currentQuestionIndex}`);
                if (question.type === 'mcq-single') {
                    const checked = Array.from(inputs).find(i => i.checked);
                    studentAnswers[currentQuestionIndex] = checked ? checked.value : null;
                } else if (question.type === 'mcq-multiple') {
                    const checked = Array.from(inputs).filter(i => i.checked).map(i => i.value);
                    studentAnswers[currentQuestionIndex] = checked.length > 0 ? checked : null;
                } else { // fill-blank
                    studentAnswers[currentQuestionIndex] = inputs[0].value.trim() !== '' ? inputs[0].value.trim() : null;
                }
            }

            function navigateNext() {
                if (currentQuestionIndex < currentTest.questions.length - 1) {
                    saveAnswer();
                    currentQuestionIndex++;
                    renderQuestion();
                }
            }

            function navigatePrev() {
                if (currentQuestionIndex > 0) {
                    saveAnswer();
                    currentQuestionIndex--;
                    renderQuestion();
                }
            }

            // --- SECURITY & FULLSCREEN ---
            function handleFullScreenChange() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement && testInProgress) {
                    submitTest('You have exited full-screen mode. The test will be submitted automatically.');
                }
            }

            function handleVisibilityChange() {
                if (document.hidden && testInProgress) {
                    submitTest('You have switched tabs. The test will be submitted automatically.');
                }
            }

            function enterFullScreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) elem.requestFullscreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
            }

            function exitFullScreen() {
                if (document.exitFullscreen && document.fullscreenElement) document.exitFullscreen();
                else if (document.webkitExitFullscreen && document.webkitFullscreenElement) document.webkitExitFullscreen();
            }
        });
    </script>
</body>
</html>
