<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Test - TESTIFY</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- AI Proctoring Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #test-environment.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            overflow-y: auto;
        }
        .palette-btn.active {
            background-color: #4F46E5;
            color: white;
            font-weight: bold;
        }
        .palette-btn.answered {
            background-color: #10B981;
            color: white;
        }
        #verification-status {
            min-height: 24px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .modal-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 400px;
        }
        .test-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main content area before test starts -->
    <div id="main-content" class="min-h-screen flex flex-col">
        <header class="bg-white shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex-shrink-0 flex items-center">
                        <img class="h-10 w-auto" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png" alt="Testify Logo">
                        <span class="ml-2 text-2xl font-extrabold text-indigo-700">TESTIFY</span>
                    </div>
                     <h1 class="text-3xl font-bold text-gray-800 tracking-tight">Available AI Proctored Tests</h1>
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center space-x-2">
                            <span id="user-name" class="font-semibold text-gray-700">Student Name</span>
                            <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                            <a href="/student/dashboard.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Dashboard</a>
                            <a href="/student/student-profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">My Profile</a>
                            <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 lg:p-10">
            <div id="test-list-container" class="max-w-7xl mx-auto">
                <div id="test-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Dynamically loaded tests will appear here as cards -->
                </div>
            </div>
             <!-- FAQ Section can be added here if needed -->
        </main>
        
        <footer class="bg-white mt-12 py-4 border-t border-gray-200">
             <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-center items-center">
                <p class="text-sm text-gray-500 mr-2">Powered by</p>
                <img src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1758718248/EduDevelopers_logo_m1h9db.png" alt="EduDevelopers Logo" class="h-11">
            </div>
        </footer>
    </div>
    
    <!-- Face Verification Modal -->
    <div id="face-verification-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Face Verification</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Please align your face with the camera to verify your identity.</p>
                    <div class="flex justify-around items-center mt-4">
                        <div>
                            <p class="font-semibold">Your Profile</p>
                            <img id="profile-image-verification" src="https://placehold.co/150x150/EFEFEF/AAAAAA&text=Profile" alt="Profile Image" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200">
                        </div>
                        <div>
                            <p class="font-semibold">Live Camera</p>
                            <video id="verification-webcam" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200" autoplay muted playsinline></video>
                        </div>
                    </div>
                        <div id="verification-status" class="mt-4 text-sm font-medium"></div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="verify-identity-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 disabled:bg-gray-400">
                        Verify My Identity
                    </button>
                        <button id="cancel-verification-btn" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Environment (Initially Hidden) -->
    <div id="test-environment" class="hidden bg-white">
        <!-- Test Header -->
        <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-6 fixed top-0 left-0 w-full z-10">
            <div class="flex items-center">
                <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_3wfuty3wfuty3wfu_iqsg1x.png" alt="TESTIFY Lockdown Logo">
                <div class="ml-4">
                    <h1 class="text-xl font-bold text-gray-800">Testify-Lockdown Portal</h1>
                    <p id="test-title" class="text-sm text-gray-600 font-medium"></p>
                </div>
            </div>
            <button id="submit-test-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Submit Test</button>
        </div>

        <!-- Test Body -->
        <div class="pt-20 flex" style="height: 100vh;">
            <!-- Question Area -->
            <div class="flex-1 p-8 overflow-y-auto">
                <div id="question-content"></div>
                <div class="mt-8 flex justify-between">
                    <button id="prev-btn" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Previous</button>
                    <button id="next-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Next</button>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="w-72 bg-gray-100 border-l border-gray-200 p-4 flex flex-col space-y-4">
                <!-- AI PROCTORING VIEW -->
                <div id="proctor-container" class="hidden relative w-full h-48 bg-black rounded-lg shadow-lg border-2 border-gray-300">
                    <video id="webcam" class="w-full h-full rounded-lg object-cover" autoplay muted playsinline></video>
                    <div id="proctor-status" class="absolute bottom-0 left-0 w-full bg-black bg-opacity-60 text-white text-xs text-center py-1 font-semibold">
                        Initializing...
                    </div>
                </div>
                
                <!-- Timer -->
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-gray-700">Time Left:</h3>
                        <div class="text-2xl font-bold text-red-600" id="timer">00:00</div>
                </div>

                <!-- Question Palette -->
                <div class="flex-grow overflow-y-auto bg-white p-3 rounded-lg shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-2 text-center">Question Palette</h3>
                        <div id="question-palette" class="grid grid-cols-5 gap-2"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Warning Modal -->
    <div id="audio-warning-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-[10000]">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm mx-auto text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-volume-up text-4xl text-yellow-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Noise Detected</h3>
            <p class="text-gray-600 mt-2">Please maintain silence. Further noise will be flagged as a violation.</p>
            <p id="warning-count" class="text-lg font-bold text-yellow-600 mt-4"></p>
            <button id="close-warning-btn" class="mt-6 w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600">I Understand</button>
        </div>
    </div>

    <!-- General Modal for Alerts/Confirms -->
    <div id="general-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <p id="modal-message" class="text-gray-700 text-lg text-center font-medium"></p>
            <div id="modal-buttons" class="mt-6 flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">OK</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- AUTHENTICATION & USER INFO ---
            const user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('token');

            if (!token || !user || user.role !== 'Student') {
                window.location.href = '/login.html';
                return;
            }
            document.getElementById('user-name').textContent = user.fullName;
            
            // --- UI ELEMENT REFERENCES ---
            const mainContent = document.getElementById('main-content');
            const testEnvironment = document.getElementById('test-environment');
            const testListDiv = document.getElementById('test-list');
            const submitTestBtn = document.getElementById('submit-test-btn');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const logoutButton = document.getElementById('logout-button');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const faceVerificationModal = document.getElementById('face-verification-modal');
            const verifyIdentityBtn = document.getElementById('verify-identity-btn');
            const cancelVerificationBtn = document.getElementById('cancel-verification-btn');
            const verificationStatus = document.getElementById('verification-status');
            const audioWarningModal = document.getElementById('audio-warning-modal');
            const warningCountSpan = document.getElementById('warning-count');
            const closeWarningBtn = document.getElementById('close-warning-btn');
            const generalModal = document.getElementById('general-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            
            // --- TEST STATE ---
            let testInProgress = false;
            let timerInterval;
            let timeTaken = 0;
            let currentTest = null;
            let currentQuestionIndex = 0;
            let studentAnswers = [];
            let availableTests = [];
            let profileImageUrl = null;
            let lastViolationReason = null;
            window.isSubmitting = false; // Global flag to prevent multiple submissions

            // --- AI PROCTORING STATE & CONSTANTS ---
            let proctoringEnabled = false;
            let verificationStream = null;
            let proctoringStream = null;
            let objectDetector = null;
            let faceDetector = null;
            let audioContext = null;
            let audioSource = null;
            let audioProcessor = null;
            let isWarningActive = false;
            let isAudioOnCooldown = false; // Flag to prevent rapid audio warnings
            
            // Violation counters
            let phoneDetectionCount = 0;
            let noFaceCounter = 0;
            let multipleFaceCounter = 0; // New counter for multiple faces
            let lookingAwayCounter = 0;
            let audioViolationCount = 0;

            // Proctoring thresholds (REVISED FOR HIGHER SENSITIVITY)
            const PHONE_SCORE_TRACE = 0.40; // More sensitive to initial phone detection
            const PHONE_SCORE_CLEAR = 0.65; // Triggers violation with less certainty
            const PHONE_WARNING_THRESHOLD = 1; // Fewer warnings before violation
            const NO_FACE_FRAME_LIMIT = 45; // Approx 1.5 seconds of absence
            const MULTIPLE_FACE_FRAME_LIMIT = 20; // Stays at ~0.6s to avoid false positives
            const LOOKING_AWAY_HORIZONTAL_THRESHOLD = 35; // Unchanged
            const LOOKING_AWAY_FRAME_LIMIT = 75; // Approx 2.5 seconds
            const AUDIO_VIOLATION_LIMIT = 5; // Unchanged
            const AUDIO_LEVEL_THRESHOLD = 0.18; // Unchanged

            // --- CUSTOM MODAL FUNCTIONS ---
            function showModal(message, type = 'confirm') {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    if (type === 'alert') {
                        modalCancelBtn.classList.add('hidden');
                        modalConfirmBtn.textContent = 'OK';
                    } else {
                        modalCancelBtn.classList.remove('hidden');
                        modalConfirmBtn.textContent = 'Yes';
                    }
                    generalModal.classList.remove('hidden');

                    const handleConfirm = () => {
                        generalModal.classList.add('hidden');
                        resolve(true);
                        modalConfirmBtn.removeEventListener('click', handleConfirm);
                        modalCancelBtn.removeEventListener('click', handleCancel);
                    };

                    const handleCancel = () => {
                        generalModal.classList.add('hidden');
                        resolve(false);
                        modalConfirmBtn.removeEventListener('click', handleConfirm);
                        modalCancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    modalConfirmBtn.addEventListener('click', handleConfirm);
                    modalCancelBtn.addEventListener('click', handleCancel);
                });
            }

            function showAlert(message) {
                return showModal(message, 'alert');
            }

            // --- FETCH AND DISPLAY AVAILABLE TESTS (UI UPDATED) ---
            async function fetchAndDisplayTests() {
                try {
                    const response = await fetch('/api/student/tests', {
                        headers: { 'x-auth-token': token }
                    });
                    if (!response.ok) throw new Error('Failed to fetch tests');
                    
                    const allTests = await response.json();
                    availableTests = allTests.filter(t => !t.testType && !t.isMeeting);

                    testListDiv.innerHTML = '';
                    if (availableTests.length === 0) {
                        testListDiv.innerHTML = '<p class="text-gray-500 col-span-full text-center">No new AI proctored tests assigned to you.</p>';
                        return;
                    }

                    availableTests.forEach(test => {
                        const testElement = document.createElement('div');
                        testElement.className = 'test-card bg-white p-6 rounded-2xl shadow-lg border border-gray-200 flex flex-col hover:border-indigo-400';
                        const questionCount = test.questions ? test.questions.length : 0;
                        testElement.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="font-bold text-xl text-gray-800">${test.title}</h3>
                                <div class="mt-3 space-y-1 text-gray-600">
                                    <p class="text-sm flex items-center"><svg class="w-4 h-4 mr-1.5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 
                                        Duration: <span class="font-semibold ml-1">${test.duration} minutes</span>
                                    </p>
                                    <p class="text-sm flex items-center"><svg class="w-4 h-4 mr-1.5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2-8H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2z"></path></svg>
                                        Questions: <span class="font-semibold ml-1">${questionCount}</span>
                                    </p>
                                </div>
                            </div>
                            <button class="start-test-btn mt-6 w-full px-4 py-2.5 bg-indigo-600 text-white font-bold rounded-xl shadow-md hover:bg-indigo-700 transition-colors transform hover:scale-[1.01]" data-testid="${test.testId}">
                                Start AI Proctored Test
                            </button>
                        `;
                        testListDiv.appendChild(testElement);
                    });
                } catch (error) {
                    console.error('Error fetching tests:', error);
                    testListDiv.innerHTML = '<p class="text-red-500 col-span-full text-center">Could not load available tests.</p>';
                }
            }
            
            // --- FETCH STUDENT PROFILE ---
            async function fetchProfile() {
                try {
                    const response = await fetch('/api/student/profile', {
                        headers: { 'x-auth-token': token }
                    });
                    const data = await response.json();
                    profileImageUrl = data.profileImageUrl;
                } catch (error) {
                    console.error('Error fetching profile:', error);
                }
            }
            
            // --- EVENT LISTENERS ---
            userMenuButton.addEventListener('click', () => userMenu.classList.toggle('hidden'));
            logoutButton.addEventListener('click', logout);
            submitTestBtn.addEventListener('click', submitTest); // Changed to call a wrapper function
            
            testListDiv.addEventListener('click', async (e) => {
                if (e.target.classList.contains('start-test-btn')) {
                    const testId = e.target.dataset.testid;
                    currentTest = availableTests.find(t => t.testId === testId);
                    if (currentTest) {
                        openFaceVerification();
                    }
                }
            });

            verifyIdentityBtn.addEventListener('click', performFaceVerification);
            cancelVerificationBtn.addEventListener('click', closeFaceVerification);
            prevBtn.addEventListener('click', navigatePrev);
            nextBtn.addEventListener('click', navigateNext);
            
            closeWarningBtn.addEventListener('click', () => {
                audioWarningModal.classList.add('hidden');
                setTimeout(() => {
                    isAudioOnCooldown = false;
                }, 3000); // 3-second cooldown
            });

            document.addEventListener('contextmenu', event => {
                if (testInProgress) {
                    event.preventDefault();
                }
            });

            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            }

            // --- FACE VERIFICATION ---
            async function openFaceVerification() {
                if (!profileImageUrl) {
                    showAlert('You must have a profile picture to take a proctored test. Please upload one on your profile page.');
                    return;
                }
                document.getElementById('profile-image-verification').src = profileImageUrl;
                faceVerificationModal.classList.remove('hidden');
                try {
                    verificationStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    document.getElementById('verification-webcam').srcObject = verificationStream;
                } catch (err) {
                    showAlert('Could not access webcam. Please allow camera access to continue.');
                    closeFaceVerification();
                }
            }

            function closeFaceVerification() {
                faceVerificationModal.classList.add('hidden');
                if (verificationStream) {
                    verificationStream.getTracks().forEach(track => track.stop());
                    verificationStream = null;
                }
                verificationStatus.textContent = '';
                verifyIdentityBtn.disabled = false;
                verifyIdentityBtn.textContent = 'Verify My Identity';
            }

            async function performFaceVerification() {
                const video = document.getElementById('verification-webcam');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const webcamImage = canvas.toDataURL('image/jpeg');

                verifyIdentityBtn.disabled = true;
                verifyIdentityBtn.textContent = 'Verifying...';
                verificationStatus.textContent = 'Please wait...';
                verificationStatus.className = 'mt-4 text-sm font-medium text-blue-600';

                try {
                    const response = await fetch('/api/student/face-verification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify({ profileImageUrl, webcamImage })
                    });
                    
                    const result = await response.json();

                    if (response.ok && result.success) {
                        verificationStatus.textContent = 'Verification successful! Starting test...';
                        verificationStatus.className = 'mt-4 text-sm font-medium text-green-600';
                        setTimeout(() => {
                            closeFaceVerification();
                            startTest(currentTest);
                        }, 1500);
                    } else {
                        throw new Error(result.message || 'Face verification failed.');
                    }
                } catch (error) {
                    verificationStatus.textContent = `Verification Failed: ${error.message}`;
                    verificationStatus.className = 'mt-4 text-sm font-medium text-red-600';
                    verifyIdentityBtn.disabled = false;
                    verifyIdentityBtn.textContent = 'Try Again';
                }
            }

            // --- TEST LOGIC ---
            async function startTest(testData) {
                const consentMessage = 'This test requires AI proctoring.\n\n' +
                    'Your webcam and microphone will be activated to monitor for violations. Any violation will result in automatic test submission.\n\n' +
                    'This test will also start in fullscreen mode. Exiting fullscreen will submit the test.\n\n' +
                    'By proceeding, you agree to these terms.\n\n' +
                    'Are you ready to begin?';

                const proctoringConsent = await showModal(consentMessage);
                
                if (!proctoringConsent) {
                    return;
                }
                
                try {
                    await enterFullScreen(); 
                    
                    mainContent.classList.add('hidden');
                    testEnvironment.classList.remove('hidden');
                    testEnvironment.classList.add('fullscreen');
                    
                    await initializeProctoring();

                    studentAnswers = new Array(testData.questions.length).fill(null);
                    currentQuestionIndex = 0;
                    testInProgress = true;
                    lastViolationReason = null;
                    
                    document.getElementById('test-title').textContent = testData.title;
                    
                    startTimer(testData.duration * 60);
                    renderQuestion();
                    renderPalette();

                    document.addEventListener('fullscreenchange', handleFullScreenChange);
                    document.addEventListener('webkitfullscreenchange', handleFullScreenChange);
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                } catch (error) {
                    await exitFullScreen();
                    showAlert(`Failed to start the test.\nError: ${error.message}`);
                    mainContent.classList.remove('hidden');
                    testEnvironment.classList.add('hidden');
                }
            }

            async function submitTest() {
                if (window.isSubmitting) return;
                const shouldSubmit = await showModal('Are you sure you want to submit the test?');
                if (shouldSubmit) {
                    performSubmission('User submitted test manually');
                }
            }

            async function forceSubmitTest(reason) {
                if (window.isSubmitting) return;
                lastViolationReason = reason;
                await showAlert(`VIOLATION DETECTED: ${reason}. The test is being submitted automatically.`);
                performSubmission(reason);
            }

            async function performSubmission(reason = 'Unknown') {
                 if (window.isSubmitting) return;
                window.isSubmitting = true;

                saveAnswer(); 
                testInProgress = false;
                clearInterval(timerInterval);
                
                stopProctoring(); 
                
                await exitFullScreen();
                document.removeEventListener('fullscreenchange', handleFullScreenChange);
                document.removeEventListener('webkitfullscreenchange', handleFullScreenChange);
                document.removeEventListener('visibilitychange', handleVisibilityChange);
                
                const payload = {
                    testId: currentTest.testId,
                    answers: studentAnswers,
                    timeTaken: timeTaken,
                    violationReason: lastViolationReason || reason
                };

                try {
                    const response = await fetch('/api/student/submit-test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('Submission failed');
                    await showAlert('Test submitted successfully!');
                    window.location.href = '/student/dashboard.html';
                } catch (error) {
                    await showAlert('An error occurred during submission. Please contact your administrator.');
                    console.error('Submission Error:', error);
                }
            }

            function startTimer(duration) {
                let timer = duration;
                const timerDisplay = document.getElementById('timer');
                timerInterval = setInterval(() => {
                    timeTaken++;
                    let minutes = parseInt(timer / 60, 10);
                    let seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    timerDisplay.textContent = `${minutes}:${seconds}`;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        forceSubmitTest('Time Expired');
                    }
                }, 1000);
            }

            function renderQuestion() {
                if (!currentTest) return;
                const question = currentTest.questions[currentQuestionIndex];
                const questionContent = document.getElementById('question-content');
                let optionsHtml = '';
                const savedAnswer = studentAnswers[currentQuestionIndex];

                if (question.type === 'mcq-single') {
                    optionsHtml = question.options.map((opt, i) => `
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="q${currentQuestionIndex}" value="${i}" class="h-4 w-4 text-indigo-600 border-gray-300" ${savedAnswer == i ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700">${opt}</span>
                        </label>
                    `).join('');
                } else if (question.type === 'mcq-multiple') {
                        optionsHtml = question.options.map((opt, i) => `
                            <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" name="q${currentQuestionIndex}" value="${i}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" ${(savedAnswer && savedAnswer.includes(String(i))) ? 'checked' : ''}>
                                <span class="ml-3 text-gray-700">${opt}</span>
                            </label>
                        `).join('');
                } else { // fill-blank
                    optionsHtml = `<input type="text" name="q${currentQuestionIndex}" class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg" value="${savedAnswer || ''}">`;
                }

                questionContent.innerHTML = `
                    <p class="text-lg font-semibold mb-4">Question ${currentQuestionIndex + 1}:</p>
                    <p class="text-gray-800 mb-6">${question.text}</p>
                    <div class="space-y-3">${optionsHtml}</div>
                `;
                updateNavButtons();
                updatePalette();
            }

            function renderPalette() {
                const questionPalette = document.getElementById('question-palette');
                questionPalette.innerHTML = '';
                currentTest.questions.forEach((_, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'palette-btn h-10 w-10 flex items-center justify-center bg-gray-200 rounded hover:bg-gray-300';
                    btn.textContent = i + 1;
                    btn.dataset.index = i;
                    btn.addEventListener('click', () => {
                        saveAnswer();
                        currentQuestionIndex = i;
                        renderQuestion();
                    });
                    questionPalette.appendChild(btn);
                });
            }

            function updateNavButtons() {
                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.disabled = currentQuestionIndex === currentTest.questions.length - 1;
                prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
            }
            
            function updatePalette() {
                document.querySelectorAll('.palette-btn').forEach((btn, i) => {
                    btn.classList.remove('active', 'answered');
                    if (studentAnswers[i] !== null && (!Array.isArray(studentAnswers[i]) || studentAnswers[i].length > 0)) {
                        btn.classList.add('answered');
                    }
                    if (i === currentQuestionIndex) {
                        btn.classList.add('active');
                    }
                });
            }

            function saveAnswer() {
                if (!currentTest) return;
                const question = currentTest.questions[currentQuestionIndex];
                const inputs = document.getElementsByName(`q${currentQuestionIndex}`);
                if (question.type === 'mcq-single') {
                    const checked = Array.from(inputs).find(i => i.checked);
                    studentAnswers[currentQuestionIndex] = checked ? checked.value : null;
                } else if (question.type === 'mcq-multiple') {
                    const checked = Array.from(inputs).filter(i => i.checked).map(i => i.value);
                    studentAnswers[currentQuestionIndex] = checked.length > 0 ? checked : null;
                } else { // fill-blank
                    studentAnswers[currentQuestionIndex] = inputs[0].value.trim() ? inputs[0].value.trim() : null;
                }
            }

            function navigateNext() {
                if (currentQuestionIndex < currentTest.questions.length - 1) {
                    saveAnswer();
                    currentQuestionIndex++;
                    renderQuestion();
                }
            }

            function navigatePrev() {
                if (currentQuestionIndex > 0) {
                    saveAnswer();
                    currentQuestionIndex--;
                    renderQuestion();
                }
            }

            // --- AI PROCTORING & SECURITY (REVISED LOGIC) ---
            async function initializeProctoring() {
                const proctorContainer = document.getElementById('proctor-container');
                const proctorStatus = document.getElementById('proctor-status');
                const videoElement = document.getElementById('webcam');

                proctorStatus.textContent = 'Requesting camera & mic...';
                
                try {
                    proctoringStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    videoElement.srcObject = proctoringStream;
                    proctorContainer.classList.remove('hidden');
                    
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioSource = audioContext.createMediaStreamSource(proctoringStream);
                    audioProcessor = audioContext.createAnalyser();
                    audioProcessor.fftSize = 512;
                    audioSource.connect(audioProcessor);

                    proctorStatus.textContent = 'Loading AI models...';
                    [objectDetector, faceDetector] = await Promise.all([
                        cocoSsd.load(),
                        blazeface.load()
                    ]);
                    
                    proctorStatus.innerHTML = '<span class="text-green-400">Proctoring Active</span>';
                    proctoringEnabled = true;
                    runProctoring();
                } catch (err) {
                    console.error("Proctoring Error:", err);
                    stopProctoring();
                    throw new Error("Webcam/Mic access denied or AI models failed to load.");
                }
            }

            async function runProctoring() {
                if (!proctoringEnabled || window.isSubmitting) return;

                const videoElement = document.getElementById('webcam');
                const [objectPredictions, facePredictions] = await Promise.all([
                    objectDetector.detect(videoElement),
                    faceDetector.estimateFaces(videoElement, false)
                ]);

                // --- Audio check with cooldown ---
                if (!isAudioOnCooldown) {
                    const dataArray = new Uint8Array(audioProcessor.frequencyBinCount);
                    audioProcessor.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for (const amplitude of dataArray) {
                        sum += amplitude * amplitude;
                    }
                    const volume = Math.sqrt(sum / dataArray.length) / 100;

                    if (volume > AUDIO_LEVEL_THRESHOLD) {
                        isAudioOnCooldown = true; // Start cooldown immediately
                        audioViolationCount++;
                        if (audioViolationCount >= AUDIO_VIOLATION_LIMIT) {
                            return handleViolation('Excessive Noise Detected');
                        } else {
                            showAudioWarning();
                        }
                    }
                }

                // --- Multiple face check with counter ---
                if (facePredictions.length > 1) {
                    multipleFaceCounter++;
                    if (multipleFaceCounter > MULTIPLE_FACE_FRAME_LIMIT) {
                        return handleViolation('Multiple People Detected');
                    }
                } else {
                    multipleFaceCounter = 0;
                }
                
                // --- No face check ---
                if (facePredictions.length === 0) {
                    noFaceCounter++;
                    if (noFaceCounter > NO_FACE_FRAME_LIMIT) {
                        return handleViolation('User Not Present');
                    }
                } else {
                    noFaceCounter = 0;
                    // --- Looking away check (only if a face is present) ---
                    if (isLookingAway(facePredictions[0])) {
                        lookingAwayCounter++;
                        if (lookingAwayCounter > LOOKING_AWAY_FRAME_LIMIT) {
                            return handleViolation('Looking Away From Screen');
                        }
                    } else {
                        lookingAwayCounter = 0;
                    }
                }

                // --- Phone detection ---
                const phone = objectPredictions.find(p => p.class === 'cell phone');
                if (phone) {
                    if (phone.score > PHONE_SCORE_CLEAR) {
                        return handleViolation('Mobile Phone Detected');
                    }
                    if (phone.score > PHONE_SCORE_TRACE) {
                        phoneDetectionCount++;
                        if (phoneDetectionCount > PHONE_WARNING_THRESHOLD) {
                            return handleViolation('Repeated Phone Detection');
                        } else {
                            showWarning(`Phone Detected (${phoneDetectionCount}/${PHONE_WARNING_THRESHOLD + 1})`);
                        }
                    }
                }

                requestAnimationFrame(runProctoring);
            }

            function isLookingAway(face) {
                const leftEye = face.landmarks[0];
                const rightEye = face.landmarks[1];
                const nose = face.landmarks[2];
                const eyeMidpointX = (leftEye[0] + rightEye[0]) / 2;
                const horizontalDistance = Math.abs(nose[0] - eyeMidpointX);
                return horizontalDistance > LOOKING_AWAY_HORIZONTAL_THRESHOLD;
            }
            
            function showAudioWarning() {
                warningCountSpan.textContent = `Warning ${audioViolationCount} of ${AUDIO_VIOLATION_LIMIT}`;
                audioWarningModal.classList.remove('hidden');
            }

            function showWarning(message) {
                if (isWarningActive) return;
                isWarningActive = true;
                const proctorStatus = document.getElementById('proctor-status');
                const originalStatus = proctorStatus.innerHTML;
                proctorStatus.innerHTML = `<span class="text-yellow-400 font-bold">WARNING: ${message}</span>`;
                
                setTimeout(() => {
                    proctorStatus.innerHTML = originalStatus;
                    isWarningActive = false;
                }, 3000);
            }

            function handleViolation(reason) {
                if (!proctoringEnabled || window.isSubmitting) return; 
                
                proctoringEnabled = false; // Stop further checks
                lastViolationReason = reason;
                const proctorStatus = document.getElementById('proctor-status');
                proctorStatus.innerHTML = `<span class="text-red-500 font-bold">VIOLATION: ${reason}</span>`;
                
                setTimeout(() => {
                    forceSubmitTest(reason);
                }, 1500); // Short delay to show the reason
            }

            function stopProctoring() {
                proctoringEnabled = false;
                if (proctoringStream) {
                    proctoringStream.getTracks().forEach(track => track.stop());
                    proctoringStream = null;
                }
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                    audioContext = null;
                }
                const proctorContainer = document.getElementById('proctor-container');
                if(proctorContainer) proctorContainer.classList.add('hidden');
            }

            function handleFullScreenChange() {
                const isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
                if (!isFullScreen && testInProgress) {
                    handleViolation('Exited Full-Screen Mode');
                }
            }

            function handleVisibilityChange() {
                if (document.hidden && testInProgress) {
                    handleViolation('Switched to Another Tab/Window');
                }
            }

            function enterFullScreen() {
                const elem = document.documentElement;
                if (elem.requestFullscreen) return elem.requestFullscreen();
                if (elem.webkitRequestFullscreen) return elem.webkitRequestFullscreen();
                return Promise.resolve();
            }

            function exitFullScreen() {
                if (document.exitFullscreen && document.fullscreenElement) return document.exitFullscreen();
                if (document.webkitExitFullscreen && document.webkitFullscreenElement) return document.webkitExitFullscreen();
                return Promise.resolve();
            }
            
            await fetchAndDisplayTests();
            await fetchProfile();
        });
    </script>
</body>
</html>

