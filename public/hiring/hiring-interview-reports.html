<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Reports - HIRE WITH US</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar-link:hover { background-color: #4338CA; }
        .sidebar-link.active { background-color: #4F46E5; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png" alt="Logo">
                <span class="ml-3 text-2xl font-bold">HIRE WITH US</span>
            </div>
            <nav class="flex-grow p-4 overflow-y-auto" id="sidebar-nav"></nav>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-6 sticky top-0 z-10">
                <h1 id="page-title" class="text-2xl font-bold text-gray-800">Interview Reports</h1>
                <div id="user-menu-container"></div>
            </div>

            <!-- Main Content Area -->
            <div class="p-4 md:p-6 lg:p-8">
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b">
                        <h2 class="text-xl font-bold text-gray-900">Completed Interview Events</h2>
                    </div>
                    
                    <!-- Table Container -->
                    <div id="reports-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="reports-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event / Job</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Conducted</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Candidates</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Score</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reports-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Loading Row -->
                                <tr id="loading-row">
                                    <td colspan="5" class="px-6 py-6 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i> Loading reports...
                                    </td>
                                </tr>
                                <!-- No Data Row -->
                                <tr id="no-data-row" class="hidden">
                                    <td colspan="5" class="px-6 py-6 text-center text-gray-500">
                                        No completed interview reports found.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));

            // Page guard: Allow both 'Admin' and 'Hiring Moderator'
            if (!token || !user || (user.role !== 'Admin' && user.role !== 'Hiring Moderator')) {
                console.warn('Access denied. User role is not Admin or Hiring Moderator.');
                window.location.href = 'hiring-dashboard.html';
                return;
            }
            
            initializePage('Interview Reports');

            const tableBody = document.getElementById('reports-tbody');
            const loadingRow = document.getElementById('loading-row');
            const noDataRow = document.getElementById('no-data-row');

            async function fetchReports() {
                try {
                    // 1. Fetch all interview events created by this moderator
                    const eventsResponse = await fetch('/api/hiring/interview-events', {
                        headers: { 'x-auth-token': token }
                    });
                    if (!eventsResponse.ok) throw new Error('Failed to fetch interview events');
                    const events = await eventsResponse.json();

                    if (events.length === 0) {
                        loadingRow.classList.add('hidden');
                        noDataRow.classList.remove('hidden');
                        return;
                    }

                    // 2. Fetch detailed reports (evaluations) for each event in parallel
                    const reportPromises = events.map(event =>
                        fetch(`/api/hiring/interview-report/${event.eventId}`, {
                            headers: { 'x-auth-token': token }
                        }).then(res => res.json())
                    );
                    
                    const reports = await Promise.all(reportPromises);

                    // 3. Render the summary
                    renderReportTable(reports);

                } catch (error) {
                    console.error("Error fetching reports:", error);
                    tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-6 text-center text-red-500">Error loading reports: ${error.message}</td></tr>`;
                }
            }

            function renderReportTable(reports) {
                tableBody.innerHTML = ''; // Clear loading row

                if (reports.length === 0) {
                    noDataRow.classList.remove('hidden');
                    return;
                }

                reports.forEach(report => {
                    const event = report; // The API returns the event data with evaluations
                    const evaluations = event.evaluations || [];
                    
                    let totalScore = 0;
                    let validScores = 0;
                    
                    evaluations.forEach(ev => {
                        const score = parseFloat(ev.evaluation?.totalScore);
                        if (!isNaN(score)) {
                            totalScore += score;
                            validScores++;
                        }
                    });

                    const avgScore = validScores > 0 ? (totalScore / validScores).toFixed(1) : "N/A";
                    const scoreDisplay = avgScore !== "N/A" ? `${avgScore} / 10` : "N/A";
                    const candidateCount = evaluations.length;
                    
                    const eventName = event.eventName || 'Unnamed Event';
                    const jobTitle = event.jobTitle || 'N/A';
                    // Use the eventId from the parent event object
                    const eventId = event.PK || event.eventId;
                    const createdAt = event.createdAt || new Date().toISOString();

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${eventName}</div>
                            <div class="text-sm text-gray-500">${jobTitle}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${new Date(createdAt).toLocaleDateString()}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-600">${candidateCount}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold ${avgScore >= 7 ? 'text-green-700' : (avgScore >= 5 ? 'text-yellow-700' : 'text-red-700')}">
                                ${scoreDisplay}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="hiring-report-details.html?eventId=${eventId}" class="text-indigo-600 hover:text-indigo-900">View Details</a>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            // Initial load
            fetchReports();
        });
    </script>
</body>
</html>
