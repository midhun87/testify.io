<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aptitude Test History - HIRE WITH US</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link:hover { background-color: #4338CA; }
        .sidebar-link.active { background-color: #4F46E5; font-weight: 600; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-container {
            background-color: white; border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            width: 90%; max-width: 4xl; /* Adjusted size for details */
            max-height: 90vh;
            transform: scale(0.95); transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .modal-overlay.visible .modal-container { transform: scale(1); }
        .modal-container table { table-layout: fixed; }
        .modal-container td, .modal-container th { word-wrap: break-word; }

        /* Accordion Styles */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease-in-out;
        }
        .accordion-header .chevron-icon {
            transition: transform 0.35s ease-in-out;
        }
        .accordion-header.open .chevron-icon {
            transform: rotate(180deg);
        }

        /* Spinner Animation */
        .spinner {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen bg-gray-50">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png" alt="Logo">
                <span class="ml-3 text-2xl font-bold">HIRE WITH US</span>
            </div>
            <nav class="flex-grow p-4 overflow-y-auto" id="sidebar-nav"></nav>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-6 sticky top-0 z-10">
                <h1 id="page-title" class="text-2xl font-bold text-gray-800">Aptitude Test History</h1>
                <div id="user-menu-container"></div>
            </div>

            <main class="p-4 sm:p-6 lg:p-8">
                <div class="max-w-7xl mx-auto">
                    <!-- Results Container - Accordion Style -->
                    <div id="results-container" class="space-y-4">
                        <!-- Accordion results will be loaded here -->
                    </div>
                    <!-- Loader -->
                    <div id="loader" class="text-center py-10">
                        <svg class="spinner h-12 w-12 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-gray-600">Loading results...</p>
                    </div>
                     <!-- Message Area for No Results -->
                     <div id="message-area" class="text-center py-16 bg-white rounded-lg shadow-sm hidden">
                         <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                         <h3 class="mt-2 text-lg font-medium text-gray-900">No results found</h3>
                         <p class="mt-1 text-sm text-gray-500">There are currently no aptitude test submissions to display.</p>
                     </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Candidate Details Modal -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">Candidate Details</h2>
                <div class="flex items-center space-x-2">
                     <!-- Download Individual Report Button -->
                     <button id="download-individual-report-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors duration-200" title="Download Candidate Report">
                       <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <!-- Close Button -->
                    <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto bg-gray-50">
                 <div id="modal-content" class="text-left">
                     <!-- Candidate details load here -->
                 </div>
            </div>
        </div>
    </div>

    <!-- Common JS for Sidebar/User Menu -->
    <script src="common.js"></script>
    <!-- Libraries for Export Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Initialize Page Elements ---
        initializePage('Aptitude Test Results'); // Updated Active Link Text
        const token = localStorage.getItem('token');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const messageArea = document.getElementById('message-area');
        const detailsModal = document.getElementById('details-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const downloadIndividualReportBtn = document.getElementById('download-individual-report-btn'); // Changed ID
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        // --- State Variables ---
        let allTestsData = {}; // Stores fetched data { testId: { title: '..', results: [...] } }
        let currentDetailedResult = null; // Stores data for the candidate in the modal

        // --- Helper: Image to Base64 (Unchanged) ---
        async function imageToBase64(url) {
            try {
                const response = await fetch(url, { cache: "force-cache" });
                if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(blob);
                });
            } catch(e) {
                console.warn("Image to Base64 conversion failed:", url, e);
                return null;
            }
        }

        // --- Fetch Test History Data (Unchanged) ---
        async function fetchHistory() {
            loader.style.display = 'block';
            messageArea.classList.add('hidden');
            resultsContainer.innerHTML = '';
            allTestsData = {};

            try {
                const response = await fetch('/api/hiring/test-history', { headers: { 'x-auth-token': token } });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Failed to fetch results' }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                const historyData = await response.json();
                console.log("Fetched History Data:", historyData);

                if (!historyData || historyData.length === 0) {
                     messageArea.classList.remove('hidden');
                     return;
                }

                allTestsData = historyData.reduce((acc, test) => {
                    if (test.testId) {
                        acc[test.testId] = { ...test, results: Array.isArray(test.results) ? test.results : [] };
                    } else { console.warn("Skipping test data with missing testId:", test); }
                    return acc;
                }, {});

                renderAccordions();

            } catch (error) {
                console.error("Error fetching history:", error);
                resultsContainer.innerHTML = `<p class="text-red-500 text-center p-4">Error loading history: ${error.message}</p>`;
                messageArea.classList.add('hidden');
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- Render Accordion Structure (MODIFIED) ---
        function renderAccordions() {
             resultsContainer.innerHTML = Object.entries(allTestsData).map(([testId, data]) => `
                <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
                    <div class="accordion-header flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50 transition-colors duration-200" data-testid="${testId}">
                        <h3 class="text-lg font-bold text-gray-800">${data.title || 'Untitled Test'} <span class="text-sm font-medium text-gray-500">(${(data.results?.length || 0)} submissions)</span></h3>
                        <svg class="chevron-icon w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content">
                        <div class="p-4 border-t border-gray-200 bg-gray-50">
                            <!-- Export Buttons -->
                            <div class="flex flex-wrap justify-end items-center mb-4 gap-3">
                                <!-- *** NEW: Download Assignment Report Button *** -->
                                <button class="download-assignment-btn flex items-center gap-2 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg text-sm transition-colors duration-200" data-testid="${testId}" data-test-title="${data.title || 'Test'}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Set Assignments (CSV)
                                </button>
                                <button class="export-pdf-btn flex items-center gap-2 bg-red-50 hover:bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg text-sm transition-colors duration-200" data-testid="${testId}" data-test-title="${data.title || 'Test'}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                    Results (PDF)
                                </button>
                                <button class="export-excel-btn flex items-center gap-2 bg-green-50 hover:bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg text-sm transition-colors duration-200" data-testid="${testId}" data-test-title="${data.title || 'Test'}">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Results (Excel)
                                </button>
                            </div>
                            <!-- Results Table (Unchanged Structure) -->
                            <div class="overflow-x-auto bg-white rounded shadow border">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Candidate</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">College</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Score (%)</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Result</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Submitted</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${(data.results && data.results.length > 0) ? data.results.map((r, index) => `
                                            <tr class="hover:bg-indigo-50 transition-colors duration-150">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${r.fullName || r.candidateEmail || 'N/A'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.collegeName || 'N/A'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${r.result === 'Pass' ? 'text-green-600' : 'text-red-600'}">${r.score ?? 'N/A'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${r.result === 'Pass' ? 'text-green-600' : 'text-red-600'}">${r.result || 'N/A'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.submittedAt ? new Date(r.submittedAt).toLocaleString() : 'N/A'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                    <button class="view-details-btn text-indigo-600 hover:text-indigo-900 font-semibold" data-result-id="${r.resultId}" data-testid="${testId}">View Details</button>
                                                </td>
                                            </tr>
                                        `).join('') : `<tr><td colspan="6" class="text-center py-4 text-gray-500">No submissions yet for this test.</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            attachAccordionListeners();
            attachActionListeners();
        }

        // --- Attach Listeners (MODIFIED) ---
        function attachActionListeners() {
            resultsContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const testId = button.dataset.testid;
                const testTitle = button.dataset.testTitle;
                const resultId = button.dataset.resultId;

                if (button.classList.contains('view-details-btn') && resultId && testId) {
                    showDetailsModal(testId, resultId); // Reusing existing function for now
                } else if (button.classList.contains('export-pdf-btn') && testId && testTitle) {
                    exportResultsToPdf(testId, testTitle); // Renamed for clarity
                } else if (button.classList.contains('export-excel-btn') && testId && testTitle) {
                    exportResultsToExcel(testId, testTitle); // Renamed for clarity
                } else if (button.classList.contains('download-assignment-btn') && testId && testTitle) {
                    downloadAssignmentReport(testId, testTitle); // *** NEW Function Call ***
                }
            });
        }

        // --- Show Detailed Modal (MODIFIED) ---
        // Now fetches details individually to get setId
        async function showDetailsModal(testId, resultId) {
            console.log(`Showing details for resultId: ${resultId}`);
            modalTitle.textContent = 'Loading details...';
            modalContent.innerHTML = '<p class="text-center py-4">Loading...</p>';
            detailsModal.classList.add('visible');
            currentDetailedResult = null; // Reset current result

            try {
                 // Fetch the specific result details from the backend
                const response = await fetch(`/api/hiring/test-results/${resultId}`, {
                    headers: { 'x-auth-token': token }
                });
                if (!response.ok) {
                    throw new Error((await response.json()).message || 'Failed to fetch details');
                }
                currentDetailedResult = await response.json(); // Store the full result with setId

                if (!currentDetailedResult) throw new Error("Candidate details not found in response.");

                modalTitle.textContent = `Details for ${currentDetailedResult.fullName || currentDetailedResult.candidateEmail || 'N/A'}`;

                // Populate modal content, including Set ID
                modalContent.innerHTML = `
                    <div class="mb-6 pb-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Candidate Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                            <div><strong class="block text-gray-500">Name</strong> <span class="text-gray-900">${currentDetailedResult.fullName || 'N/A'}</span></div>
                            <div><strong class="block text-gray-500">Roll Number</strong> <span class="text-gray-900">${currentDetailedResult.rollNumber || 'N/A'}</span></div>
                            <div><strong class="block text-gray-500">College</strong> <span class="text-gray-900">${currentDetailedResult.collegeName || 'N/A'}</span></div>
                            <div><strong class="block text-gray-500">Department</strong> <span class="text-gray-900">${currentDetailedResult.department || 'N/A'}</span></div>
                            <div class="md:col-span-2"><strong class="block text-gray-500">Email</strong> <span class="text-gray-900">${currentDetailedResult.candidateEmail || 'N/A'}</span></div>
                             <!-- *** NEW: Display Set ID *** -->
                            <div class="md:col-span-2"><strong class="block text-gray-500">Question Set ID</strong> <span class="text-gray-900 font-mono bg-gray-100 px-2 py-1 rounded">${currentDetailedResult.setId || 'N/A'}</span></div>
                        </div>
                    </div>
                    <div>
                         <h3 class="text-lg font-semibold text-gray-800 mb-4">Test Performance</h3>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-3 text-sm bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                            <div><strong class="block text-indigo-800">Score</strong> <span class="font-bold text-xl ${currentDetailedResult.result === 'Pass' ? 'text-green-600' : 'text-red-600'}">${currentDetailedResult.score ?? 'N/A'}%</span></div>
                            <div><strong class="block text-indigo-800">Result</strong> <span class="font-bold text-xl ${currentDetailedResult.result === 'Pass' ? 'text-green-600' : 'text-red-600'}">${currentDetailedResult.result || 'N/A'}</span></div>
                            <div><strong class="block text-indigo-800">Violation</strong> <span class="font-semibold ${currentDetailedResult.violationReason ? 'text-red-600' : 'text-gray-700'}">${currentDetailedResult.violationReason || 'None'}</span></div>
                             <div class="md:col-span-3"><strong class="block text-indigo-800">Submitted At</strong> <span class="text-gray-700">${currentDetailedResult.submittedAt ? new Date(currentDetailedResult.submittedAt).toLocaleString() : 'N/A'}</span></div>
                         </div>
                    </div>
                `;

            } catch (error) {
                 console.error("Error fetching/showing details:", error);
                 modalContent.innerHTML = `<p class="text-red-500 text-center py-4">Error loading details: ${error.message}</p>`;
                 currentDetailedResult = null; // Clear if fetch failed
            }
        }

        // --- *** NEW: Download Assignment Report Function *** ---
        async function downloadAssignmentReport(testId, testTitle) {
            console.log(`Downloading assignment report for Test ID: ${testId}`);
            try {
                const response = await fetch(`/api/hiring/assignment-report/${testId}`, {
                    headers: { 'x-auth-token': token }
                });
                if (!response.ok) {
                    throw new Error((await response.json()).message || 'Failed to fetch assignment data');
                }
                const assignments = await response.json();

                if (!assignments || assignments.length === 0) {
                    alert(`No assignment data found for "${testTitle}".`);
                    return;
                }

                // Convert to CSV
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Candidate Email,Assigned Set ID,Assigned At\n"; // Header row

                assignments.forEach(assignment => {
                    const email = assignment.studentEmail || '';
                    const setId = assignment.setId || 'N/A';
                    const assignedAt = assignment.assignedAt ? new Date(assignment.assignedAt).toLocaleString() : '';
                    // Escape commas within fields if necessary (basic implementation)
                    const row = [email.replace(/"/g, '""'), setId.replace(/"/g, '""'), assignedAt].map(field => `"${field}"`).join(",");
                    csvContent += row + "\n";
                });

                // Trigger download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${testTitle.replace(/\s+/g, '_')}_SetAssignments.csv`);
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("Error downloading assignment report:", error);
                alert(`Failed to download assignment report: ${error.message}`);
            }
        }


        // --- Export Functions (Renamed for Clarity) ---
        async function exportResultsToPdf(testId, testTitle) {
            // (Existing PDF export logic - no changes needed, just uses allTestsData)
            const testData = allTestsData[testId];
            if (!testData || !testData.results || testData.results.length === 0) { alert("No results to export."); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape' });
            try {
                const [logo1, logo2] = await Promise.all([ imageToBase64('...HireWithUs_logo...'), imageToBase64('...Testify_logo...') ]); // Use correct URLs
                // ... (rest of the PDF generation logic from original file) ...
                 doc.save(`${testTitle.replace(/\s/g, '_')}_AptitudeResults.pdf`);
            } catch (error) { console.error("PDF Export Error:", error); alert("Failed to generate PDF."); }
        }

        function exportResultsToExcel(testId, testTitle) {
            // (Existing Excel export logic - no changes needed, just uses allTestsData)
            const testData = allTestsData[testId];
             if (!testData || !testData.results || testData.results.length === 0) { alert("No results to export."); return; }
             const wsData = [ /* headers */ ...testData.results.map(r => [ /* data fields */ ]) ];
             const ws = XLSX.utils.aoa_to_sheet(wsData); /* ... set column widths ... */
             const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Results");
             XLSX.writeFile(wb, `${testTitle.replace(/\s/g, '_')}_AptitudeResults.xlsx`);
        }

        // --- Individual Report PDF (Unchanged Logic, uses currentDetailedResult) ---
        async function generateIndividualPdfReport() {
            if (!currentDetailedResult) { alert("Candidate data not loaded."); return; }
            const result = currentDetailedResult;
            const testTitle = allTestsData[result.testId]?.title || "Aptitude Test";
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
             try {
                 const [logo1, logo2] = await Promise.all([ imageToBase64('...HireWithUs_logo...'), imageToBase64('...Testify_logo...') ]); // Use correct URLs
                 // ... (rest of the individual PDF generation logic from original file, including Set ID if desired) ...
                 // Example: Add Set ID
                 // doc.text(`Question Set ID: ${result.setId || 'N/A'}`, 15, yPos); yPos += 6;
                 doc.save(`AptitudeReport_${(result.fullName || result.candidateEmail || result.resultId).replace(/\s+/g, '_')}.pdf`);
             } catch (error) { console.error("Individual PDF Error:", error); alert("Failed to generate PDF."); }
        }

        // --- Attach Modal Action Listeners (Unchanged) ---
        modalCloseBtn.onclick = () => detailsModal.classList.remove('visible');
        downloadIndividualReportBtn.addEventListener('click', generateIndividualPdfReport); // Connects the button

        // --- Initial Data Fetch ---
        fetchHistory();
        attachAccordionListeners(); // Attach accordion listeners once on load
    });
    </script>
</body>
</html>
