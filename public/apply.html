<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Job - Testify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
        <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png">

    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .form-step {
            display: none;
            animation: fadeIn 0.5s;
        }
        .form-step.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom file input styles */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-button {
            border: 2px dashed #cbd5e1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .file-input-wrapper:hover .file-input-button {
            background-color: #f8fafc;
            border-color: #4f46e5;
        }
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
             <div class="flex items-center space-x-3">
                <img src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1758718248/EduDevelopers_logo_m1h9db.png" alt="EduDevelopers Logo" class="h-10 w-auto">
                <span class="text-2xl font-bold text-gray-800">EduDevelopers</span>
            </div>
             <div>
                 <a href="careers.html" class="text-gray-600 hover:text-indigo-600 font-medium px-4">All Jobs</a>
                 <a href="my-applications.html" class="text-gray-600 hover:text-indigo-600 font-medium">My Applications</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-12">
        <div class="max-w-5xl mx-auto">
            <div id="page-loader" class="text-center p-12">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-4 text-gray-600">Loading Application...</p>
            </div>
            
            <div id="application-content" class="hidden">
                 <div class="text-center mb-10">
                    <h1 id="page-title" class="text-3xl font-bold text-gray-900">Job Application</h1>
                    <p id="job-title-header" class="mt-2 text-lg text-indigo-600 font-semibold">Loading...</p>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <!-- Progress Bar -->
                    <div id="progress-bar" class="flex justify-between items-center mb-12">
                        <!-- Step indicators will be injected here -->
                    </div>
                    
                    <form id="application-form" class="space-y-8">
                        <!-- Form steps will be injected here -->
                        <div id="form-feedback" class="text-sm pt-4"></div>
                        <!-- Navigation Buttons -->
                        <div id="navigation-buttons" class="pt-6 border-t flex justify-between items-center">
                            <button type="button" id="prev-btn" class="text-gray-700 bg-gray-200 hover:bg-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Previous</button>
                            <button type="button" id="next-btn" class="text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Next Step</button>
                            <button type="submit" id="submit-button" class="hidden w-full md:w-auto text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-lg px-8 py-3 text-center">Submit Application</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const pageLoader = document.getElementById('page-loader');
            const applicationContent = document.getElementById('application-content');
            const applicationForm = document.getElementById('application-form');
            const jobTitleHeader = document.getElementById('job-title-header');
            const pageTitle = document.getElementById('page-title');
            const formFeedback = document.getElementById('form-feedback');
            
            const progressBar = document.getElementById('progress-bar');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitButton = document.getElementById('submit-button');

            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('jobId');
            const applicationId = urlParams.get('applicationId');
            const isEditMode = !!applicationId;

            let currentStep = 0;
            const steps = ["Personal Details", "Education", "Experience", "Links & Documents"];

            function renderFormHTML() {
                applicationForm.insertAdjacentHTML('afterbegin', `
                    <!-- Step 1: Personal Details -->
                    <div class="form-step active" data-step="0">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">1. Personal Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="firstName" class="block mb-2 text-sm font-medium text-gray-700">First Name</label><input type="text" name="firstName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                            <div><label for="lastName" class="block mb-2 text-sm font-medium text-gray-700">Last Name</label><input type="text" name="lastName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                            <div><label for="email" class="block mb-2 text-sm font-medium text-gray-700">Email Address</label><input type="email" name="email" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required ${isEditMode ? 'readonly class="bg-gray-200 cursor-not-allowed"' : ''}></div>
                            <div><label for="phone" class="block mb-2 text-sm font-medium text-gray-700">Mobile Number</label><input type="tel" name="phone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        </div>
                    </div>
                    <!-- Step 2: Education -->
                    <div class="form-step" data-step="1">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">2. Educational Details</h2>
                        <div class="space-y-6">
                            <div><h3 class="font-medium text-gray-700">10th Grade</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2"><input type="text" name="edu_10_institute" placeholder="Institute" class="bg-gray-50 border p-2.5 rounded-md" required><input type="text" name="edu_10_score" placeholder="Score %" class="bg-gray-50 border p-2.5 rounded-md" required><input type="number" name="edu_10_year" placeholder="Year" class="bg-gray-50 border p-2.5 rounded-md" required></div></div>
                            <div><h3 class="font-medium text-gray-700">12th Grade</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2"><input type="text" name="edu_12_institute" placeholder="Institute" class="bg-gray-50 border p-2.5 rounded-md" required><input type="text" name="edu_12_score" placeholder="Score %" class="bg-gray-50 border p-2.5 rounded-md" required><input type="number" name="edu_12_year" placeholder="Year" class="bg-gray-50 border p-2.5 rounded-md" required></div></div>
                            <div><h3 class="font-medium text-gray-700">Bachelor's Degree</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2"><input type="text" name="edu_btech_institute" placeholder="Institute" class="bg-gray-50 border p-2.5 rounded-md" required><input type="text" name="edu_btech_score" placeholder="Score %" class="bg-gray-50 border p-2.5 rounded-md" required><input type="number" name="edu_btech_year" placeholder="Year" class="bg-gray-50 border p-2.5 rounded-md" required></div></div>
                            <div><h3 class="font-medium text-gray-700">Higher Degree (Optional)</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2"><input type="text" name="edu_higher_institute" placeholder="Institute" class="bg-gray-50 border p-2.5 rounded-md"><input type="text" name="edu_higher_score" placeholder="Score %" class="bg-gray-50 border p-2.5 rounded-md"><input type="number" name="edu_higher_year" placeholder="Year" class="bg-gray-50 border p-2.5 rounded-md"></div></div>
                        </div>
                    </div>
                    <!-- Step 3: Experience -->
                    <div class="form-step" data-step="2">
                        <h2 class="text-2xl font-semibold mb-6">3. Professional Experience</h2>
                        <div id="experience-container" class="space-y-6"></div>
                        <button type="button" id="add-experience" class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-800">+ Add Experience</button>
                    </div>
                    <!-- Step 4: Links & Documents -->
                    <div class="form-step" data-step="3">
                        <h2 class="text-2xl font-semibold mb-6">4. Links & Documents</h2>
                        <div class="space-y-6">
                             <div><h3 class="font-medium text-gray-700">Professional Links</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-2"><div><label for="linkedinUrl" class="block mb-2 text-sm">LinkedIn URL</label><input type="url" name="linkedinUrl" id="linkedinUrl" class="bg-gray-50 border p-2.5 w-full rounded-md"></div><div><label for="githubUrl" class="block mb-2 text-sm">GitHub URL</label><input type="url" name="githubUrl" id="githubUrl" class="bg-gray-50 border p-2.5 w-full rounded-md"></div><div><label for="portfolioUrl" class="block mb-2 text-sm">Portfolio URL</label><input type="url" name="portfolioUrl" id="portfolioUrl" class="bg-gray-50 border p-2.5 w-full rounded-md"></div></div></div>
                             <div><h3 class="font-medium text-gray-700">Upload Documents</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                                <div><label for="passportPhoto" class="block mb-2 text-sm">Passport Photo</label><div class="file-input-wrapper w-full"><div id="passportPhoto-ui" class="file-input-button rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg><span class="font-medium text-indigo-600">Click to upload</span><span id="passportPhoto-info" class="text-xs text-gray-500 mt-1">JPG, PNG (Max 2MB)</span></div><input type="file" name="passportPhoto" id="passportPhoto" class="file-input" accept="image/jpeg, image/png"></div></div>
                                <div><label for="resume" class="block mb-2 text-sm">Resume/CV</label><div class="file-input-wrapper w-full"><div id="resume-ui" class="file-input-button rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg><span class="font-medium text-indigo-600">Click to upload</span><span id="resume-info" class="text-xs text-gray-500 mt-1">PDF, DOCX (Max 5MB)</span></div><input type="file" name="resume" id="resume" class="block w-full text-sm border cursor-pointer bg-gray-50" accept=".pdf,.doc,.docx"></div></div>
                                <div><label for="proofs" class="block mb-2 text-sm">Proofs & Certificates</label><div class="file-input-wrapper w-full"><div id="proofs-ui" class="file-input-button rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span class="font-medium text-indigo-600">Click to upload</span><span id="proofs-info" class="text-xs text-gray-500 mt-1">Upload multiple files</span></div><input type="file" name="proofs" id="proofs" class="block w-full text-sm border cursor-pointer bg-gray-50" multiple accept=".pdf,.jpg,.png"></div></div>
                             </div></div>
                        </div>
                    </div>
                `);
                
                // Add file upload listeners
                ['passportPhoto', 'resume', 'proofs'].forEach(id => {
                    const input = document.getElementById(id);
                    const infoEl = document.getElementById(`${id}-info`);
                    input.addEventListener('change', () => {
                        if(input.files.length > 0) {
                             infoEl.textContent = `${input.files.length} file(s) selected`;
                             infoEl.classList.add('text-green-600', 'font-semibold');
                        } else {
                            infoEl.textContent = infoEl.dataset.defaultText;
                            infoEl.classList.remove('text-green-600', 'font-semibold');
                        }
                    });
                     infoEl.dataset.defaultText = infoEl.textContent;
                });
            }

            function updateProgressBar() {
                progressBar.innerHTML = '';
                steps.forEach((step, index) => {
                    let stateClasses = 'text-gray-500 border-gray-300';
                    if (index < currentStep) {
                        stateClasses = 'text-green-600 border-green-600';
                    } else if (index === currentStep) {
                        stateClasses = 'text-indigo-600 border-indigo-600';
                    }
                    
                    progressBar.innerHTML += `
                        <div class="flex-1 text-center">
                            <div class="w-10 h-10 mx-auto border-2 ${stateClasses} rounded-full flex items-center justify-center font-bold">
                                ${index < currentStep ? '&#10003;' : index + 1}
                            </div>
                            <p class="text-xs mt-2 ${index === currentStep ? 'font-semibold text-indigo-600' : 'text-gray-500'}">${step}</p>
                        </div>
                        ${index < steps.length - 1 ? '<div class="flex-1 border-t-2 border-gray-300 mx-4"></div>' : ''}
                    `;
                });
            }

            function showStep(stepIndex) {
                document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
                document.querySelector(`.form-step[data-step="${stepIndex}"]`).classList.add('active');
                currentStep = stepIndex;
                updateProgressBar();

                prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-block';
                nextBtn.style.display = currentStep === steps.length - 1 ? 'none' : 'inline-block';
                submitButton.style.display = currentStep === steps.length - 1 ? 'inline-block' : 'none';
                 document.getElementById('navigation-buttons').classList.toggle('justify-end', currentStep === 0);
                 document.getElementById('navigation-buttons').classList.toggle('justify-between', currentStep > 0);
            }
            
            function validateStep(stepIndex) {
                const currentStepElement = document.querySelector(`.form-step[data-step="${stepIndex}"]`);
                const inputs = currentStepElement.querySelectorAll('input[required], textarea[required]');
                let isValid = true;
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('border-red-500');
                        isValid = false;
                    } else {
                        input.classList.remove('border-red-500');
                    }
                });
                if (!isValid) {
                     formFeedback.innerHTML = `<div class="p-3 text-red-800 bg-red-100 rounded-lg">Please fill all required fields in this step.</div>`;
                } else {
                    formFeedback.innerHTML = '';
                }
                return isValid;
            }

            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep) && currentStep < steps.length - 1) {
                    showStep(currentStep + 1);
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    showStep(currentStep - 1);
                }
            });
            
            function addExperienceField(exp = { title: '', company: '', description: '' }) {
                const container = document.getElementById('experience-container');
                const div = document.createElement('div');
                div.className = 'p-4 border rounded-lg bg-gray-50 relative';
                div.innerHTML = `
                    <button type="button" class="absolute top-2 right-2 text-gray-400 hover:text-red-600" onclick="this.parentElement.remove()">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="exp_title" placeholder="Job Title" class="bg-white border p-2.5 rounded-md" value="${exp.title || ''}">
                        <input type="text" name="exp_company" placeholder="Company" class="bg-white border p-2.5 rounded-md" value="${exp.company || ''}">
                    </div>
                    <textarea name="exp_desc" placeholder="Responsibilities..." rows="3" class="mt-3 block p-2.5 w-full bg-white border rounded-md">${exp.description || ''}</textarea>
                `;
                container.appendChild(div);
            }
            
            async function initialize() {
                renderFormHTML();
                document.getElementById('add-experience').addEventListener('click', () => addExperienceField());
                
                if (isEditMode) {
                    pageTitle.textContent = 'Edit Your Application';
                } else {
                    const jobTitle = urlParams.get('jobTitle');
                    jobTitleHeader.textContent = `For the role of ${jobTitle || '...'}`;
                    addExperienceField(); // Add one empty experience block for new applications
                }

                showStep(0); // Initialize first step
                pageLoader.classList.add('hidden');
                applicationContent.classList.remove('hidden');
                applicationForm.addEventListener('submit', handleFormSubmit);
            }
            
            async function handleFormSubmit(e) {
                e.preventDefault();
                if (!validateStep(currentStep)) return;

                submitButton.disabled = true;
                submitButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 inline" viewBox="0 0 24 24"></svg> Submitting...`;
                formFeedback.innerHTML = '';

                const formData = new FormData(applicationForm);
                const experiences = [];
                document.querySelectorAll('#experience-container > div').forEach(expDiv => {
                    const title = expDiv.querySelector('[name="exp_title"]').value;
                    const company = expDiv.querySelector('[name="exp_company"]').value;
                    const description = expDiv.querySelector('[name="exp_desc"]').value;
                    if(title && company) {
                        experiences.push({ title, company, description });
                    }
                });

                formData.append('experiences', JSON.stringify(experiences));
                
                formData.delete('exp_title');
                formData.delete('exp_company');
                formData.delete('exp_desc');

                const url = isEditMode ? `/api/careers/application/${applicationId}` : `/api/careers/apply/${jobId}`;
                const method = isEditMode ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, { method, body: formData });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    
                    formFeedback.innerHTML = `<div class="p-4 text-green-800 bg-green-100 rounded-lg">${result.message}</div>`;
                    if (!isEditMode) applicationForm.reset();
                    setTimeout(() => window.location.href = 'my-applications.html', 2000);

                } catch (error) {
                    formFeedback.innerHTML = `<div class="p-4 text-red-800 bg-red-100 rounded-lg">Error: ${error.message}</div>`;
                } finally {
                    submitButton.disabled = false;
                     submitButton.innerHTML = isEditMode ? 'Update Application' : 'Submit Application';
                }
            }
            
            initialize();
        });
    </script>
</body>
</html>
