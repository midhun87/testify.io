<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Certificate Moderators</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-6">Manage Certificate Moderators</h1>

        <!-- Create Moderator Form -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">Create New Moderator Account</h2>
            <form id="create-moderator-form" class="space-y-4">
                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Create Account
                </button>
            </form>
        </div>

        <!-- Moderator List -->
        <div>
            <h2 class="text-xl font-semibold mb-4">Existing Moderators</h2>
            <div id="moderator-list" class="bg-white rounded-lg shadow-md overflow-hidden">
                <!-- List will be populated here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('create-moderator-form');
            const listContainer = document.getElementById('moderator-list');
            const token = localStorage.getItem('token');

            if (!token) {
                window.location.href = '/admin/login.html'; // Or your main admin login
                return;
            }

            async function fetchModerators() {
                try {
                    const response = await fetch('/api/admin/certificate-moderators', {
                        headers: { 'x-auth-token': token }
                    });
                    if (!response.ok) throw new Error('Failed to fetch moderators.');
                    const moderators = await response.json();
                    renderModerators(moderators);
                } catch (error) {
                    console.error(error);
                    listContainer.innerHTML = `<p class="p-4 text-red-500">Error loading moderators.</p>`;
                }
            }

            function renderModerators(moderators) {
                if (moderators.length === 0) {
                    listContainer.innerHTML = `<p class="p-4 text-gray-500">No certificate moderators found.</p>`;
                    return;
                }
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${moderators.map(mod => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${mod.fullName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mod.email}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button data-email="${mod.email}" class="delete-btn text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                listContainer.innerHTML = '';
                listContainer.appendChild(table);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullName = document.getElementById('fullName').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    const response = await fetch('/api/admin/certificate-moderators', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                        body: JSON.stringify({ fullName, email, password })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    alert('Moderator created successfully!');
                    form.reset();
                    fetchModerators();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            });

            listContainer.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const email = e.target.dataset.email;
                    if (confirm(`Are you sure you want to delete the moderator account for ${email}?`)) {
                        try {
                            const response = await fetch(`/api/admin/certificate-moderators/${email}`, {
                                method: 'DELETE',
                                headers: { 'x-auth-token': token }
                            });
                            if (!response.ok) throw new Error('Failed to delete.');
                            alert('Account deleted.');
                            fetchModerators();
                        } catch (error) {
                            alert('Error deleting account.');
                        }
                    }
                }
            });

            fetchModerators();
        });
    </script>
</body>
</html>
