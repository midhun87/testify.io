<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Student Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { background-color: #111827; }
        .sidebar-link { color: #D1D5DB; }
        .sidebar-link:hover { background-color: #374151; color: #FFFFFF; }
        .sidebar-link.active { background-color: #4F46E5; color: #FFFFFF; font-weight: 600; }
        .sidebar-heading {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #9CA3AF;
            text-transform: uppercase;
        }
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .printable-area {
                box-shadow: none !important;
                border: none !important;
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-64 bg-gray-800 text-white min-h-screen p-4 flex-col no-print">
            <div class="flex items-center justify-center h-16 border-b border-gray-700 mb-4">
                 <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png" alt="TESTIFY Logo">
                 <span class="ml-3 text-2xl font-bold">TESTIFY</span>
            </div>
            <nav class="flex-grow overflow-y-auto">
                <a href="dashboard.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span>Dashboard</span>
                </a>

                <div class="sidebar-heading mt-4">User Management</div>
                <a href="add-college.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A11.953 11.953 0 0112 13.5c-2.998 0-5.74-1.1-7.843-2.918" /></svg>
                    <span>Colleges</span>
                </a>
                <a href="admin-students.html" class="sidebar-link active flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 001.13-1.897L16.863 4.487M16.863 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487z" /></svg>
                    <span>Students</span>
                </a>

                <div class="sidebar-heading mt-4">Course Management</div>
                <a href="create-course.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path></svg>
                    <span>Create Course</span>
                </a>
                <a href="modify-course.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    <span>Modify Course</span>
                </a>
                <a href="assign-course.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>Assign Course</span>
                </a>

                <div class="sidebar-heading mt-4">Test Management</div>
                <a href="create-test.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span>Create Test</span>
                </a>
                <a href="modify-test.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                    <span>Modify Test</span>
                </a>
                <a href="assign-test.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>Assign Test</span>
                </a>

                <div class="sidebar-heading mt-4">Academics & Reports</div>
                <a href="test-history.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span>Test History</span>
                </a>
                <a href="report.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V3.75M16.5 18.75h-9" /></svg>
                    <span>Reports</span>
                </a>
                <a href="issue-certificates.html" class="sidebar-link flex items-center py-2.5 px-4 rounded transition duration-200">
                    <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Issue Certificates</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
                <h1 class="text-2xl font-semibold text-gray-800">Student Management</h1>
                <div class="flex items-center space-x-4">
                    <button onclick="window.print()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                        Print
                    </button>
                    <div class="relative">
                         <button id="user-menu-button" class="flex items-center space-x-2">
                            <span id="user-name" class="font-semibold text-gray-700">Admin User</span>
                            <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                            <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-6 overflow-y-auto printable-area">
                <!-- Print Header -->
                <div class="hidden print:flex items-center justify-between pb-6 border-b border-gray-200 mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Student Report</h1>
                    <div class="flex items-center">
                        <img class="h-12 w-12" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png" alt="TESTIFY Logo">
                        <span class="ml-3 text-3xl font-bold text-gray-800">TESTIFY</span>
                    </div>
                </div>

                <!-- College Selection -->
                <div class="mb-6 no-print">
                    <label for="college-select" class="block text-sm font-medium text-gray-700 mb-2">Select a College:</label>
                    <select id="college-select" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- Loading Colleges --</option>
                    </select>
                </div>

                <!-- Student Table -->
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact/Roll Number</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body" class="bg-white divide-y divide-gray-200">
                           <tr><td colspan="5" class="text-center p-4 text-gray-500">Please select a college to view students.</td></tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>

        <!-- Edit Student Modal -->
        <div id="edit-modal" class="fixed z-10 inset-0 overflow-y-auto hidden no-print">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Edit Student</h3>
                        <form id="edit-form" class="mt-4 space-y-4">
                            <input type="hidden" id="edit-email">
                            <div>
                                <label for="edit-fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="edit-fullName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="edit-mobile" class="block text-sm font-medium text-gray-700">Mobile</label>
                                <input type="text" id="edit-mobile" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="edit-college" class="block text-sm font-medium text-gray-700">College</label>
                                <input type="text" id="edit-college" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="edit-department" class="block text-sm font-medium text-gray-700">Department</label>
                                <input type="text" id="edit-department" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label for="edit-rollNumber" class="block text-sm font-medium text-gray-700">Roll Number</label>
                                <input type="text" id="edit-rollNumber" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" id="save-changes" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                        <button type="button" id="cancel-edit" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Upload Modal (for Admin) -->
        <div id="image-upload-modal" class="fixed z-20 inset-0 overflow-y-auto hidden no-print">
            <div class="flex items-center justify-center min-h-screen">
                <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                </div>
                <div class="inline-block bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Change Student Profile Image</h3>
                        <form id="image-upload-form" class="mt-4 space-y-4">
                            <input type="hidden" id="image-upload-email">
                            <div>
                                <label for="profile-image-input" class="block text-sm font-medium text-gray-700">Select new image</label>
                                <input type="file" id="profile-image-input" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                                <img id="image-preview" src="" alt="Image Preview" class="mt-4 rounded-lg max-h-60 w-auto hidden mx-auto">
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" id="upload-image-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">Upload</button>
                        <button type="button" id="cancel-image-upload" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                    </div>
                </div>
            </div>
        </div>


        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user'));
                if (!token || !user || user.role !== 'Admin') { 
                    window.location.href = '/login.html'; 
                    return; 
                }

                document.getElementById('user-name').textContent = user.fullName;
                const userMenuButton = document.getElementById('user-menu-button');
                const userMenu = document.getElementById('user-menu');
                const logoutButton = document.getElementById('logout-button');
                userMenuButton.addEventListener('click', () => userMenu.classList.toggle('hidden'));
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login.html';
                });

                const collegeSelect = document.getElementById('college-select');
                const studentTableBody = document.getElementById('student-table-body');
                const editModal = document.getElementById('edit-modal');
                const imageUploadModal = document.getElementById('image-upload-modal');
                const imageUploadEmailInput = document.getElementById('image-upload-email');
                const profileImageInput = document.getElementById('profile-image-input');
                const imagePreview = document.getElementById('image-preview');

                async function fetchAndPopulateColleges() {
                    try {
                        const response = await fetch('/api/colleges', { headers: { 'x-auth-token': token } });
                        if (!response.ok) throw new Error('Failed to fetch colleges');
                        const colleges = await response.json();
                        
                        collegeSelect.innerHTML = '<option value="">-- Select College --</option><option value="all">-- All Colleges --</option>';
                        
                        colleges.forEach(college => {
                            const option = document.createElement('option');
                            option.value = college.collegeName;
                            option.textContent = college.collegeName;
                            collegeSelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error("Error fetching colleges:", error);
                        collegeSelect.innerHTML = '<option value="">Error loading colleges</option>';
                    }
                }
                
                fetchAndPopulateColleges();

                collegeSelect.addEventListener('change', () => {
                    const college = collegeSelect.value;
                    if (college) {
                        fetchStudents(college);
                    } else {
                        studentTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Please select a college to view students.</td></tr>';
                    }
                });

                function fetchStudents(college) {
                    studentTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading...</td></tr>';
                    
                    const endpoint = college === 'all'
                        ? '/api/admin/all-students'
                        : `/api/admin/students/${encodeURIComponent(college)}`;

                    fetch(endpoint, {
                        headers: { 'x-auth-token': token }
                    })
                    .then(res => res.json())
                    .then(students => {
                        renderStudents(students);
                    });
                }

                function renderStudents(students) {
                    studentTableBody.innerHTML = '';
                    if (students.length === 0) {
                        studentTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No students found for this college.</td></tr>';
                        return;
                    }
                    students.forEach(student => {
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10 relative group">
                                            <img class="h-10 w-10 rounded-full object-cover" src="${student.profileImageUrl || 'https://placehold.co/40x40/EFEFEF/333333?text=N/A'}" alt="Student photo" onerror="this.onerror=null;this.src='https://placehold.co/40x40/EFEFEF/333333?text=N/A';">
                                            <button onclick="openImageUploadModal('${student.email}')" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity no-print cursor-pointer">
                                                <i class="fas fa-camera text-white"></i>
                                            </button>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">${student.fullName}</div>
                                            <div class="text-sm text-gray-500">${student.email}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${student.mobile || 'N/A'}</div>
                                    <div class="text-sm text-gray-500">${student.rollNumber || 'N/A'}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <div>Tests Taken: ${student.tests.length}</div>
                                    <div>Courses Enrolled: ${student.courses.length}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${student.isBlocked ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                        ${student.isBlocked ? 'Blocked' : 'Active'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium no-print">
                                    <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="openEditModal('${student.email}')" title="Edit Details"><i class="fas fa-edit"></i></button>
                                    <button class="text-red-600 hover:text-red-900 mr-3" onclick="deleteStudent('${student.email}')" title="Delete Student"><i class="fas fa-trash"></i></button>
                                    <button class="${student.isBlocked ? 'text-green-600 hover:text-green-900' : 'text-yellow-600 hover:text-yellow-900'}" onclick="toggleBlock('${student.email}', ${student.isBlocked})" title="${student.isBlocked ? 'Unblock Student' : 'Block Student'}">
                                        <i class="fas ${student.isBlocked ? 'fa-check-circle' : 'fa-ban'}"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        studentTableBody.innerHTML += row;
                    });
                }

                window.openEditModal = (email) => {
                    const college = collegeSelect.value === 'all' ? '' : collegeSelect.value;
                    const endpoint = college 
                        ? `/api/admin/students/${encodeURIComponent(college)}`
                        : '/api/admin/all-students';

                    fetch(endpoint, { headers: { 'x-auth-token': token } })
                        .then(res => res.json())
                        .then(students => {
                            const student = students.find(s => s.email === email);
                            if (student) {
                                document.getElementById('edit-email').value = student.email;
                                document.getElementById('edit-fullName').value = student.fullName;
                                document.getElementById('edit-mobile').value = student.mobile;
                                document.getElementById('edit-college').value = student.college;
                                document.getElementById('edit-department').value = student.department;
                                document.getElementById('edit-rollNumber').value = student.rollNumber;
                                editModal.classList.remove('hidden');
                            }
                        });
                };

                document.getElementById('cancel-edit').addEventListener('click', () => {
                    editModal.classList.add('hidden');
                });

                document.getElementById('save-changes').addEventListener('click', () => {
                    const email = document.getElementById('edit-email').value;
                    const updatedData = {
                        fullName: document.getElementById('edit-fullName').value,
                        mobile: document.getElementById('edit-mobile').value,
                        college: document.getElementById('edit-college').value,
                        department: document.getElementById('edit-department').value,
                        rollNumber: document.getElementById('edit-rollNumber').value,
                    };
                    fetch(`/api/admin/students/${email}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify(updatedData)
                    })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message);
                        editModal.classList.add('hidden');
                        fetchStudents(collegeSelect.value);
                    });
                });

                window.openImageUploadModal = (email) => {
                    imageUploadEmailInput.value = email;
                    profileImageInput.value = '';
                    imagePreview.classList.add('hidden');
                    imageUploadModal.classList.remove('hidden');
                };

                profileImageInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                document.getElementById('cancel-image-upload').addEventListener('click', () => {
                    imageUploadModal.classList.add('hidden');
                });

                document.getElementById('upload-image-btn').addEventListener('click', () => {
                    const email = imageUploadEmailInput.value;
                    const file = profileImageInput.files[0];
                    if (!file) {
                        alert('Please select an image file.');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('profileImage', file);
                    
                    const uploadButton = document.getElementById('upload-image-btn');
                    uploadButton.disabled = true;
                    uploadButton.textContent = 'Uploading...';

                    fetch(`/api/admin/student/${email}/image`, {
                        method: 'POST',
                        headers: { 'x-auth-token': token },
                        body: formData
                    })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => { throw new Error(err.message) });
                        }
                        return res.json();
                    })
                    .then(data => {
                        alert(data.message);
                        imageUploadModal.classList.add('hidden');
                        fetchStudents(collegeSelect.value);
                    })
                    .catch(error => {
                        console.error('Image upload failed:', error);
                        alert(`Image upload failed: ${error.message}`);
                    })
                    .finally(() => {
                        uploadButton.disabled = false;
                        uploadButton.textContent = 'Upload';
                    });
                });

                window.deleteStudent = (email) => {
                    if (confirm('Are you sure you want to delete this student?')) {
                        fetch(`/api/admin/students/${email}`, {
                            method: 'DELETE',
                            headers: { 'x-auth-token': token }
                        })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message);
                            fetchStudents(collegeSelect.value);
                        });
                    }
                };

                window.toggleBlock = (email, isBlocked) => {
                    const action = isBlocked ? 'unblock' : 'block';
                    if (confirm(`Are you sure you want to ${action} this student?`)) {
                        fetch(`/api/admin/students/${email}/status`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-auth-token': token
                            },
                            body: JSON.stringify({ isBlocked: !isBlocked })
                        })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message);
                            fetchStudents(collegeSelect.value);
                        });
                    }
                };
            });
        </script>
    </div>
</body>
</html>
