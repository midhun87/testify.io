<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Full Screen Tests - TESTIFY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link:hover { background-color: #4338CA; }
        .sidebar-link.active { background-color: #4F46E5; font-weight: 600; }
        .sidebar-heading { padding: 0.75rem 1rem; font-size: 0.75rem; letter-spacing: 0.05em; color: #9CA3AF; text-transform: uppercase; }
        .tab-btn.active { border-color: #4F46E5; color: #4F46E5; background-color: #EEF2FF; }
        #ai-loader { display: none; }
        .question-block { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1756037774/Gemini_Generated_Image_eu0ib0eu0ib0eu0i_z0amjh.png" alt="TESTIFY Logo">
                <span class="ml-3 text-2xl font-bold">TESTIFY</span>
            </div>
            <nav class="flex-grow p-4 overflow-y-auto">
                 <a href="/admin/dashboard.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                     <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                     <span class="ml-3">Dashboard</span>
                 </a>
                 <div class="sidebar-heading mt-4">Test Management</div>
                 <a href="/admin/create-test.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                     <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                     <span class="ml-3">AI Proctored Tests</span>
                 </a>
                 <a href="/admin/FSTest.html" class="sidebar-link active flex items-center px-4 py-3 mt-2 rounded-lg">
                     <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                     <span class="ml-3">Full Screen Tests</span>
                 </a>
            </nav>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-6">
                <h1 class="text-2xl font-bold text-gray-800">Manage Full Screen Tests</h1>
                 <div class="flex items-center">
                     <div class="relative">
                         <button id="user-menu-button" class="flex items-center space-x-2">
                             <span id="user-name" class="font-semibold text-gray-700">Admin</span>
                             <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                         </button>
                         <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                             <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                         </div>
                     </div>
                 </div>
            </div>

            <div class="p-6">
                <form id="create-test-form">
                    <div class="bg-white p-6 rounded-lg shadow-sm border-2 border-dashed border-indigo-200 mb-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">Generate with AI</h2>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="pdf-upload" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button type="button" id="analyze-pdf-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-sm hover:bg-indigo-700 whitespace-nowrap">Analyze PDF</button>
                        </div>
                         <div id="ai-loader" class="mt-4 flex items-center text-gray-600">
                             <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                             <span>AI is structuring your test...</span>
                         </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Test Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <input type="text" id="testTitle" placeholder="Test Title" class="p-3 border rounded-lg" required>
                            <input type="number" id="duration" placeholder="Duration (minutes)" class="p-3 border rounded-lg" required>
                            <input type="number" id="totalMarks" placeholder="Total Marks" class="p-3 border rounded-lg" required>
                            <input type="number" id="passingPercentage" placeholder="Passing Percentage (%)" class="p-3 border rounded-lg" required>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-4">
                              <h2 class="text-xl font-bold text-gray-800">Questions</h2>
                              <button type="button" id="add-question-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Add Question</button>
                        </div>
                        <div id="questions-container" class="space-y-6"></div>
                    </div>
                    
                    <div class="mt-8 flex justify-end">
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700">Create Full Screen Test</button>
                    </div>
                </form>

                <div class="mt-12 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Manage & Assign Full Screen Tests</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Test Title</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tests-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="assign-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form id="assign-form">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900">Assign Full Screen Test</h3>
                    <p class="mt-1 text-sm text-gray-600">Assigning: <strong id="modal-test-name"></strong></p>
                    <input type="hidden" id="modal-test-id" name="testId">
                    <div class="border-b border-gray-200 mt-4">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button type="button" id="tab-college" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">By College</button>
                            <button type="button" id="tab-student" class="tab-btn text-gray-500 hover:text-gray-700 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">By Student</button>
                        </nav>
                    </div>
                    <div id="tab-panel-college" class="mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Colleges</label>
                        <div id="college-list" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4"></div>
                    </div>
                    <div id="tab-panel-student" class="hidden mt-6">
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                             <select id="filter-college" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                             <select id="filter-department" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                         </div>
                        <button type="button" id="load-students-btn" class="w-full mb-4 px-4 py-2 bg-indigo-100 text-indigo-700 font-semibold rounded-md hover:bg-indigo-200">Load Students</button>
                        <input type="text" id="student-search" placeholder="Search loaded students..." class="w-full px-3 py-2 border border-gray-300 rounded-md" disabled>
                        <div id="student-list" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4 mt-2"></div>
                    </div>
                    <div class="mt-6 flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">Send Email Notification</span>
                        <label for="send-email" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="send-email" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="px-4 py-2 bg-white text-gray-700 border rounded-md hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">Confirm Assignment</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));
        if (!token || !user || (user.role !== 'Admin' && user.role !== 'Moderator')) {
            window.location.href = '/login';
            return;
        }
        document.getElementById('user-name').textContent = user.fullName;

        const createTestForm = document.getElementById('create-test-form');
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const testsTableBody = document.getElementById('tests-table-body');
        const assignModal = document.getElementById('assign-modal');
        const assignForm = document.getElementById('assign-form');
        const cancelBtn = document.getElementById('cancel-btn');
        const modalTestName = document.getElementById('modal-test-name');
        const modalTestIdInput = document.getElementById('modal-test-id');
        const collegeListDiv = document.getElementById('college-list');
        const studentListDiv = document.getElementById('student-list');
        const tabCollege = document.getElementById('tab-college');
        const tabPanelCollege = document.getElementById('tab-panel-college');
        const tabStudent = document.getElementById('tab-student');
        const tabPanelStudent = document.getElementById('tab-panel-student');
        const filterCollegeSelect = document.getElementById('filter-college');
        const filterDepartmentSelect = document.getElementById('filter-department');
        const loadStudentsBtn = document.getElementById('load-students-btn');
        const studentSearchInput = document.getElementById('student-search');
        const analyzePdfBtn = document.getElementById('analyze-pdf-btn');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const aiLoader = document.getElementById('ai-loader');
        
        let questionCounter = 0;
        let colleges = [];
        let departments = [];
        let loadedStudents = [];
        let currentAssignType = 'college';

        async function fetchInitialData() {
            try {
                const [collegesRes, deptsRes, testsRes] = await Promise.all([
                    fetch('/api/colleges', { headers: { 'x-auth-token': token } }),
                    fetch('/api/departments', { headers: { 'x-auth-token': token } }),
                    fetch('/api/fullscreen-tests', { headers: { 'x-auth-token': token } })
                ]);
                colleges = await collegesRes.json();
                departments = await deptsRes.json();
                const tests = await testsRes.json();
                populateFilterDropdowns(user.role === 'Admin' ? colleges.map(c => c.collegeName) : user.assignedColleges);
                displayTests(tests);
            } catch (error) {
                console.error('Error fetching initial data:', error);
            }
        }
        
        function addQuestion(data = {}) {
            questionCounter++;
            const questionId = `question-${questionCounter}`;
            const questionBlock = document.createElement('div');
            questionBlock.id = `${questionId}-block`;
            questionBlock.className = 'question-block bg-white p-6 rounded-xl shadow-md border';
            questionBlock.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Question ${questionCounter}</h3>
                    <button type="button" class="remove-question-btn text-red-500 hover:text-red-700">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="${questionId}-type" class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="${questionId}-type" name="${questionId}-type" class="question-type-select mt-1 block w-full p-2 border border-gray-300 rounded-md" data-question-id="${questionId}">
                            <option value="mcq-single">Single Choice</option>
                            <option value="mcq-multiple">Multiple Choice</option>
                            <option value="fill-blank">Fill in the Blanks</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <label for="${questionId}-marks" class="block text-sm font-medium text-gray-700">Marks</label>
                        <input type="number" id="${questionId}-marks" name="${questionId}-marks" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md" value="${data.marks || ''}">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="${questionId}-text" class="block text-sm font-medium text-gray-700">Question Text</label>
                    <textarea id="${questionId}-text" name="${questionId}-text" rows="3" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">${data.text || ''}</textarea>
                </div>
                <div id="${questionId}-answer-area" class="mt-4"></div>
            `;
            questionsContainer.appendChild(questionBlock);

            const typeSelect = document.getElementById(`${questionId}-type`);
            if (data.type) typeSelect.value = data.type;
            updateAnswerArea(questionId, typeSelect.value, data);
        }

        addQuestionBtn.addEventListener('click', () => addQuestion());

        function updateAnswerArea(questionId, type, data = {}) {
            const answerArea = document.getElementById(`${questionId}-answer-area`);
            if (!answerArea) return;

            if (type === 'mcq-single' || type === 'mcq-multiple') {
                const inputType = type === 'mcq-single' ? 'radio' : 'checkbox';
                answerArea.innerHTML = `
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Options & Correct Answer</h4>
                    <div id="${questionId}-options-container" class="space-y-2"></div>
                    <button type="button" class="add-option-btn mt-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800" data-question-id="${questionId}" data-input-type="${inputType}">+ Add Option</button>
                `;
                const options = data.options || ['', ''];
                options.forEach((optionText, index) => {
                    let isChecked = false;
                    if (type === 'mcq-single') isChecked = String(data.correctAnswer) === String(index);
                    else if (type === 'mcq-multiple') isChecked = data.correctAnswers && data.correctAnswers.includes(String(index));
                    addOption(questionId, inputType, optionText, isChecked);
                });
            } else if (type === 'fill-blank') {
                answerArea.innerHTML = `
                    <div>
                        <label for="${questionId}-answer" class="block text-sm font-medium text-gray-700">Correct Answer</label>
                        <input type="text" id="${questionId}-answer" name="${questionId}-answer" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md" value="${data.correctAnswer || ''}">
                    </div>
                `;
            }
        }

        function addOption(questionId, inputType, text = '', isChecked = false) {
            const optionsContainer = document.getElementById(`${questionId}-options-container`);
            if (!optionsContainer) return;
            const optionIndex = optionsContainer.children.length;
            const optionDiv = document.createElement('div');
            optionDiv.className = 'flex items-center space-x-3 option-wrapper';
            optionDiv.innerHTML = `
                <input name="${questionId}-correct" type="${inputType}" value="${optionIndex}" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
                <input type="text" placeholder="Option ${optionIndex + 1}" required class="flex-grow p-2 border border-gray-300 rounded-md" value="${text}">
                <button type="button" class="remove-option-btn text-gray-400 hover:text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                </button>
            `;
            optionsContainer.appendChild(optionDiv);
        }

        questionsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-question-btn')) {
                const questionBlock = e.target.closest('.question-block');
                if (questionBlock) {
                    questionBlock.remove();
                    reIndexQuestions();
                }
            }
            if (e.target.closest('.add-option-btn')) {
                const btn = e.target.closest('.add-option-btn');
                addOption(btn.dataset.questionId, btn.dataset.inputType);
            }
            if (e.target.closest('.remove-option-btn')) {
                const optionWrapper = e.target.closest('.option-wrapper');
                if (optionWrapper) {
                    optionWrapper.remove();
                }
            }
        });

        questionsContainer.addEventListener('change', (e) => {
            if (e.target.matches('.question-type-select')) {
                updateAnswerArea(e.target.dataset.questionId, e.target.value);
            }
        });

        function reIndexQuestions() {
            document.querySelectorAll('.question-block').forEach((block, index) => {
                const newIndex = index + 1;
                block.querySelector('h3').textContent = `Question ${newIndex}`;
            });
            questionCounter = document.querySelectorAll('.question-block').length;
        }
        
        // ... (The rest of the script, including AI generation and form submission logic)
        
        // --- AI PDF Analysis Logic ---
        analyzePdfBtn.addEventListener('click', async () => {
            const file = pdfUploadInput.files[0];
            if (!file) {
                alert('Please select a PDF file first.');
                return;
            }

            aiLoader.style.display = 'flex';
            analyzePdfBtn.disabled = true;

            try {
                const pdfText = await extractTextFromPdf(file);
                const prompt = createPromptForTestGeneration(pdfText);
                const testData = await generateTestWithAI(prompt);
                
                populateFormWithAIData(testData);

            } catch (error) {
                console.error('AI Test Generation Error:', error);
                alert(`Failed to generate test from PDF. ${error.message}`);
            } finally {
                aiLoader.style.display = 'none';
                analyzePdfBtn.disabled = false;
                pdfUploadInput.value = ''; // Clear file input
            }
        });


        async function extractTextFromPdf(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    try {
                        const typedarray = new Uint8Array(this.result);
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n\n';
                        }
                        resolve(fullText.trim());
                    } catch (error) {
                        reject(error);
                    }
                };
                fileReader.onerror = reject;
                fileReader.readAsArrayBuffer(file);
            });
        }

        function createPromptForTestGeneration(text) {
             return `Based on the following text content, please generate a complete test.
                The test should have a suitable title, duration in minutes, total marks, and a passing percentage.
                It should also include a variety of questions: single choice (mcq-single), multiple choice (mcq-multiple), and fill in the blanks (fill-blank).
                For mcq-single questions, provide the index of the correct option (as a string, e.g., "0", "1") in the 'correctAnswer' field.
                For mcq-multiple questions, provide an array of correct indices (as strings, e.g., ["0", "2"]) in the 'correctAnswers' field.
                For fill-blank questions, provide the answer string in the 'correctAnswer' field.
                Ensure that the options array is present for MCQ questions and empty or absent for fill-blank questions.
                The total marks of the test should be the sum of the marks for all individual questions.
                The duration should be a reasonable estimate based on the number and complexity of questions (e.g., 1-2 minutes per question). The passing percentage should be 40.
                
                Here is the text:
                ---
                ${text.substring(0, 15000)}
                ---
                
                Please provide the output in the specified JSON format.`;
        }
        
        async function generateTestWithAI(prompt) {
            const apiKey = ""; // This will be handled by the environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
              contents: [{ parts: [{ text: prompt }] }],
              generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: 'OBJECT',
                  properties: {
                    testTitle: { type: 'STRING' },
                    duration: { type: 'NUMBER' },
                    totalMarks: { type: 'NUMBER' },
                    passingPercentage: { type: 'NUMBER' },
                    questions: {
                      type: 'ARRAY',
                      items: {
                        type: 'OBJECT',
                        properties: {
                          type: { type: 'STRING', enum: ["mcq-single", "mcq-multiple", "fill-blank"] },
                          text: { type: 'STRING' },
                          marks: { type: 'NUMBER' },
                          options: { type: 'ARRAY', items: { type: 'STRING' } },
                          correctAnswer: { type: 'STRING' },
                          correctAnswers: { type: 'ARRAY', items: { type: 'STRING' } }
                        },
                        required: ['type', 'text', 'marks']
                      }
                    }
                  },
                  required: ['testTitle', 'duration', 'totalMarks', 'passingPercentage', 'questions']
                }
              }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`Content blocked by API: ${result.promptFeedback.blockReason}`);
            }
            else {
                throw new Error("Invalid response structure from AI API.");
            }
        }
        
        function populateFormWithAIData(data) {
            document.getElementById('testTitle').value = data.testTitle || '';
            document.getElementById('duration').value = data.duration || '';
            document.getElementById('totalMarks').value = data.totalMarks || '';
            document.getElementById('passingPercentage').value = data.passingPercentage || '';

            questionsContainer.innerHTML = '';
            questionCounter = 0;

            if (data.questions && Array.isArray(data.questions)) {
                data.questions.forEach(q => addQuestion(q));
            }
        }
        
        // --- Form Submission and Test Management Logic ---
        createTestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const questions = [];
            document.querySelectorAll('.question-block').forEach(block => {
                const questionIdPrefix = block.id.replace('-block', '');
                const type = document.getElementById(`${questionIdPrefix}-type`).value;
                const questionData = {
                    type,
                    text: document.getElementById(`${questionIdPrefix}-text`).value,
                    marks: parseInt(document.getElementById(`${questionIdPrefix}-marks`).value)
                };
                if (type === 'mcq-single' || type === 'mcq-multiple') {
                    questionData.options = [];
                    block.querySelectorAll(`#${questionIdPrefix}-options-container .option-wrapper`).forEach(optDiv => {
                        questionData.options.push(optDiv.querySelector('input[type="text"]').value);
                    });
                    if (type === 'mcq-single') {
                        const correctRadio = block.querySelector(`input[name="${questionIdPrefix}-correct"]:checked`);
                        questionData.correctAnswer = correctRadio ? correctRadio.value : null;
                    } else {
                        const correctCheckboxes = block.querySelectorAll(`input[name="${questionIdPrefix}-correct"]:checked`);
                        questionData.correctAnswers = Array.from(correctCheckboxes).map(cb => cb.value);
                    }
                } else {
                    questionData.correctAnswer = document.getElementById(`${questionIdPrefix}-answer`).value;
                }
                questions.push(questionData);
            });
            
            const payload = {
                testTitle: document.getElementById('testTitle').value,
                duration: parseInt(document.getElementById('duration').value),
                totalMarks: parseInt(document.getElementById('totalMarks').value),
                passingPercentage: parseInt(document.getElementById('passingPercentage').value),
                questions
            };

            try {
                const response = await fetch('/api/fullscreen-tests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error((await response.json()).message);
                alert('Test created successfully!');
                createTestForm.reset();
                questionsContainer.innerHTML = '';
                questionCounter = 0;
                fetchInitialData();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        function displayTests(tests) {
            testsTableBody.innerHTML = '';
            if (!tests || tests.length === 0) {
                testsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No tests found.</td></tr>';
                return;
            }
            tests.forEach(test => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                const statusBadge = test.status === 'Not Assigned'
                    ? `<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Not Assigned</span>`
                    : `<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${test.status}</span>`;
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${test.title}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-right space-x-4">
                        <a href="/admin/modify-fullscreen-test.html?testId=${test.testId}" class="font-medium text-blue-600 hover:text-blue-900">Modify</a>
                        <button class="assign-btn font-medium text-indigo-600 hover:text-indigo-900" data-testid="${test.testId}" data-testname="${test.title}">Assign</button>
                        <a href="/admin/view-fullscreen-results.html?testId=${test.testId}" class="font-medium text-purple-600 hover:text-purple-900">View Results</a>
                    </td>
                `;
                testsTableBody.appendChild(row);
            });
        }
        
        testsTableBody.addEventListener('click', e => {
            if (e.target.classList.contains('assign-btn')) {
                openModal(e.target.dataset.testid, e.target.dataset.testname);
            }
        });
        
        assignForm.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(assignForm);
            const payload = {
                testId: formData.get('testId'),
                testName: modalTestName.textContent,
                sendEmail: document.getElementById('send-email').checked,
            };
            if (currentAssignType === 'college') {
                payload.colleges = formData.getAll('colleges');
            } else {
                payload.studentEmails = formData.getAll('studentEmails');
            }
            if ((!payload.colleges || payload.colleges.length === 0) && (!payload.studentEmails || payload.studentEmails.length === 0)) {
                alert('Please select at least one college or student.');
                return;
            }

            try {
                const response = await fetch('/api/assign-fullscreen-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error((await response.json()).message);
                alert('Test assigned successfully!');
                closeModal();
                fetchInitialData();
            } catch (error) {
                alert(`Error assigning test: ${error.message}`);
            }
        });
        
        function populateFilterDropdowns(collegeNames) {
            filterCollegeSelect.innerHTML = '';
            collegeNames.forEach(name => {
                filterCollegeSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            filterDepartmentSelect.innerHTML = '<option value="All">All Departments</option>';
            departments.forEach(dept => {
                filterDepartmentSelect.innerHTML += `<option value="${dept.departmentName}">${dept.departmentName}</option>`;
            });
        }
        function openModal(testId, testName) {
             modalTestName.textContent = testName;
            modalTestIdInput.value = testId;
            populateCollegeList(user.role === 'Admin' ? colleges.map(c => c.collegeName) : user.assignedColleges);
            studentListDiv.innerHTML = '<p class="text-sm text-gray-500 text-center">Load students using filters.</p>';
            studentSearchInput.value = '';
            studentSearchInput.disabled = true;
            assignModal.classList.remove('hidden');
        }
        function closeModal() {
            assignModal.classList.add('hidden');
            assignForm.reset();
            switchTab('college');
        }
        function switchTab(tab) {
             currentAssignType = tab;
            if (tab === 'college') {
                tabCollege.classList.add('active'); tabStudent.classList.remove('active');
                tabPanelCollege.classList.remove('hidden'); tabPanelStudent.classList.add('hidden');
            } else {
                tabStudent.classList.add('active'); tabCollege.classList.remove('active');
                tabPanelStudent.classList.remove('hidden'); tabPanelCollege.classList.add('hidden');
            }
        }
        function populateCollegeList(collegeNames) {
            collegeListDiv.innerHTML = '';
            collegeNames.forEach((name, index) => {
                collegeListDiv.innerHTML += `<div class="flex items-center"><input id="college-${index}" name="colleges" value="${name}" type="checkbox" class="h-4 w-4 text-indigo-600"><label for="college-${index}" class="ml-3 text-sm">${name}</label></div>`;
            });
        }
        loadStudentsBtn.addEventListener('click', async () => {
             const college = filterCollegeSelect.value;
             const department = filterDepartmentSelect.value;
             loadStudentsBtn.textContent = 'Loading...';
             loadStudentsBtn.disabled = true;
             try {
                const res = await fetch(`/api/admin/students?college=${encodeURIComponent(college)}&department=${encodeURIComponent(department)}&year=All`, { headers: { 'x-auth-token': token } });
                if (!res.ok) throw new Error(await res.text());
                loadedStudents = await res.json();
                displayStudentsInList(loadedStudents);
                studentSearchInput.disabled = false;
             } catch (e) {
                alert('Error loading students: ' + e.message);
             } finally {
                 loadStudentsBtn.textContent = 'Load Students';
                 loadStudentsBtn.disabled = false;
             }
        });
        function displayStudentsInList(students, searchTerm = '') {
            studentListDiv.innerHTML = '';
            const filtered = students.filter(s => s.fullName.toLowerCase().includes(searchTerm.toLowerCase()) || s.email.toLowerCase().includes(searchTerm.toLowerCase()));
            if (filtered.length === 0) {
                studentListDiv.innerHTML = '<p class="text-sm text-center text-gray-500">No students match.</p>';
                return;
            }
            filtered.forEach(s => {
                studentListDiv.innerHTML += `<div class="flex items-center"><input id="student-${s.email}" name="studentEmails" value="${s.email}" type="checkbox" class="h-4 w-4 text-indigo-600"><label for="student-${s.email}" class="ml-3 text-sm">${s.fullName} (${s.email})</label></div>`;
            });
        }
        studentSearchInput.addEventListener('input', e => displayStudentsInList(loadedStudents, e.target.value));
        tabCollege.addEventListener('click', () => switchTab('college'));
        tabStudent.addEventListener('click', () => switchTab('student'));
        cancelBtn.addEventListener('click', closeModal);

        fetchInitialData();
    });
    </script>
</body>
</html>
