<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="container mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Assign Test -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Assign Test</h2>
            <form id="assign-test-form" class="space-y-4">
                <div>
                    <label for="test-select" class="block text-sm font-medium text-gray-700">Select Test</label>
                    <select id="test-select" required class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select>
                </div>
                <div>
                    <label for="test-colleges" class="block text-sm font-medium text-gray-700">Select Colleges</label>
                    <select id="test-colleges" multiple required class="mt-1 block w-full h-32 border-gray-300 rounded-md"></select>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Assign Test</button>
            </form>
        </div>

        <!-- Assign Course -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Assign Course</h2>
            <form id="assign-course-form" class="space-y-4">
                <div>
                    <label for="course-select" class="block text-sm font-medium text-gray-700">Select Course</label>
                    <select id="course-select" required class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select>
                </div>
                <div>
                    <label for="course-colleges" class="block text-sm font-medium text-gray-700">Select Colleges</label>
                    <select id="course-colleges" multiple required class="mt-1 block w-full h-32 border-gray-300 rounded-md"></select>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Assign Course</button>
            </form>
        </div>
    </div>
    <script>
    (() => {
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json', 'x-auth-token': token };

        const testSelect = document.getElementById('test-select');
        const courseSelect = document.getElementById('course-select');
        const testColleges = document.getElementById('test-colleges');
        const courseColleges = document.getElementById('course-colleges');

        // Populate college selects
        user.assignedColleges.forEach(college => {
            const option1 = new Option(college, college);
            const option2 = new Option(college, college);
            testColleges.add(option1);
            courseColleges.add(option2);
        });

        // Fetch tests and courses
        const fetchData = async () => {
            try {
                const [testsRes, coursesRes] = await Promise.all([
                    fetch('/api/tests', { headers }),
                    fetch('/api/admin/courses', { headers })
                ]);
                const tests = await testsRes.json();
                const courses = await coursesRes.json();
                
                tests.forEach(t => testSelect.add(new Option(t.title, t.testId)));
                courses.forEach(c => courseSelect.add(new Option(c.title, c.courseId)));

            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to load tests and courses.');
            }
        };

        // Handle Test Assignment
        document.getElementById('assign-test-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const testId = testSelect.value;
            const testName = testSelect.options[testSelect.selectedIndex].text;
            const colleges = Array.from(testColleges.selectedOptions).map(opt => opt.value);

            try {
                const response = await fetch('/api/assign-test', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ testId, testName, colleges, sendEmail: true })
                });
                if (!response.ok) throw new Error((await response.json()).message);
                alert('Test assigned successfully!');
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        // Handle Course Assignment
        document.getElementById('assign-course-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const courseId = courseSelect.value;
            const colleges = Array.from(courseColleges.selectedOptions).map(opt => opt.value);

            try {
                const response = await fetch('/api/admin/assign-course', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ courseId, colleges, sendEmail: true })
                });
                if (!response.ok) throw new Error((await response.json()).message);
                alert('Course assigned successfully!');
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        fetchData();
    })();
    </script>
</body>
</html>
