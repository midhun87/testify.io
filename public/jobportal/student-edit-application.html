<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Application - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
         .form-input, .form-textarea, .form-select {
            width: 100%; border-radius: 0.5rem; border: 1px solid #D1D5DB; padding: 0.75rem 1rem; transition: all 0.2s; background-color: white;
            font-size: 0.875rem; /* Slightly smaller text */
        }
        .form-label {
            display: block text-sm font- medium text-gray-700 mb-1;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .file-input-label { cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; }
        .spinner { border-top-color: transparent; border-right-color: transparent; }
         /* Small spinner for button */
        .button-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 0.6s linear infinite;
        }
        .disabled-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(243, 244, 246, 0.75); z-index: 10; display: flex; align-items: center; justify-content: center; }
        .section-header { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        #message { transition: opacity 0.3s ease-in-out; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header Navigation -->
     <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                 <div class="flex items-center">
                     <img class="h-8 w-auto" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png" alt="Portal Logo">
                     <span class="ml-3 font-bold text-xl text-gray-800">Student Job Portal</span>
                </div>
                <div class="flex items-center space-x-4">
                     <a href="student-job-board.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-gray-100">Job Board</a>
                    <a href="student-my-applications.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-gray-100">My Applications</a>
                    <!-- User Menu -->
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                             <span id="user-name" class="mr-2 text-gray-700 font-medium">User</span>
                            <svg class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="user-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 z-50">
                            <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="py-10">
        <div class="max-w-4xl mx-auto sm:px-6 lg:px-8">
             <!-- Loading State -->
             <div id="loading-state" class="text-center py-16">
                 <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                 <p class="mt-4 text-lg font-medium text-gray-700">Loading your application details...</p>
             </div>

             <!-- Form Container (Hidden initially) -->
            <form id="edit-application-form" class="hidden bg-white shadow-xl rounded-xl p-6 md:p-8 space-y-8 relative">
                 <!-- Disabled Overlay when not editable -->
                 <div id="disabled-overlay" class="disabled-overlay hidden rounded-xl">
                     <div class="text-center p-4 bg-white rounded-lg shadow-md max-w-sm mx-auto">
                        <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /> </svg>
                        <h3 class="text-lg font-semibold text-red-700 mt-3">Deadline Passed</h3>
                        <p class="text-gray-600 mt-2 text-sm">The application deadline for this job has passed. You can no longer edit your submission.</p>
                         <a href="student-my-applications.html" class="mt-4 inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
                            Back to My Applications
                         </a>
                    </div>
                 </div>

                <h1 class="text-2xl font-bold text-gray-800 text-center border-b pb-4">Edit Application for <span id="job-title" class="text-indigo-600">...</span></h1>

                <!-- Message Area -->
                <div id="message" class="hidden mt-4 p-4 rounded-md text-sm text-center"></div>

                <!-- Personal Information -->
                <section>
                    <h2 class="section-header">Personal Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" id="firstName" name="firstName" required class="form-input">
                        </div>
                         <div>
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" id="lastName" name="lastName" required class="form-input">
                        </div>
                        <div>
                            <label for="email" class="form-label">Email</label>
                            <input type="email" id="email" name="email" required class="form-input bg-gray-100 cursor-not-allowed" readonly>
                            <p class="text-xs text-gray-500 mt-1">Email cannot be changed.</p>
                        </div>
                         <div>
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" id="phone" name="phone" required class="form-input">
                        </div>
                         <div>
                            <label for="department" class="form-label">Department</label>
                            <input type="text" id="department" name="department" required class="form-input">
                        </div>
                         <div>
                            <label for="rollNumber" class="form-label">Roll Number</label>
                            <input type="text" id="rollNumber" name="rollNumber" required class="form-input">
                        </div>
                         <!-- Passport Photo -->
                         <div class="md:col-span-2">
                             <label class="form-label">Passport Size Photo</label>
                              <div class="mt-1 flex items-center gap-4">
                                 <img id="passportPhotoPreview" src="https://placehold.co/96x96/EFEFEF/CCCCCC?text=Photo" alt="Current Photo" class="h-24 w-24 rounded-lg object-cover bg-gray-100 border border-gray-200">
                                 <!-- Hidden input to store existing URL -->
                                 <input type="hidden" id="existingPassportPhotoUrl" name="existingPassportPhotoUrl">
                                 <div>
                                     <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" class="hidden">
                                     <label for="passportPhoto" class="file-input-label px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Change Photo</label>
                                     <span id="passportPhotoName" class="text-sm text-gray-500 mt-1 block"></span>
                                 </div>
                             </div>
                         </div>
                    </div>
                </section>

                <!-- Education -->
                 <section>
                     <h2 class="section-header">Education</h2>
                     <div id="education-container" class="space-y-4">
                         <!-- Education blocks will be added here -->
                     </div>
                     <button type="button" id="add-education-btn" class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-800">+ Add Education</button>
                 </section>

                 <!-- Experience -->
                <section>
                    <h2 class="section-header">Work Experience (Optional)</h2>
                    <div id="experience-container" class="space-y-4">
                        <!-- Experience blocks will be added here -->
                    </div>
                     <button type="button" id="add-experience-btn" class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-800">+ Add Experience</button>
                </section>

                 <!-- Documents & Links -->
                 <section>
                    <h2 class="section-header">Documents & Links</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <!-- Resume -->
                         <div>
                            <label class="form-label">Resume/CV (PDF)</label>
                            <div class="mt-1 flex flex-col sm:flex-row sm:items-center gap-3">
                                <a id="resumeLink" href="#" target="_blank" class="text-sm text-indigo-600 hover:underline hidden whitespace-nowrap">View Current Resume</a>
                                <input type="hidden" id="existingResumeUrl" name="existingResumeUrl">
                                <input type="file" id="resume" name="resume" accept=".pdf" class="hidden">
                                <label for="resume" class="file-input-label px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 whitespace-nowrap">Upload New Resume</label>
                                <span id="resumeName" class="text-sm text-gray-500 truncate"></span>
                            </div>
                        </div>
                        <!-- Govt ID -->
                         <div>
                            <label class="form-label">Government ID (Optional)</label>
                             <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                                <select id="govtIdType" name="govtIdType" class="form-select flex-shrink-0 w-full sm:w-auto">
                                    <option value="">Select Type</option>
                                    <option value="Aadhar">Aadhar Card</option>
                                    <option value="PAN">PAN Card</option>
                                    <option value="Passport">Passport</option>
                                    <option value="DrivingLicense">Driving License</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="hidden" id="existingGovtIdUrl" name="existingGovtIdUrl">
                                <input type="file" id="govtId" name="govtId" accept="image/*,.pdf" class="hidden">
                                <label for="govtId" class="file-input-label px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 whitespace-nowrap">Upload ID</label>
                                <a id="govtIdLink" href="#" target="_blank" class="text-sm text-indigo-600 hover:underline hidden whitespace-nowrap">View Current ID</a>
                             </div>
                             <span id="govtIdName" class="text-sm text-gray-500 mt-1 block truncate"></span>
                         </div>
                        <!-- Links -->
                         <div class="md:col-span-2 space-y-4">
                             <div>
                                <label for="linkedinUrl" class="form-label">LinkedIn Profile URL (Optional)</label>
                                <input type="url" id="linkedinUrl" name="linkedinUrl" class="form-input" placeholder="https://linkedin.com/in/yourprofile">
                             </div>
                             <div>
                                <label for="githubUrl" class="form-label">GitHub Profile URL (Optional)</label>
                                <input type="url" id="githubUrl" name="githubUrl" class="form-input" placeholder="https://github.com/yourusername">
                             </div>
                             <div>
                                <label for="portfolioUrl" class="form-label">Portfolio URL (Optional)</label>
                                <input type="url" id="portfolioUrl" name="portfolioUrl" class="form-input" placeholder="https://yourportfolio.com">
                             </div>
                         </div>
                    </div>
                 </section>

                <!-- Submit Button -->
                <div class="pt-6 border-t border-gray-200 flex justify-end">
                    <button type="submit" id="submit-btn" class="inline-flex items-center justify-center py-2.5 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-150 ease-in-out">
                         <span class="button-text">Update Application</span>
                         <span class="button-spinner hidden ml-2"><svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                    </button>
                </div>

            </form>
             <!-- Error loading message -->
             <div id="load-error-state" class="hidden text-center py-16 bg-white rounded-lg shadow border border-red-200">
                 <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /> </svg>
                  <p class="mt-4 text-red-600 font-semibold">Could not load application details.</p>
                  <p id="load-error-message" class="text-sm text-red-500 mt-1"></p>
                  <a href="student-my-applications.html" class="mt-4 inline-block text-indigo-600 hover:underline text-sm">Back to My Applications</a>
             </div>
        </div>
    </main>

    <script>
        // --- Utility Functions for Dynamic Sections ---
        let educationCounter = 0;
        let experienceCounter = 0;

        // Function to create and add an education block to the form
        function addEducationBlock(data = {}) {
             educationCounter++; // Increment counter for unique IDs/names
             const container = document.getElementById('education-container');
             const div = document.createElement('div');
             div.className = 'p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 relative education-block'; // Added class
             div.dataset.index = educationCounter; // Store index for later reference
             // Populate inner HTML with form fields, pre-filling with 'data' if provided
             div.innerHTML = `
                 <button type="button" class="remove-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 focus:outline-none" onclick="removeBlock(this, 'education')" aria-label="Remove education entry">&times;</button>
                 <div>
                     <label class="form-label text-xs">Type *</label>
                     <select name="education_${educationCounter}_type" required class="form-select text-xs py-1.5">
                         <option value="High School" ${data.type === 'High School' ? 'selected' : ''}>High School</option>
                         <option value="Diploma" ${data.type === 'Diploma' ? 'selected' : ''}>Diploma</option>
                         <option value="Bachelor's" ${data.type === "Bachelor's" ? 'selected' : ''}>Bachelor's</option>
                         <option value="Master's" ${data.type === "Master's" ? 'selected' : ''}>Master's</option>
                         <option value="PhD" ${data.type === 'PhD' ? 'selected' : ''}>PhD</option>
                         <option value="Other" ${data.type === 'Other' ? 'selected' : ''}>Other</option>
                     </select>
                 </div>
                 <div>
                     <label class="form-label text-xs">Institute Name *</label>
                     <input type="text" name="education_${educationCounter}_institute" required class="form-input text-xs py-1.5" value="${data.institute || ''}">
                 </div>
                 <div>
                     <label class="form-label text-xs">Stream/Major *</label>
                     <input type="text" name="education_${educationCounter}_stream" required class="form-input text-xs py-1.5" value="${data.stream || ''}">
                 </div>
                 <div>
                     <label class="form-label text-xs">Score/GPA *</label>
                     <input type="text" name="education_${educationCounter}_score" required class="form-input text-xs py-1.5" value="${data.score || ''}">
                 </div>
                  <div class="md:col-span-2">
                     <label class="form-label text-xs">Certificate/Marksheet (Optional, PDF/Image)</label>
                     <div class="flex items-center gap-3">
                        <input type="file" id="education_certificate_${educationCounter}" name="education_certificate_${educationCounter}" accept="image/*,.pdf" class="hidden">
                        <label for="education_certificate_${educationCounter}" class="file-input-label px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 whitespace-nowrap">Upload File</label>
                        <span id="education_certificate_name_${educationCounter}" class="text-xs text-gray-500 truncate" title=""></span>
                        <!-- Hidden input to store existing URL when loading -->
                        <input type="hidden" name="education_${educationCounter}_existing_certificate_url" value="${data.certificateUrl || ''}">
                        ${data.certificateUrl ? `<a href="${data.certificateUrl}" target="_blank" class="text-xs text-indigo-600 hover:underline ml-auto whitespace-nowrap">View Current</a>` : ''}
                     </div>
                 </div>
             `;
             container.appendChild(div); // Add the new block to the container
             addFileDisplayListener(`education_certificate_${educationCounter}`); // Add listener for file name display
        }

        // Function to create and add an experience block
        function addExperienceBlock(data = {}) {
             experienceCounter++;
             const container = document.getElementById('experience-container');
             const div = document.createElement('div');
             div.className = 'p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 relative experience-block'; // Added class
             div.dataset.index = experienceCounter;
             div.innerHTML = `
                 <button type="button" class="remove-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 focus:outline-none" onclick="removeBlock(this, 'experience')" aria-label="Remove experience entry">&times;</button>
                 <div>
                     <label class="form-label text-xs">Job Title *</label>
                     <input type="text" name="experience_${experienceCounter}_title" required class="form-input text-xs py-1.5" value="${data.title || ''}">
                 </div>
                 <div>
                     <label class="form-label text-xs">Company Name *</label>
                     <input type="text" name="experience_${experienceCounter}_company" required class="form-input text-xs py-1.5" value="${data.company || ''}">
                 </div>
                 <div class="md:col-span-2">
                     <label class="form-label text-xs">Description</label>
                     <textarea name="experience_${experienceCounter}_description" rows="2" class="form-textarea text-xs py-1.5">${data.description || ''}</textarea>
                 </div>
                  <div class="md:col-span-2">
                     <label class="form-label text-xs">Experience/Relieving Letter (Optional, PDF/Image)</label>
                     <div class="flex items-center gap-3">
                         <input type="file" id="experience_certificate_${experienceCounter}" name="experience_certificate_${experienceCounter}" accept="image/*,.pdf" class="hidden">
                         <label for="experience_certificate_${experienceCounter}" class="file-input-label px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 whitespace-nowrap">Upload File</label>
                         <span id="experience_certificate_name_${experienceCounter}" class="text-xs text-gray-500 truncate" title=""></span>
                         <!-- Hidden input to store existing URL -->
                         <input type="hidden" name="experience_${experienceCounter}_existing_certificate_url" value="${data.certificateUrl || ''}">
                         ${data.certificateUrl ? `<a href="${data.certificateUrl}" target="_blank" class="text-xs text-indigo-600 hover:underline ml-auto whitespace-nowrap">View Current</a>` : ''}
                     </div>
                 </div>
             `;
             container.appendChild(div);
             addFileDisplayListener(`experience_certificate_${experienceCounter}`); // Add file listener
        }

        // Function to remove a dynamically added block (education or experience)
         function removeBlock(button, type) {
             button.closest(`.${type}-block`).remove(); // Find closest parent with the block class and remove it
         }

         // Function to update the file name display when a file is selected
         function addFileDisplayListener(inputId) {
            const input = document.getElementById(inputId);
            // Derive the span ID dynamically
            const nameSpanId = inputId.replace('certificate', 'certificate_name'); // For edu/exp
            const nameSpan = document.getElementById(nameSpanId) || document.getElementById(`${inputId}Name`); // Fallback for single file inputs
            if (input && nameSpan) {
                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        nameSpan.textContent = e.target.files[0].name;
                        nameSpan.title = e.target.files[0].name; // Set title for long names
                    } else {
                        nameSpan.textContent = '';
                        nameSpan.title = '';
                    }
                });
            }
         }

         // Function to display messages (success/error) to the user
        function showMessage(msg, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = msg;
            messageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700'); // Clear existing styles

            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-700');
            } else { // info
                messageDiv.classList.add('bg-blue-100', 'text-blue-700');
            }
            messageDiv.classList.remove('hidden'); // Show the message
            // Optional: Auto-hide after a few seconds
             setTimeout(() => messageDiv.classList.add('hidden'), 5000);
        }

        // --- Main Page Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('edit-application-form');
            const loadingState = document.getElementById('loading-state');
            const loadErrorState = document.getElementById('load-error-state');
            const loadErrorMessageEl = document.getElementById('load-error-message');
            const submitBtn = document.getElementById('submit-btn');
            const btnText = submitBtn.querySelector('.button-text');
            const btnSpinner = submitBtn.querySelector('.button-spinner');
            const jobTitleEl = document.getElementById('job-title');
             const disabledOverlay = document.getElementById('disabled-overlay');

            // --- Auth & Initial Data Fetch ---
            const token = localStorage.getItem('studentToken');
            const userString = localStorage.getItem('studentUser');
             if (!token || !userString) {
                 window.location.href = 'student-login.html'; return;
             }
             try {
                const user = JSON.parse(userString);
                document.getElementById('user-name').textContent = user.fullName || 'Student';
             } catch(e) { /* Should be handled by nav logic, but good practice */ }

            const urlParams = new URLSearchParams(window.location.search);
            const applicationId = urlParams.get('applicationId');

            if (!applicationId) {
                loadingState.style.display = 'none';
                loadErrorState.classList.remove('hidden');
                loadErrorMessageEl.textContent = 'Application ID not found in the URL.';
                return;
            }

            // --- Fetch and Populate ---
            try {
                 console.log(`Fetching application data for ID: ${applicationId}`);
                 // Fetch application data using the student-specific endpoint
                 const response = await fetch(`/api/student/applications/${applicationId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                 });
                 console.log(`Fetch response status: ${response.status}`);

                 if (!response.ok) {
                    let errorMsg = 'Could not load application data.';
                    try {
                        const err = await response.json();
                        errorMsg = err.message || `Server responded with status ${response.status}`;
                         // If deadline passed or unauthorized, show the disabled overlay instead of error page
                         if (response.status === 403 && errorMsg.includes("deadline")) {
                              loadingState.style.display = 'none';
                              form.classList.remove('hidden'); // Show form structure but disable it
                              disabledOverlay.classList.remove('hidden');
                              submitBtn.disabled = true;
                              console.warn("Deadline has passed, disabling form.");
                              return; // Stop further processing
                         }
                    } catch (jsonErr) { /* Use default message */ }
                     throw new Error(errorMsg);
                 }

                 const appData = await response.json();
                 console.log("Received application data:", appData);


                 // --- Populate Form Fields ---
                 jobTitleEl.textContent = appData.jobTitle || 'this job';
                 document.getElementById('firstName').value = appData.firstName || '';
                 document.getElementById('lastName').value = appData.lastName || '';
                 document.getElementById('email').value = appData.email || ''; // Readonly, but good to display
                 document.getElementById('phone').value = appData.phone || '';
                 document.getElementById('department').value = appData.department || ''; // Added
                 document.getElementById('rollNumber').value = appData.rollNumber || ''; // Added
                 document.getElementById('linkedinUrl').value = appData.links?.linkedin || '';
                 document.getElementById('githubUrl').value = appData.links?.github || '';
                 document.getElementById('portfolioUrl').value = appData.links?.portfolio || '';

                 // Passport Photo
                 if (appData.passportPhotoUrl) {
                     document.getElementById('passportPhotoPreview').src = appData.passportPhotoUrl;
                     document.getElementById('existingPassportPhotoUrl').value = appData.passportPhotoUrl; // Store existing URL
                 }
                 addFileDisplayListener('passportPhoto'); // Add listener for new uploads


                 // Education (add blocks based on existing data)
                 (appData.education || []).forEach(edu => addEducationBlock(edu));
                 // Experience (add blocks based on existing data)
                 (appData.experiences || []).forEach(exp => addExperienceBlock(exp));

                 // Documents
                 if (appData.resumeUrl) {
                    document.getElementById('resumeLink').href = appData.resumeUrl;
                    document.getElementById('resumeLink').classList.remove('hidden');
                    document.getElementById('existingResumeUrl').value = appData.resumeUrl; // Store existing
                 }
                 addFileDisplayListener('resume'); // Listener for new uploads

                 // Govt ID
                 if (appData.govtId?.type) {
                     document.getElementById('govtIdType').value = appData.govtId.type;
                 }
                  if (appData.govtId?.url) {
                    document.getElementById('govtIdLink').href = appData.govtId.url;
                    document.getElementById('govtIdLink').classList.remove('hidden');
                    document.getElementById('existingGovtIdUrl').value = appData.govtId.url; // Store existing
                 }
                 addFileDisplayListener('govtId'); // Listener for new uploads

                 // --- Check Editability based on fetched data ---
                 if (appData.isEditable === false) { // Check the flag from backend
                     disabledOverlay.classList.remove('hidden');
                     submitBtn.disabled = true;
                     console.warn("Deadline has passed (based on fetched data), disabling form.");
                 }


                 // Show form, hide loader
                 loadingState.style.display = 'none';
                 form.classList.remove('hidden');

             } catch (error) {
                 console.error("Error loading application details:", error);
                 loadingState.style.display = 'none';
                 loadErrorState.classList.remove('hidden');
                 loadErrorMessageEl.textContent = error.message || 'An unknown error occurred.';
             }

            // --- Event Listeners ---
            document.getElementById('add-education-btn').addEventListener('click', () => addEducationBlock());
            document.getElementById('add-experience-btn').addEventListener('click', () => addExperienceBlock());

            // --- Form Submission Logic ---
            form.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 showMessage(''); // Clear previous messages
                 submitBtn.disabled = true; // Disable button
                 btnText.textContent = 'Updating...'; // Change text
                 btnSpinner.classList.remove('hidden'); // Show spinner

                 // Use FormData to handle file uploads correctly
                 const formData = new FormData(form);

                 // --- Consolidate Dynamic Sections into JSON ---
                 const educationData = [];
                 document.querySelectorAll('.education-block').forEach((block) => {
                     const i = block.dataset.index; // Get the original index
                     const certificateInput = document.getElementById(`education_certificate_${i}`);
                     const existingUrlInput = block.querySelector(`input[name='education_${i}_existing_certificate_url']`);
                     let certificateUrl = existingUrlInput ? existingUrlInput.value : null; // Start with existing

                      // If a *new* file was selected for this block, FormData already has it.
                      // We just need to ensure the JSON part doesn't contain the old URL if a new file replaced it.
                     if (certificateInput && certificateInput.files.length > 0) {
                        // Backend will handle the new file; ensure JSON doesn't force the old URL
                        certificateUrl = null; // Let backend use the uploaded file
                     }

                     educationData.push({
                         type: formData.get(`education_${i}_type`),
                         institute: formData.get(`education_${i}_institute`),
                         stream: formData.get(`education_${i}_stream`),
                         score: formData.get(`education_${i}_score`),
                         certificateUrl: certificateUrl // Include URL (null if new file uploaded)
                     });
                     // Remove individual fields from FormData *only if* they exist (they might have been removed)
                     if (formData.has(`education_${i}_type`)) formData.delete(`education_${i}_type`);
                     if (formData.has(`education_${i}_institute`)) formData.delete(`education_${i}_institute`);
                     if (formData.has(`education_${i}_stream`)) formData.delete(`education_${i}_stream`);
                     if (formData.has(`education_${i}_score`)) formData.delete(`education_${i}_score`);
                     // Don't delete the file input itself from FormData!
                     if (formData.has(`education_${i}_existing_certificate_url`)) formData.delete(`education_${i}_existing_certificate_url`);
                 });
                 // Append the consolidated JSON string for education
                 formData.append('education', JSON.stringify(educationData));

                 // Consolidate Experience Data (similar logic)
                 const experienceData = [];
                  document.querySelectorAll('.experience-block').forEach((block) => {
                     const i = block.dataset.index;
                     const certificateInput = document.getElementById(`experience_certificate_${i}`);
                     const existingUrlInput = block.querySelector(`input[name='experience_${i}_existing_certificate_url']`);
                     let certificateUrl = existingUrlInput ? existingUrlInput.value : null;

                     if (certificateInput && certificateInput.files.length > 0) {
                        certificateUrl = null; // Let backend handle the new file
                     }

                     experienceData.push({
                         title: formData.get(`experience_${i}_title`),
                         company: formData.get(`experience_${i}_company`),
                         description: formData.get(`experience_${i}_description`),
                         certificateUrl: certificateUrl
                     });
                     // Remove individual fields
                     if (formData.has(`experience_${i}_title`)) formData.delete(`experience_${i}_title`);
                     if (formData.has(`experience_${i}_company`)) formData.delete(`experience_${i}_company`);
                     if (formData.has(`experience_${i}_description`)) formData.delete(`experience_${i}_description`);
                      if (formData.has(`experience_${i}_existing_certificate_url`)) formData.delete(`experience_${i}_existing_certificate_url`);
                 });
                 formData.append('experiences', JSON.stringify(experienceData));

                // Remove email as it's read-only and shouldn't be submitted for update
                formData.delete('email');

                // Log FormData contents for debugging (optional)
                // for (let [key, value] of formData.entries()) {
                //    console.log(`${key}: ${value instanceof File ? value.name : value}`);
                // }

                 try {
                     console.log(`Sending PUT request to: /api/student/applications/${applicationId}`);
                     const response = await fetch(`/api/student/applications/${applicationId}`, {
                         method: 'PUT',
                         headers: { 'Authorization': `Bearer ${token}` }, // NO 'Content-Type' for FormData!
                         body: formData
                     });
                     console.log(`Update response status: ${response.status}`);

                     const result = await response.json(); // Always try to parse JSON

                     if (!response.ok) {
                        // Throw error with message from backend JSON if available
                        throw new Error(result.message || `Update failed with status ${response.status}.`);
                     }

                     showMessage('Application updated successfully!', 'success');
                     // Optionally redirect back after a delay
                     setTimeout(() => window.location.href = 'student-my-applications.html', 1500);

                 } catch (error) {
                     console.error("Error submitting update:", error);
                     showMessage(`Error: ${error.message}`, 'error');
                     // Re-enable button only on error
                     submitBtn.disabled = false;
                     btnText.textContent = 'Update Application';
                     btnSpinner.classList.add('hidden');
                 } finally {
                     // In case of success, button remains disabled until redirect
                      // If error occurred, it's re-enabled above. If redirecting, no need to reset here.
                 }
            });

             // --- User Menu & Logout Setup ---
             setupUserMenu(); // Call setup function
        });

        // Function to set up user menu interactions
        function setupUserMenu() {
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const logoutButton = document.getElementById('logout-button');

            userMenuButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent click from immediately closing menu
                userMenu.classList.toggle('hidden');
            });
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('studentToken');
                localStorage.removeItem('studentUser');
                window.location.href = 'student-login.html';
            });
            // Close dropdown if clicked outside
            document.addEventListener('click', (event) => {
                if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                    userMenu.classList.add('hidden');
                }
            });
        }

         // --- Initial File Input Listeners for Single Files ---
         addFileDisplayListener('passportPhoto');
         addFileDisplayListener('resume');
         addFileDisplayListener('govtId');

         // --- Preview for Passport Photo ---
         const passportPhotoInput = document.getElementById('passportPhoto');
         const passportPhotoPreview = document.getElementById('passportPhotoPreview');
         if(passportPhotoInput && passportPhotoPreview) {
             passportPhotoInput.addEventListener('change', (e) => {
                 if (e.target.files.length > 0) {
                     const file = e.target.files[0];
                     // Show preview only if it's an image
                     if (file.type.startsWith('image/')) {
                         const reader = new FileReader();
                         reader.onload = (event) => {
                             passportPhotoPreview.src = event.target.result;
                         }
                         reader.readAsDataURL(file);
                     } else {
                         // Optionally show a generic icon if not an image
                         passportPhotoPreview.src = 'https://placehold.co/96x96/EFEFEF/CCCCCC?text=File';
                     }
                 }
                 // No else needed - if no file selected, the addFileDisplayListener clears the name,
                 // and we might want to keep the existing preview until a new valid image is selected.
             });
         }
    </script>
</body>
</html>
