<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tests - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .status-badge { display: inline-block; padding: 0.25em 0.6em; font-size: 0.75rem; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; }
        
        /* Test Statuses */
        .test-status-active { background-color: #D1FAE5; color: #065F46; } /* green */
        .test-status-upcoming { background-color: #FEF3C7; color: #92400E; } /* yellow */
        .test-status-expired { background-color: #E5E7EB; color: #4B5563; } /* gray */

        /* Button Styles */
        .btn-primary {
            display: inline-flex;
            items-center: center;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-width: 1px;
            border-color: transparent;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 500;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            color: #ffffff;
            background-color: #4f46e5;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-disabled {
            display: inline-flex;
            items-center: center;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-width: 1px;
            border-color: transparent;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 500;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            color: #9ca3af;
            background-color: #e5e7eb;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                     <img class="h-8 w-auto" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png" alt="Portal Logo">
                     <span class="ml-3 font-bold text-xl text-gray-800">Student Job Portal</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="student-job-board.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-gray-100">Job Board</a>
                    <a href="student-my-applications.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-indigo-600 hover:bg-gray-100">My Applications</a>
                    <a href="student-my-tests.html" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-indigo-600">My Tests</a>
                    <!-- User Menu Dropdown -->
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                             <span id="user-name" class="mr-2 text-gray-700 font-medium">User</span>
                            <svg class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="user-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="py-10">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6 px-4 sm:px-0">My Tests</h1>

            <div id="tests-container" class="space-y-6">
                <!-- Loading State -->
                <div id="loading-state" class="text-center py-16">
                    <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-4 text-lg font-medium text-gray-700">Loading your assigned tests...</p>
                </div>

                 <!-- Error State -->
                 <div id="error-state" class="hidden text-center py-16 bg-white rounded-lg shadow"></div>

                 <!-- No Tests State -->
                 <div id="no-tests-state" class="hidden text-center py-16 bg-white rounded-lg shadow">
                    <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>
                    <h3 class="mt-4 text-lg font-semibold text-gray-900">No Tests Found</h3>
                    <p class="mt-2 text-sm text-gray-500">You haven't been assigned any tests yet.</p>
                 </div>

                 <!-- Test Cards will be appended here -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const testsContainer = document.getElementById('tests-container');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const noTestsState = document.getElementById('no-tests-state');
            const userNameEl = document.getElementById('user-name');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const logoutButton = document.getElementById('logout-button');

             // --- Authentication Check ---
             const token = localStorage.getItem('studentToken');
             const userString = localStorage.getItem('studentUser');
             if (!token || !userString) {
                 window.location.href = 'student-login.html';
                 return;
             }
             try {
                 const user = JSON.parse(userString);
                 userNameEl.textContent = user.fullName || 'Student';
             } catch (e) {
                 localStorage.clear();
                 window.location.href = 'student-login.html';
                 return;
             }

             // --- User Menu Logic ---
            userMenuButton.addEventListener('click', () => userMenu.classList.toggle('hidden'));
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('studentToken');
                localStorage.removeItem('studentUser');
                window.location.href = 'student-login.html';
            });
            document.addEventListener('click', (event) => {
                if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                    userMenu.classList.add('hidden');
                }
            });

            // --- Helper Function to Create Test Card ---
            function createTestCard(test) {
                const testCard = document.createElement('div');
                testCard.className = 'bg-white shadow rounded-lg overflow-hidden';

                const assignedDate = new Date(test.date).toLocaleDateString();
                const startTime = new Date(test.startTime);
                const endTime = new Date(test.endTime);
                const now = new Date();

                let statusText = 'Active';
                let statusClass = 'test-status-active';
                let buttonText = 'Take Test';
                let buttonClass = 'btn-primary';
                let buttonDisabled = false;
                let buttonLink = test.testLink;

                if (now < startTime) {
                    statusText = 'Upcoming';
                    statusClass = 'test-status-upcoming';
                    buttonText = 'Not Yet Active';
                    buttonClass = 'btn-disabled';
                    buttonDisabled = true;
                } else if (now > endTime) {
                    statusText = 'Expired';
                    statusClass = 'test-status-expired';
                    buttonText = 'Test Expired';
                    buttonClass = 'btn-disabled';
                    buttonDisabled = true;
                }

                testCard.innerHTML = `
                    <div class="p-5 sm:p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                             <div>
                                <h3 class="text-lg font-semibold text-gray-900">${test.testTitle}</h3>
                                <p class="text-sm text-indigo-600 font-medium">${test.testType === 'coding' ? 'Coding Test' : 'Aptitude Test'}</p>
                            </div>
                            <span class="status-badge ${statusClass} mt-2 sm:mt-0">${statusText}</span>
                        </div>
                        <div class="mt-4 border-t border-gray-200 pt-4">
                            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">Assigned On</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${assignedDate}</dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">Test Type</dt>
                                    <dd class="mt-1 text-sm text-gray-900 capitalize">${test.testType}</dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">Window Starts</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${startTime.toLocaleString()}</dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">Window Ends</dt>
                                    <dd class="mt-1 text-sm text-gray-900">${endTime.toLocaleString()}</dd>

                                </div>
                            </dl>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-5 sm:px-6 py-3 flex justify-end">
                        <a href="${buttonLink}"
                           class="${buttonClass} ${buttonDisabled ? 'pointer-events-none' : ''}"
                           ${buttonDisabled ? 'aria-disabled="true"' : ''}
                           target="_blank" rel="noopener noreferrer">
                            ${buttonText}
                        </a>
                    </div>
                `;
                return testCard;
            }

            // --- Fetch Unified Data ---
            try {
                // Endpoint now fetches only tests
                const response = await fetch('/api/student/my-tests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Could not load your tests.');
                }

                const items = await response.json();
                loadingState.style.display = 'none';

                if (items.length === 0) {
                    noTestsState.classList.remove('hidden');
                } else {
                    items.forEach(item => {
                        if (item.type === 'test') {
                            testsContainer.appendChild(createTestCard(item));
                        }
                    });
                }

            } catch (error) {
                console.error("Error fetching dashboard items:", error);
                loadingState.style.display = 'none';
                errorState.classList.remove('hidden');
                errorState.innerHTML = `<p class="text-red-600 font-semibold">Error loading tests: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
