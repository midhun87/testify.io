<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Board - Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fc; /* Lighter base color */
        }

        /* Subtle background gradient */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50vh;
            background: radial-gradient(circle, rgba(239, 246, 255, 0.7) 0%, rgba(248, 249, 252, 0) 70%);
            z-index: -1;
            pointer-events: none;
        }

        /* Modern sticky header */
        .sticky-nav {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: rgba(255, 255, 255, 0.9); /* Slightly more opaque */
            backdrop-filter: blur(10px); /* Increased blur */
            border-bottom: 1px solid rgba(229, 231, 235, 0.8); /* Slightly more visible border */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02); /* Subtle shadow */
        }

        /* Job list item */
        .job-list-item {
            opacity: 0; /* Start hidden for animation */
            animation: fadeInUp 0.5s ease-out forwards;
            /* Base styles */
            display: block;
            width: 100%;
            padding: 1rem 1.25rem; /* p-4 sm:p-5 */
            background-color: white;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.75rem; /* rounded-xl */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03); /* Subtle initial shadow */
        }
        .job-list-item:hover {
            transform: translateY(-3px) scale(1.01); /* Slightly more pronounced hover effect */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.06);
            border-color: #c7d2fe; /* border-indigo-200 */
        }
        /* Active job list item */
        .job-list-item.active {
            background-color: #eef2ff; /* bg-indigo-50 */
            border-color: #6366f1; /* border-indigo-500 */
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2); /* Indigo shadow */
            transform: none; /* Reset transform on active */
        }

        /* Custom scrollbar for job list and details */
        #jobs-container::-webkit-scrollbar,
        #job-details-pane::-webkit-scrollbar {
            width: 6px; /* Slimmer scrollbar */
        }
        #jobs-container::-webkit-scrollbar-track,
        #job-details-pane::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        #jobs-container::-webkit-scrollbar-thumb,
        #job-details-pane::-webkit-scrollbar-thumb {
            background: #d1d5db; /* Slightly darker gray */
            border-radius: 6px;
        }
        #jobs-container::-webkit-scrollbar-thumb:hover,
        #job-details-pane::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Dropdown menu animation */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .menu-animate {
            animation: fadeInDown 0.15s ease-out forwards;
        }

        /* Card fade-in animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); } /* Slightly smaller initial translate */
            to { opacity: 1; transform: translateY(0); }
        }

        /* Right pane fade-in */
        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(15px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .details-fade-in {
            animation: fadeInRight 0.3s ease-out forwards;
        }

        /* Prose styling adjustments for job description */
        .prose {
             color: #4b5563; /* Default text color */
             line-height: 1.65;
        }
        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: #1f2937; /* Darker headings */
            font-weight: 600;
             margin-bottom: 0.75em;
        }
        .prose ul > li::before {
            background-color: #6366f1; /* Indigo bullets */
        }
        .prose a {
            color: #4f46e5;
            text-decoration: none;
        }
        .prose a:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body class="min-h-screen">

    <!-- Header Navigation -->
    <nav class="sticky-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img class="h-8 w-auto" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/HireWithUS_wtn0pc.png" alt="Portal Logo">
                    <span class="ml-3 font-bold text-xl text-gray-800 tracking-tight">Student Job Portal</span>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="student-job-board.html" class="px-3 py-2 rounded-md text-sm font-medium text-white bg-indigo-600 transition-all duration-200 shadow-sm hover:bg-indigo-700">Job Board</a>
                    <a href="student-my-applications.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 transition-all duration-200">My Applications</a>
                    <!-- User Menu Dropdown -->
                    <div class="relative">
                        <button id="user-menu-button" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 p-1 hover:bg-gray-100 transition-colors duration-150">
                            <span id="user-name" class="mr-2 text-gray-700 font-medium hidden sm:block">User</span>
                            <!-- User Avatar Placeholder -->
                            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-indigo-100 ring-1 ring-indigo-200">
                                <span id="user-initial" class="text-sm font-medium text-indigo-700">U</span>
                            </span>
                            <i class="fas fa-chevron-down text-gray-500 ml-1.5 h-3 w-3 hidden sm:block"></i>
                        </button>
                        <div id="user-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <!-- <a href="student-profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a> -->
                            <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="py-10">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6 px-4 sm:px-0 tracking-tight">Available Job Openings</h1>

            <!-- Search Bar -->
            <div class="mb-6 px-4 sm:px-0">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                       <i class="fas fa-search text-gray-400 h-5 w-5"></i>
                    </div>
                    <input type="text" id="search-input" class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out" placeholder="Search by title, keyword, or location...">
                </div>
            </div>

            <!-- Main Layout Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 px-4 sm:px-0">

                <!-- Left Column: Job List -->
                <div id="job-list-column" class="lg:col-span-5 xl:col-span-4 h-full">
                    <!-- Loading State (for list) -->
                    <div id="loading-state" class="text-center py-16 bg-white rounded-xl shadow-md border border-gray-100">
                        <svg class="animate-spin h-10 w-10 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-base font-medium text-gray-600">Loading relevant jobs...</p>
                    </div>

                    <!-- Error State (for list) -->
                    <div id="error-state" class="hidden text-center py-16 bg-white rounded-xl shadow-md border border-red-200">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mx-auto"></i>
                        <h3 class="mt-4 text-lg font-semibold text-gray-800">Oops! Something went wrong.</h3>
                        <div id="error-message" class="mt-2 text-sm text-red-600"></div>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-indigo-100 text-indigo-700 text-sm font-medium rounded-md hover:bg-indigo-200 transition">Retry</button>
                    </div>

                    <!-- Job List Container -->
                    <div id="jobs-container" class="space-y-3 h-full max-h-[75vh] overflow-y-auto pr-2">
                        <!-- No Jobs State (will be shown by JS) -->
                        <div id="no-jobs-state" class="hidden text-center py-16 bg-white rounded-xl shadow-sm border border-gray-200">
                            <i class="fas fa-folder-open text-indigo-300 text-4xl mx-auto"></i>
                            <h3 id="no-jobs-title" class="mt-4 text-lg font-semibold text-gray-800">No Open Positions</h3>
                            <p id="no-jobs-text" class="mt-2 text-sm text-gray-500">There are currently no job openings matching your college eligibility. Check back later!</p>
                        </div>
                        <!-- Job list items will be appended here -->
                    </div>
                </div>

                <!-- Right Column: Job Details -->
                <div class="lg:col-span-7 xl:col-span-8">
                    <!-- Adjusted sticky position to account for header height -->
                    <div id="job-details-pane" class="sticky top-[calc(4rem+1.5rem)] bg-white rounded-xl shadow-lg border border-gray-100 h-[calc(100vh-8rem)] overflow-y-auto p-6 sm:p-8">
                        <!-- Initial Placeholder -->
                        <div id="details-placeholder" class="flex flex-col items-center justify-center h-full text-center p-6 text-gray-500">
                            <i class="far fa-hand-pointer text-indigo-300 text-5xl mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-700">Select a job</h3>
                            <p class="mt-2 text-base">Click on a job from the list to view its details here.</p>
                        </div>
                        <!-- Job details content will be injected here -->
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- DOM Elements ---
            const jobsContainer = document.getElementById('jobs-container');
            const jobDetailsPane = document.getElementById('job-details-pane');
            const detailsPlaceholder = document.getElementById('details-placeholder');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const errorMessage = document.getElementById('error-message');
            const noJobsState = document.getElementById('no-jobs-state');
            const noJobsTitle = document.getElementById('no-jobs-title');
            const noJobsText = document.getElementById('no-jobs-text');
            const searchInput = document.getElementById('search-input');

            const userNameEl = document.getElementById('user-name');
            const userInitialEl = document.getElementById('user-initial');
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const logoutButton = document.getElementById('logout-button');

            // --- App State ---
            let allJobs = [];
            let currentSelectedJobId = null;

            // --- Authentication Check ---
            const token = localStorage.getItem('studentToken');
            const userString = localStorage.getItem('studentUser');
            let user = null;

            if (!token || !userString) {
                window.location.href = 'student-login.html'; return;
            }

            try {
                user = JSON.parse(userString);
                const fullName = user.fullName || 'Student';
                userNameEl.textContent = fullName;
                userInitialEl.textContent = fullName.charAt(0).toUpperCase();
            } catch (e) {
                console.error("Failed to parse user data:", e);
                localStorage.clear();
                window.location.href = 'student-login.html';
                return;
            }

            // --- User Menu Logic ---
            userMenuButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent document click listener from closing immediately
                if (userMenu.classList.contains('hidden')) {
                    userMenu.classList.remove('hidden');
                    userMenu.classList.add('menu-animate');
                } else {
                    userMenu.classList.remove('menu-animate');
                    userMenu.classList.add('hidden');
                }
            });
            logoutButton.addEventListener('click', (e) => {
                 e.preventDefault(); // Prevent default link behavior
                localStorage.removeItem('studentToken');
                localStorage.removeItem('studentUser');
                window.location.href = 'student-login.html';
            });
            document.addEventListener('click', (event) => {
                if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                    userMenu.classList.add('hidden');
                    userMenu.classList.remove('menu-animate');
                }
            });

            // --- Job Functions ---

            /** Renders the list of jobs in the left column */
            function renderJobList(jobsToRender) {
                jobsContainer.innerHTML = ''; // Clear current list

                if (jobsToRender.length === 0) {
                    noJobsTitle.textContent = searchInput.value ? 'No Jobs Match Your Search' : 'No Open Positions';
                    noJobsText.textContent = searchInput.value ? 'Try different keywords.' : 'No jobs currently match your college eligibility.';
                    noJobsState.classList.remove('hidden');
                    jobsContainer.appendChild(noJobsState);
                } else {
                    noJobsState.classList.add('hidden');
                    jobsToRender.forEach((job, index) => {
                        const jobId = job.testId || job.jobId; // Use testId or jobId
                        const listItem = document.createElement('a');
                        listItem.href = '#'; // Prevent navigation
                        listItem.className = 'job-list-item block group'; // Ensure it behaves like a block, add group for hover states
                        listItem.dataset.jobId = jobId;
                        listItem.style.animationDelay = `${index * 50}ms`; // Animation stagger

                        if (jobId === currentSelectedJobId) {
                            listItem.classList.add('active');
                        }

                        // Use job.postedBy (moderator name) or fallback
                        const postedByName = job.postedBy && job.postedBy.trim() !== '' ? job.postedBy : 'Company'; // More robust fallback
                        // console.log(`Job ${jobId} - postedBy value: '${job.postedBy}', using: '${postedByName}'`); // UNCOMMENT FOR DEBUGGING

                        listItem.innerHTML = `
                            <h3 class="font-semibold text-lg text-indigo-800 group-hover:text-indigo-900 truncate">${job.title || 'Job Title'}</h3>
                            <p class="text-sm text-gray-700 mt-1">${postedByName}</p> <!-- Display fetched name -->
                            <div class="mt-2 flex items-center gap-2 flex-wrap"> <!-- Added flex-wrap -->
                                <span class="inline-flex items-center text-xs font-medium text-gray-600 bg-gray-100 px-2.5 py-0.5 rounded-full">
                                    <i class="fas fa-map-marker-alt text-gray-500 h-3 w-3 mr-1"></i>
                                    ${job.location || 'Remote'}
                                </span>
                                <!-- Add Department Tag if available -->
                                ${job.department ? `<span class="inline-flex items-center text-xs font-medium text-blue-700 bg-blue-100 px-2.5 py-0.5 rounded-full">
                                    <i class="fas fa-building text-blue-500 h-3 w-3 mr-1"></i>
                                    ${job.department}
                                </span>` : ''}
                            </div>
                        `;
                        jobsContainer.appendChild(listItem);
                    });
                }
            }

            /** Renders the full details of a job in the right column */
            function renderJobDetails(job) {
                detailsPlaceholder.classList.add('hidden');
                jobDetailsPane.innerHTML = ''; // Clear previous details

                const jobId = job.testId || job.jobId;
                const detailsWrapper = document.createElement('div');
                detailsWrapper.className = 'details-fade-in'; // Apply animation class

                // Sanitize description: Basic check to prevent injecting harmful scripts.
                const safeDescription = job.description ? job.description.replace(/<script.*?>.*?<\/script>/gi, '') : 'No description provided.';

                // Use job.postedBy or fallback
                const postedByName = job.postedBy && job.postedBy.trim() !== '' ? job.postedBy : 'Company'; // More robust fallback
                // console.log(`Details for Job ${jobId} - postedBy value: '${job.postedBy}', using: '${postedByName}'`); // UNCOMMENT FOR DEBUGGING

                detailsWrapper.innerHTML = `
                    <div class="pb-6 border-b border-gray-200 mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 tracking-tight">${job.title || 'Job Title Not Available'}</h2>

                        <div class="mt-4 flex flex-wrap gap-x-4 gap-y-2 items-center text-sm">
                            <span class="inline-flex items-center text-indigo-700 font-medium">
                                <i class="fas fa-map-marker-alt text-indigo-500 h-4 w-4 mr-1.5"></i>
                                ${job.location || 'Remote'}
                            </span>
                            <span class="inline-flex items-center text-gray-700 font-medium">
                                <i class="fas fa-user-tie text-gray-500 h-4 w-4 mr-1.5"></i>
                                Posted by: ${postedByName} <!-- Display fetched name -->
                            </span>
                            ${job.department ? `<span class="inline-flex items-center text-blue-700 font-medium">
                                <i class="fas fa-building text-blue-500 h-4 w-4 mr-1.5"></i>
                                ${job.department}
                            </span>` : ''}
                        </div>
                    </div>

                    <!-- Full Description - Using Tailwind Prose for better formatting -->
                    <div>
                        <h4 class="text-base font-semibold text-gray-600 uppercase tracking-wider mb-3">Job Description</h4>
                        <div class="prose prose-sm sm:prose-base max-w-none text-gray-700 leading-relaxed">
                            <!-- Process description for paragraphs -->
                            ${safeDescription.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p.trim()}</p>`).join('')}
                        </div>
                    </div>

                     <!-- Apply Button Footer - Adjusted for sticky behavior -->
                     <div class="sticky bottom-0 -mx-6 sm:-mx-8 -mb-6 sm:-mb-8 mt-8 bg-gradient-to-t from-white via-white/80 to-transparent pt-12 pb-6 px-6 sm:px-8 border-t border-gray-100 flex flex-col sm:flex-row items-center justify-between gap-4">
                         <div class="flex items-center text-sm text-gray-600 font-medium">
                             <i class="far fa-calendar-alt text-gray-500 h-4 w-4 mr-2"></i>
                             <span>Apply by: ${new Date(job.applicationDeadline).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                         </div>
                         <a href="job-application.html?jobId=${jobId}" class="inline-flex items-center px-6 py-2.5 border border-transparent text-sm font-semibold rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 w-full sm:w-auto justify-center group transition-all duration-200 ease-in-out transform hover:scale-105">
                             Apply Now
                             <i class="fas fa-arrow-right ml-2 transition-transform duration-200 group-hover:translate-x-1"></i>
                         </a>
                     </div>
                `;
                jobDetailsPane.appendChild(detailsWrapper);
                // Ensure scroll position is reset when new details are loaded
                jobDetailsPane.scrollTop = 0;
            }

            // --- Event Listeners ---

            // Search input listener with debounce
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const filteredJobs = allJobs.filter(job =>
                        (job.title || '').toLowerCase().includes(searchTerm) ||
                        (job.description || '').toLowerCase().includes(searchTerm) ||
                        (job.location || '').toLowerCase().includes(searchTerm) ||
                        (job.department || '').toLowerCase().includes(searchTerm) ||
                        (job.postedBy || '').toLowerCase().includes(searchTerm) // Search by poster name too
                    );
                    renderJobList(filteredJobs);
                    // Clear details pane if current selection is filtered out
                    if (currentSelectedJobId && !filteredJobs.some(j => (j.testId || j.jobId) === currentSelectedJobId)) {
                        jobDetailsPane.innerHTML = ''; // Clear details
                        detailsPlaceholder.classList.remove('hidden'); // Show placeholder
                        currentSelectedJobId = null; // Reset selection
                    }
                }, 300); // 300ms debounce
            });


            // Job list click listener (Event Delegation)
            jobsContainer.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent <a> tag navigation
                const clickedItem = e.target.closest('.job-list-item');

                if (!clickedItem) return;

                const jobId = clickedItem.dataset.jobId;
                if (jobId === currentSelectedJobId) return; // Don't re-render if already selected

                currentSelectedJobId = jobId;

                // Update active class styling
                document.querySelectorAll('.job-list-item.active').forEach(item => {
                    item.classList.remove('active');
                });
                clickedItem.classList.add('active');

                // Find and render the selected job details
                const selectedJob = allJobs.find(j => (j.testId || j.jobId) === jobId);
                if (selectedJob) {
                    renderJobDetails(selectedJob);
                } else {
                    console.warn(`Job with ID ${jobId} not found in current list.`);
                    jobDetailsPane.innerHTML = '';
                    detailsPlaceholder.classList.remove('hidden');
                }
            });


            // --- Initial Fetch Jobs ---
            try {
                const response = await fetch('/api/student/jobs', { // Endpoint fetches jobs for the student's college
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    let errorMsg = 'Could not load jobs.';
                     try { const err = await response.json(); errorMsg = err.message || errorMsg; } catch (e) {}
                    throw new Error(errorMsg);
                }

                allJobs = await response.json();
                console.log("Fetched jobs data from backend:", allJobs); // Log fetched data to verify postedBy field
                loadingState.style.display = 'none'; // Hide loader

                if (allJobs.length === 0) {
                    noJobsTitle.textContent = 'No Open Positions';
                    noJobsText.textContent = 'No jobs currently match your college eligibility.';
                    noJobsState.classList.remove('hidden');
                } else {
                    noJobsState.classList.add('hidden');
                    renderJobList(allJobs);
                }

            } catch (error) {
                console.error("Error fetching jobs:", error);
                loadingState.style.display = 'none';
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message || 'An unknown error occurred while loading jobs.';
            }
        });
    </script>
</body>
</html>

