<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - TESTIFY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
            <link rel="icon" type="image/png" href="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/QuizCom_u5wzcp.png">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link:hover { background-color: #4338CA; }
        .sidebar-link.active { background-color: #4F46E5; font-weight: 600; }
        .question-block:not(:last-child) { border-bottom: 1px solid #e5e7eb; padding-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-gray-800 text-white">
            <div class="flex items-center justify-center h-20 border-b border-gray-700">
                <img class="h-10 w-10" src="https://res.cloudinary.com/dpz44zf0z/image/upload/v1760086493/QuizCom_u5wzcp.png" alt="QuizCom Logo">
                <span class="ml-3 text-2xl font-bold">QuizCom</span>
            </div>
             <nav class="flex-grow p-4 overflow-y-auto">
                <a href="quiz-dashboard.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="quiz-create.html" class="sidebar-link active flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    <span class="ml-3">Create Quiz</span>
                </a>
                <a href="quiz-library.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    <span class="ml-3">Quiz Library</span>
                </a>
                <a href="quiz-history.html" class="sidebar-link flex items-center px-4 py-3 mt-2 rounded-lg">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="ml-3">Quiz History</span>
                </a>
            </nav>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 bg-white border-b border-gray-200 px-6">
                <h1 class="text-2xl font-bold text-gray-800">Create New Quiz</h1>
                <div id="user-menu-container"></div>
            </div>

            <div class="p-6">
                <form id="create-quiz-form">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Quiz Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label for="quizTitle" class="block text-sm font-medium text-gray-700">Quiz Title</label>
                                <input type="text" id="quizTitle" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="quiz-logo" class="block text-sm font-medium text-gray-700">Quiz Logo (Optional)</label>
                                <input type="file" id="quiz-logo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-xl font-bold text-gray-800">Questions</h2>
                             <button type="button" id="add-question-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                                Add Question
                            </button>
                        </div>
                        <div id="questions-container" class="space-y-6">
                            <!-- Dynamic questions will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-end">
                        <button type="submit" class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700">
                            Save Quiz
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');

    if (!token || !user || user.role !== 'QuizCom Moderator') {
        window.location.href = 'quiz-moderator-login.html';
        return;
    }

    const userMenuContainer = document.getElementById('user-menu-container');
    userMenuContainer.innerHTML = `
        <div class="relative">
            <button id="user-menu-button" class="flex items-center space-x-2">
                <span class="font-semibold text-gray-700">${user.fullName}</span>
                <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
            <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
            </div>
        </div>`;
    
    document.getElementById('user-menu-button').addEventListener('click', () => {
        document.getElementById('user-menu').classList.toggle('hidden');
    });
    document.getElementById('logout-button').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'quiz-moderator-login.html';
    });
    
    const questionsContainer = document.getElementById('questions-container');
    let questionCounter = 0;

    document.getElementById('add-question-btn').addEventListener('click', () => addQuestion());

    function addQuestion(data = {}) {
        questionCounter++;
        const questionId = `q-${questionCounter}`;
        const questionBlock = document.createElement('div');
        questionBlock.className = 'question-block bg-white p-6 rounded-xl shadow-md';
        questionBlock.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <h4 class="text-lg font-bold text-gray-800">Question ${questionCounter}</h4>
                <button type="button" class="remove-question-btn text-2xl font-bold text-red-500 hover:text-red-700">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="${questionId}-type" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="${questionId}-type" class="question-type-select mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none" data-question-id="${questionId}">
                        <option value="single">Single Correct</option>
                        <option value="multiple">Multiple Correct</option>
                        <option value="blank">Fill in the Blanks</option>
                    </select>
                </div>
                <div>
                    <label for="${questionId}-points" class="block text-sm font-medium text-gray-700">Points</label>
                    <input type="number" id="${questionId}-points" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md" value="${data.points || '10'}">
                </div>
                 <div>
                    <label for="${questionId}-time" class="block text-sm font-medium text-gray-700">Time (sec)</label>
                    <input type="number" id="${questionId}-time" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md" value="${data.time || '30'}">
                </div>
            </div>
            <div class="mt-4">
                <label for="${questionId}-text" class="block text-sm font-medium text-gray-700">Question Text</label>
                <textarea id="${questionId}-text" rows="2" required class="mt-1 block w-full shadow-sm border-gray-300 rounded-md">${data.text || ''}</textarea>
            </div>
             <div class="mt-4">
                <label for="${questionId}-image" class="block text-sm font-medium text-gray-700">Image (Optional)</label>
                <input type="file" id="${questionId}-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>
            <div id="${questionId}-answer-area" class="mt-4"></div>
        `;
        questionsContainer.appendChild(questionBlock);
        
        const typeSelect = questionBlock.querySelector('.question-type-select');
        if(data.type) typeSelect.value = data.type;
        updateAnswerArea(questionId, typeSelect.value, data);
    }
    
    questionsContainer.addEventListener('change', (e) => {
        if (e.target.matches('.question-type-select')) {
            updateAnswerArea(e.target.dataset.questionId, e.target.value);
        }
    });
    
    questionsContainer.addEventListener('click', e => {
        if (e.target.closest('.remove-question-btn')) {
            e.target.closest('.question-block').remove();
        }
        if (e.target.closest('.add-option-btn')) {
            const button = e.target.closest('.add-option-btn');
            addOption(button.dataset.questionId, button.dataset.inputType);
        }
         if (e.target.closest('.remove-option-btn')) {
            e.target.closest('.flex').remove();
        }
    });

    function updateAnswerArea(questionId, type, data = {}) {
        const answerArea = document.getElementById(`${questionId}-answer-area`);
        if (!answerArea) return;
        
        const inputType = type === 'multiple' ? 'checkbox' : 'radio';

        if (type === 'single' || type === 'multiple') {
            answerArea.innerHTML = `
                <h5 class="text-sm font-medium text-gray-600 mb-2">Options & Correct Answer(s)</h5>
                <div id="${questionId}-options-container" class="space-y-2"></div>
                <button type="button" class="add-option-btn mt-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800" data-question-id="${questionId}" data-input-type="${inputType}">+ Add Option</button>
            `;
            const optionsToRender = (data.options && data.options.length > 0) ? data.options : ['', ''];
            optionsToRender.forEach((optText, i) => {
                let isChecked = false;
                if (type === 'single' && data.correctAnswer !== undefined) {
                    isChecked = (String(data.correctAnswer) === String(i));
                } else if (type === 'multiple' && Array.isArray(data.correctAnswers)) {
                    isChecked = data.correctAnswers.includes(String(i));
                }
                addOption(questionId, inputType, optText, isChecked);
            });
        } else { // blank
            answerArea.innerHTML = `
                <div>
                    <label for="${questionId}-answer" class="block text-sm font-medium text-gray-700">Correct Answer</label>
                    <input type="text" id="${questionId}-answer" required class="mt-1 block w-full shadow-sm border-gray-300 rounded-md" value="${data.correctAnswer || ''}">
                </div>
            `;
        }
    }

    function addOption(questionId, inputType, text = '', isChecked = false) {
        const optionsContainer = document.getElementById(`${questionId}-options-container`);
        if (!optionsContainer) return;
        const optionIndex = optionsContainer.children.length;
        const optionDiv = document.createElement('div');
        optionDiv.className = 'flex items-center space-x-3';
        optionDiv.innerHTML = `
            <input name="${questionId}-correct" type="${inputType}" value="${optionIndex}" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
            <input type="text" placeholder="Option ${optionIndex + 1}" required class="flex-grow shadow-sm border-gray-300 rounded-md" value="${text}">
            <button type="button" class="remove-option-btn text-red-500 font-bold text-lg">&times;</button>
        `;
        optionsContainer.appendChild(optionDiv);
    }
    
    document.getElementById('create-quiz-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const questions = [];
        const uploadPromises = [];
        
        // Handle Quiz Logo Upload
        const quizLogoFile = document.getElementById('quiz-logo').files[0];
        let logoUrl = null;

        if (quizLogoFile) {
            const logoFormData = new FormData();
            logoFormData.append('image', quizLogoFile);
            const logoUploadPromise = fetch('/api/upload-image', {
                method: 'POST',
                headers: { 'x-auth-token': token },
                body: logoFormData
            })
            .then(res => res.json())
            .then(data => {
                if(!data.imageUrl) throw new Error('Logo upload failed.');
                logoUrl = data.imageUrl;
            });
            uploadPromises.push(logoUploadPromise);
        }

        document.querySelectorAll('.question-block').forEach((qBlock) => {
            const select = qBlock.querySelector('.question-type-select');
            if (select) {
                const originalId = select.dataset.questionId;
                const type = select.value;
                const text = qBlock.querySelector(`#${originalId}-text`).value;
                const points = parseInt(qBlock.querySelector(`#${originalId}-points`).value, 10);
                const time = parseInt(qBlock.querySelector(`#${originalId}-time`).value, 10);
                const imageFile = qBlock.querySelector(`#${originalId}-image`).files[0];

                let questionData = { type, text, points, time, imageUrl: null };

                if (imageFile) {
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    
                    const uploadPromise = fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'x-auth-token': token },
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(!data.imageUrl) throw new Error('Image upload failed.');
                        questionData.imageUrl = data.imageUrl;
                    });
                    uploadPromises.push(uploadPromise);
                }
                
                if (type === 'single' || type === 'multiple') {
                    const textInputs = Array.from(qBlock.querySelectorAll('input[type="text"]'));
                    questionData.options = textInputs.map(i => i.value);

                    if (type === 'single') {
                        const correct = qBlock.querySelector(`input[name="${originalId}-correct"]:checked`);
                        questionData.correctAnswer = correct ? correct.value : null;
                    } else { // multiple
                        questionData.correctAnswers = Array.from(qBlock.querySelectorAll(`input[name="${originalId}-correct"]:checked`)).map(cb => cb.value);
                    }
                } else { // blank
                    questionData.correctAnswer = qBlock.querySelector('input[id$="-answer"]').value;
                }
                questions.push(questionData);
            }
        });

        try {
            await Promise.all(uploadPromises);

            const payload = {
                title: document.getElementById('quizTitle').value,
                logoUrl: logoUrl,
                questions
            };

            const response = await fetch('/api/quizcom/quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            alert('Quiz created successfully!');
            window.location.href = 'quiz-library.html';
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });
    addQuestion();
});
</script>
</body>
</html>

